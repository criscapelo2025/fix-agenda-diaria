<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIX - GESTI√ìN PRO</title>
    
    <!-- CONFIGURACI√ìN DE APLICACI√ìN (PWA) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FIX GESTI√ìN">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fix-blue': '#1e3a8a',
                        'fix-light': '#3b82f6',
                        'fix-accent': '#f59e0b',
                        'fix-report': '#059669',
                        'fix-error': '#dc2626',
                        'fix-pending': '#8b5cf6'
                    }
                }
            }
        }
    </script>

    <style>
        .currency-input { text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        @media print { .no-print { display: none !important; } }
        
        /* BLOQUEO CR√çTICO DE SEGURIDAD */
        body.technician-mode .admin-only { 
            display: none !important; 
            visibility: hidden !important; 
            opacity: 0 !important; 
            pointer-events: none !important; 
        }
        
        body.technician-mode header { margin-bottom: 0.5rem !important; padding-top: 0.5rem !important; }
        
        .admin-table thead th { position: sticky; top: 0; background: #1e293b; color: white; z-index: 10; padding: 0.75rem; text-transform: uppercase; font-size: 0.55rem; border: 1px solid #334155; }
        .rutero-table td { font-size: 10px; padding: 8px; text-transform: uppercase; font-weight: 700; }
        .detail-row { background-color: #f8fafc; border-left: 15px solid #1e3a8a; }

        .btn-refresh-float {
            position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1000;
            width: 3.5rem; height: 3.5rem; border-radius: 50%;
            background: #1e3a8a; color: white; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .btn-refresh-float:active { transform: scale(0.9) rotate(180deg); }
        .version-badge { background: #fbbf24; color: #1e3a8a; padding: 2px 10px; border-radius: 8px; font-weight: 900; font-size: 10px; margin-top: 4px; display: inline-block; }
        .modal-overlay { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .report-cell { font-size: 9px; padding: 4px !important; border: 1px solid #e2e8f0; white-space: nowrap; font-weight: 700; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .time-badge { background: #1e3a8a; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 10px; }
        
        .move-btn {
            display: flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; background: #f1f5f9; border-radius: 8px;
            transition: all 0.2s; cursor: pointer; border: 1px solid #cbd5e1;
            user-select: none;
        }
        .move-btn:hover { background: #e2e8f0; }
        .move-btn:active { background: #1e3a8a; color: white; transform: scale(0.9); }

        .photo-preview { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0; }
        .pending-card { border-left: 8px solid #8b5cf6; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCiESorKZljYeFHr19c_XPth2qWluz1Dro",
          authDomain: "fix-agenda-app.firebaseapp.com",
          projectId: "fix-agenda-app",
          storageBucket: "fix-agenda-app.firebasestorage.app",
          messagingSenderId: "98719439808",
          appId: "1:98719439808:web:66576c19c8b5233a718625",
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const LISTA_TECNICOS = ["", "Andres Cardenas", "Cristian Capelo", "Juan Carlos Pando", "Allan Skykaz", "Juana Cardenas"];
        const LUGARES_COMPRA = ["", "COMERCIAL KYWI", "COMERCIAL SOLIS", "COMO HOGAR", "SUKASA", "LUNA PAZMI√ëO", "MACAOFERTAS", "HOME VEGA", "MERCARD", "TEKA DIRECTO", "ALMACENES BOYAC√Å", "VTORIA HOGAR", "OTRO"];
        const TIPOS_SERVICIO = ["Instalaci√≥n", "Garant√≠a", "Fuera de Garant√≠a", "Mantenimiento", "Reparaci√≥n", "Visita T√©cnica"];
        
        const TIPOS_EQUIPO = ["Horno El√©ctrico", "Horno a Gas", "Cocina Inducci√≥n", "Cocina a Gas", "Microondas", "Campana Tradicional", "Campana Decorativa", "Campana Isla", "Refrigerador", "Triturador", "Grifer√≠a", "Fregadero", "Lavavajillas", "Cafetera", "PARRILLA BBQ"];
        
        const COSTOS_EQUIPO = {
            "Horno El√©ctrico": 25.00, "Horno a Gas": 29.00, "Cocina Inducci√≥n": 25.00, "Cocina a Gas": 29.00, "Microondas": 25.00, "Campana Tradicional": 15.00, "Campana Decorativa": 36.00, "Campana Isla": 45.00, "Refrigerador": 30.00, "Triturador": 15.00, "Grifer√≠a": 13.00, "Fregadero": 13.00, "Lavavajillas": 25.00, "Cafetera": 25.00, "PARRILLA BBQ": 29.00
        };

        const ACCESORIOS_DEFAULT = { 
            'Enchufe 110V': 5.00, 'Enchufe 220V 20V': 7.00, 'Enchufe 220V 50V': 10.00, 'Manguera c/bridas': 4.00, 'Ducto 4 pulgadas metro': 5.00, 'Enchufe chinito': 5.00, 'Acople': 5.00, 'Segunda visita': 12.00, 'Visita fuera de garant√≠a': 20.00 
        };

        let visitsArray = [];      
        let movementsArray = [];     
        let inventoryEntries = [];
        let currentView = 'reporte_admin';
        let currentTechUser = null; 

        function showMessage(msg, colorClass) {
            const box = document.getElementById('messageBox');
            if(!box) return;
            box.textContent = msg; 
            box.style.opacity = '1';
            box.className = "fixed bottom-10 left-1/2 -translate-x-1/2 p-4 rounded-full shadow-2xl text-white font-black uppercase text-[10px] z-[99999] transition-opacity duration-500 bg-" + colorClass;
            setTimeout(function() { if(box) box.style.opacity = '0'; }, 3000);
        }

        async function handleImageSelect(event, id) {
            const files = event.target.files;
            const container = document.getElementById("photo_previews_" + id);
            if(!container) return;
            container.innerHTML = '';
            const photoData = [];
            for (let i = 0; i < Math.min(files.length, 3); i++) {
                const file = files[i];
                const base64 = await convertToBase64(file);
                photoData.push(base64);
                const img = document.createElement('img');
                img.src = base64;
                img.className = 'photo-preview';
                container.appendChild(img);
            }
            window["photos_" + id] = photoData;
        }

        function convertToBase64(file) {
            return new Promise(function(resolve, reject) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = function() { resolve(reader.result); };
                reader.onerror = function(error) { reject(error); };
            });
        }

        window.movePriority = function(id, direction) {
            const date = document.getElementById('filterDateInputRutero').value;
            const tech = currentTechUser || document.getElementById('ruteroTechFilter').value;
            let currentDayList = visitsArray.filter(v => v.fechaInstalacion === date);
            if (tech) currentDayList = currentDayList.filter(v => v.tecnico === tech);
            currentDayList.sort((a, b) => (parseInt(a.priority) || 0) - (parseInt(b.priority) || 0));
            const currentIndex = currentDayList.findIndex(v => v.id === id);
            const targetIndex = currentIndex + direction;
            if (targetIndex >= 0 && targetIndex < currentDayList.length) {
                const temp = currentDayList[currentIndex];
                currentDayList[currentIndex] = currentDayList[targetIndex];
                currentDayList[targetIndex] = temp;
                const updates = {};
                currentDayList.forEach((v, idx) => { updates[v.id + '/priority'] = idx; });
                database.ref('visits').update(updates)
                    .then(() => showMessage("‚ÜïÔ∏è RUTA REORGANIZADA", "fix-blue"))
                    .catch(() => showMessage("‚ùå ERROR", "fix-error"));
            }
        };

        function toggleServiceTypeUI() {
            const typeSelect = document.getElementById('tipoServicioGlobal');
            if(!typeSelect) return;
            const type = typeSelect.value;
            const standardFields = document.getElementById('standardServiceFields');
            const warrantyFields = document.getElementById('warrantyFields');
            const financialDashboard = document.getElementById('financialDashboardRegistration');
            const warrantySelect = document.getElementById('warrantyEquipmentSelect');

            if (type === 'Garant√≠a') {
                if(standardFields) standardFields.classList.add('hidden');
                if(warrantyFields) warrantyFields.classList.remove('hidden');
                if(financialDashboard) financialDashboard.classList.add('opacity-30', 'pointer-events-none');
                document.querySelectorAll('#productInputsContainer select').forEach(function(s) { s.required = false; });
                if(warrantySelect) warrantySelect.required = true;
                document.getElementById('displayCostoInstalacion').textContent = "$0.00";
                document.getElementById('displayTotalAccesorios').textContent = "$0.00";
                document.getElementById('displayTotalFinal').textContent = "$0.00";
            } else {
                if(standardFields) standardFields.classList.remove('hidden');
                if(warrantyFields) warrantyFields.classList.add('hidden');
                if(financialDashboard) financialDashboard.classList.remove('opacity-30', 'pointer-events-none');
                document.querySelectorAll('#productInputsContainer select').forEach(function(s) { s.required = true; });
                if(warrantySelect) warrantySelect.required = false;
                calculateFinancials();
            }
        }

        function calculateFinancials() {
            const typeEl = document.getElementById('tipoServicioGlobal');
            if (!typeEl) return;
            const type = typeEl.value;
            if (type === 'Garant√≠a') {
                document.getElementById('displayCostoInstalacion').textContent = "$0.00";
                document.getElementById('displayTotalAccesorios').textContent = "$0.00";
                document.getElementById('displayTotalFinal').textContent = "$0.00";
                return;
            }
            let moTotalSAP = 0; let moParaTecnico = 0;
            const countInput = document.getElementById('numEquipos');
            const count = parseInt(countInput ? countInput.value : 1) || 1;
            for(let i=1; i<=count; i++) {
                const sel = document.getElementsByName("descProducto_" + i)[0];
                const pri = document.getElementsByName("costoEquipo_" + i)[0];
                if(sel && pri) {
                    const valorMO = parseFloat(pri.value) || 0;
                    moTotalSAP += valorMO;
                    if (sel.value !== "PARRILLA BBQ" && count === 1) { moParaTecnico += valorMO; }
                }
            }
            let acc = 0; 
            document.querySelectorAll('.form-acc-qty').forEach(function(i) { acc += (parseInt(i.value) || 0) * (parseFloat(i.dataset.price) || 0); });
            const manualPriceEl = document.getElementById('manualAccPrice');
            acc += (manualPriceEl ? parseFloat(manualPriceEl.value) : 0) || 0;
            if(document.getElementById('displayCostoInstalacion')) document.getElementById('displayCostoInstalacion').textContent = "$" + moTotalSAP.toFixed(2); 
            if(document.getElementById('displayTotalAccesorios')) document.getElementById('displayTotalAccesorios').textContent = "$" + acc.toFixed(2); 
            if(document.getElementById('displayTotalFinal')) document.getElementById('displayTotalFinal').textContent = "$" + (moParaTecnico + acc).toFixed(2);
        }

        function updateEquipmentPrice(selectEl, index) {
            const selectedVal = selectEl.value;
            const countInput = document.getElementById('numEquipos');
            const count = parseInt(countInput ? countInput.value : 1) || 1;
            const priceInput = document.getElementsByName("costoEquipo_" + index)[0];
            if(!priceInput) return;
            if (selectedVal === "PARRILLA BBQ") { priceInput.value = "29.00"; } 
            else {
                if (count === 1) priceInput.value = (COSTOS_EQUIPO[selectedVal] || 0.00).toFixed(2);
                else if (count === 2) priceInput.value = "20.00";
                else if (count >= 3) priceInput.value = "15.00";
            }
            calculateFinancials();
        }

        function expandEquipmentUI() {
            const countInput = document.getElementById('numEquipos');
            const count = parseInt(countInput ? countInput.value : 1) || 1;
            const container = document.getElementById('productInputsContainer'); 
            if(!container) return; 
            let unitPrice = 0;
            if (count === 2) unitPrice = 20.00; else if (count >= 3) unitPrice = 15.00;
            container.innerHTML = '';
            for(let i=1; i<=count; i++) {
                container.innerHTML += `
                <div class="p-3 bg-slate-50 rounded-xl border border-slate-200 mb-2 grid grid-cols-1 md:grid-cols-2 gap-2 shadow-sm">
                    <select name="descProducto_${i}" onchange="updateEquipmentPrice(this, ${i})" class="p-2 bg-white rounded font-bold text-xs shadow-sm outline-none uppercase" required>
                        <option value="">ELEGIR EQUIPO...</option>
                        ${TIPOS_EQUIPO.map(function(t) { return '<option value="' + t + '">' + t + '</option>'; }).join('')}
                    </select>
                    <input type="number" name="costoEquipo_${i}" step="0.01" value="${unitPrice.toFixed(2)}" oninput="calculateFinancials()" class="p-2 bg-yellow-50 rounded font-black text-right text-fix-blue outline-none font-mono">
                </div>`;
            }
            calculateFinancials();
        }

        function renderInsumosAdmin() {
            const container = document.getElementById('accesoriosContainerAdmin'); 
            if(!container) return;
            let html = Object.entries(ACCESORIOS_DEFAULT).map(function(item) { 
                const n = item[0]; const p = item[1];
                return `
                <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-slate-200">
                    <span class="text-[9px] font-black text-slate-500 uppercase">${n} ($${p.toFixed(2)})</span>
                    <input type="number" min="0" value="0" data-price="${p}" data-name="${n}" oninput="calculateFinancials()" class="form-acc-qty w-10 text-center bg-slate-50 rounded p-1 text-xs font-black outline-none shadow-inner" placeholder="0" name="acc_qty_${n.replace(/\s+/g, '_')}">
                </div>`;
            }).join('');
            html += `
                <div class="col-span-1 md:col-span-2 p-2 bg-slate-100 rounded-xl border border-slate-300 mt-2">
                    <p class="text-[9px] font-black text-fix-blue mb-1 italic">‚ûï OTRO ACCESORIO / EXTRA (GRABACI√ìN MANUAL)</p>
                    <div class="flex gap-2">
                        <input type="text" id="manualAccDesc" placeholder="DESCRIPCI√ìN DEL ACCESORIO..." class="flex-grow p-2 text-[10px] rounded border-none outline-none font-black uppercase shadow-inner">
                        <input type="number" id="manualAccPrice" placeholder="$0.00" oninput="calculateFinancials()" class="w-24 p-2 text-right text-[10px] rounded border-none outline-none font-mono font-black text-fix-report shadow-inner">
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function refreshData() {
            showMessage("üîÑ Sincronizando...", "fix-blue");
            database.ref('visits').once('value', function() {
                renderUIAgenda(); renderRutero(); processFinancialBalance(); processMaintBalance(); renderInventoryView(); renderPendientes();
                if(currentView === 'reporte_teka') renderReporteTeka();
                if(currentView === 'mantenimiento') renderReporteMantenimiento();
                showMessage("‚úÖ Actualizado", "fix-report");
            });
        }

        function syncDates(sourceId) {
            const val = document.getElementById(sourceId).value;
            const targets = ['filterDateInput', 'filterDateInputRutero', 'cajaDateStart', 'cajaDateEnd', 'maintScheduleDate', 'maintBalanceStart', 'maintBalanceEnd'];
            targets.forEach(function(id) { const el = document.getElementById(id); if(el) el.value = val; });
            renderUIAgenda(); renderRutero(); processFinancialBalance(); processMaintBalance();
        }

        function changeMasterView(view) {
            if (currentTechUser && view !== 'rutero') {
                showMessage("üîí ACCESO SOLO T√âCNICOS", "fix-error");
                return;
            }
            currentView = view;
            const sections = ['formContainer', 'contabilidadView', 'reporteTekaView', 'agendaContainer', 'ruteroView', 'mantenimientoView', 'inventoryView', 'pendientesView'];
            sections.forEach(function(id) { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });

            if(view === 'reporte_admin') { 
                const fc = document.getElementById('formContainer'); if(fc) fc.classList.remove('hidden'); 
                const ac = document.getElementById('agendaContainer'); if(ac) ac.classList.remove('hidden'); 
            }
            else if(view === 'reporte_teka') { const rtv = document.getElementById('reporteTekaView'); if(rtv) rtv.classList.remove('hidden'); renderReporteTeka(); }
            else if(view === 'mantenimiento') { const mv = document.getElementById('mantenimientoView'); if(mv) mv.classList.remove('hidden'); renderReporteMantenimiento(); processMaintBalance(); }
            else if(view === 'pendientes') { const pv = document.getElementById('pendientesView'); if(pv) pv.classList.remove('hidden'); renderPendientes(); }
            else { const el = document.getElementById(view + 'View'); if(el) el.classList.remove('hidden'); }
            
            if(view === 'rutero') renderRutero();
            if(view === 'contabilidad') processFinancialBalance();
            if(view === 'inventory') renderInventoryView();
            
            document.querySelectorAll('.view-btn').forEach(function(btn) { btn.classList.remove('bg-fix-blue', 'text-white'); btn.classList.add('bg-gray-100', 'text-gray-500'); });
            const act = document.querySelector("[onclick*=\"'" + view + "'\"]");
            if(act) { act.classList.add('bg-fix-blue', 'text-white'); act.classList.remove('bg-gray-100', 'text-gray-500'); }
        }

        function toggleDetail(id) { const det = document.getElementById("detail-" + id); if(det) det.classList.toggle('hidden'); }

        function closeVisitByTech(id) {
            try {
                const sEl = document.getElementById("status_" + id);
                const tEl = document.getElementById("type_" + id);
                const pEl = document.getElementById("payment_" + id);
                const rEl = document.getElementById("reason_" + id);
                if(!sEl || !tEl) return showMessage("‚ùå Error en formulario", "fix-error");
                
                const s = sEl.value; 
                const t = tEl.value; 
                const pay = pEl ? pEl.value : "EFECTIVO"; 
                const r = rEl ? rEl.value : "";
                const commentEl = document.getElementById("client_comment_" + id); const comment = commentEl ? commentEl.value : "";
                const photos = window["photos_" + id] || [];
                
                if(s === 'PENDIENTE') return showMessage("‚ö†Ô∏è Seleccione estado", "fix-accent");
                const v = visitsArray.find(function(item) { return item.id === id; });
                if(!v) return showMessage("‚ùå No encontrado", "fix-error");

                let moParaCaja = 0; let totalAccs = 0; const accs = [];
                document.querySelectorAll(".acc-" + id).forEach(function(i) { 
                    const q = parseInt(i.value) || 0; 
                    if(q > 0) { 
                        const p = parseFloat(i.dataset.price); 
                        accs.push({ nombre: i.dataset.name, cantidad: q, precio: p }); 
                        totalAccs += q * p; 
                    } 
                });
                
                const mDescEl = document.getElementById("manual_acc_desc_" + id); const mPriceEl = document.getElementById("manual_acc_price_" + id);
                if(mDescEl && mPriceEl && mDescEl.value && parseFloat(mPriceEl.value) > 0) { accs.push({ nombre: mDescEl.value.toUpperCase(), cantidad: 1, precio: parseFloat(mPriceEl.value) }); totalAccs += parseFloat(mPriceEl.value); }
                
                const eqCount = v.esMantenimiento ? 1 : (v.equipos || []).length;
                if (v.esMantenimiento) { const mtpEl = document.getElementById("maint_tech_price_" + id); moParaCaja = mtpEl ? (parseFloat(mtpEl.value) || 0) : (v.financiera ? v.financiera.totalCliente : 0); } 
                else { if (v.tipoAtencion !== 'Garant√≠a' && t !== 'Garant√≠a') { const hasBBQ = (v.equipos || []).some(function(eq) { return eq.descProducto === "PARRILLA BBQ"; }); if (eqCount === 1 && !hasBBQ) { moParaCaja = (v.equipos || []).reduce(function(acc, eq) { return acc + (eq.costoBase || 0); }, 0); } } }
                const totalFinal = moParaCaja + totalAccs;

                database.ref('visits/' + id).update({ 
                    estado: s, tipoAtencion: t, razonNoAtencion: r.toUpperCase(), accesoriosVendidos: accs, commentarioCliente: comment.toUpperCase(), fotosRegistro: photos, attendedDate: new Date().toISOString(), 'financiera/totalCliente': totalFinal, 'financiera/formaPago': pay 
                }).then(function() { showMessage("‚úÖ Guardado", "fix-report"); renderRutero(); renderPendientes(); }).catch(function() { showMessage("‚ùå Error", "fix-error"); });
            } catch(e) { console.error(e); showMessage("‚ùå Error Cr√≠tico", "fix-error"); }
        }

        function deleteVisit(id) { if(confirm("¬øELIMINAR ESTE REGISTRO?")) { database.ref('visits/' + id).remove().then(function() { showMessage("üóëÔ∏è Eliminado", "fix-error"); }); } }

        function renderUIAgenda() {
            const list = document.getElementById('visitsList'); if(!list) return;
            const df = document.getElementById('filterDateInput').value;
            const searchQuery = document.getElementById('searchClientInput') ? document.getElementById('searchClientInput').value.toLowerCase() : "";
            
            // --- FILTRAR SOLO "PENDIENTE" (ORIGINAL) Y "ATENDIDO" PARA LA AGENDA NORMAL ---
            let filtered = visitsArray.filter(v => v.fechaInstalacion === df && (v.estado === 'PENDIENTE' || v.estado === 'Atendido'));
            
            if(searchQuery) filtered = filtered.filter(v => v.nombreCliente.toLowerCase().includes(searchQuery));
            list.innerHTML = filtered.map(v => {
                let col = v.estado === 'Atendido' ? 'border-fix-report' : 'border-fix-accent';
                return `<div class="bg-white p-4 rounded-2xl shadow-md border-l-[10px] ${col} mb-4 uppercase"><div class="flex justify-between items-start mb-1"><p class="font-black text-fix-blue text-sm italic">${v.nombreCliente}</p><button onclick="deleteVisit('${v.id}')" class="text-fix-error text-[10px]">üóëÔ∏è</button></div><div class="text-slate-400 text-[9px] font-black uppercase">${v.esMantenimiento ? 'MANTENIMIENTO' : (v.equipos || []).map(e => '‚Ä¢ ' + e.descProducto).join('<br>')}</div></div>`;
            }).join('');
        }

        function renderRutero() {
            const list = document.getElementById('ruteroListBody'); if(!list) return;
            const date = document.getElementById('filterDateInputRutero').value;
            let tech = currentTechUser || (document.getElementById('ruteroTechFilter') ? document.getElementById('ruteroTechFilter').value : "");
            
            // --- FILTRAR SOLO "PENDIENTE" (ORIGINAL) Y "ATENDIDO" PARA LOGISTICA ---
            let filtered = visitsArray.filter(v => v.fechaInstalacion === date && (v.estado === 'PENDIENTE' || v.estado === 'Atendido'));
            
            if(tech) filtered = filtered.filter(v => v.tecnico === tech);
            if(filtered.length === 0) { list.innerHTML = '<tr><td colspan="9" class="p-10 text-center text-slate-300 italic font-black uppercase text-sm">Sin servicios hoy</td></tr>'; return; }
            let sorted = filtered.slice().sort((a,b) => (parseInt(a.priority) || 0) - (parseInt(b.priority) || 0));
            let currentMinutes = 9 * 60;
            list.innerHTML = sorted.map((v, index) => {
                const h = Math.floor(currentMinutes / 60); const m = currentMinutes % 60;
                const timeStr = (h > 12 ? h - 12 : (h === 0 ? 12 : h)) + ":" + m.toString().padStart(2, '0') + " " + (h >= 12 ? 'PM' : 'AM');
                currentMinutes += (60 + (Math.max(0, (v.equipos || []).length - 1) * 20)) + 15;
                const initials = v.tecnico ? v.tecnico.split(' ').map(n => n[0]).join('').toUpperCase() : '---';
                let statusBadge = `<span class="px-2 py-0.5 rounded-full text-[7px] font-black ${v.estado === 'Atendido' ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-600'}">${v.estado.toUpperCase()}</span>`;
                const tipoServ = v.esMantenimiento ? '‚öôÔ∏è MANT.' : (v.tipoAtencion === 'Garant√≠a' ? 'üõ°Ô∏è GARANT√çA' : 'üõ†Ô∏è SERV.TEC');
                const colorTipo = v.esMantenimiento ? 'text-fix-accent' : (v.tipoAtencion === 'Garant√≠a' ? 'text-fix-blue' : 'text-fix-report');
                return `<tr class="border-b row-hover uppercase font-black"><td class="border-r text-center px-1"><div class="flex flex-col items-center gap-1 admin-only"><div onclick="movePriority('${v.id}', -1)" class="move-btn ${index === 0 ? 'opacity-20 pointer-events-none' : ''}">‚Üë</div><span class="time-badge font-mono">${timeStr}</span><div onclick="movePriority('${v.id}', 1)" class="move-btn ${index === sorted.length - 1 ? 'opacity-20 pointer-events-none' : ''}">‚Üì</div></div><div class="technician-mode-only text-center block md:hidden"><span class="time-badge font-mono">${timeStr}</span></div></td><td class="border-r px-2 text-[9px] font-black text-fix-blue cursor-pointer truncate max-w-[120px]" onclick="toggleDetail('${v.id}')">${v.nombreCliente}</td><td class="border-r px-2 text-[8px] text-slate-500 font-normal italic lowercase truncate max-w-[120px]">${v.callePrincipal || '---'}</td><td class="border-r px-2 text-center"><div class="text-[6px] ${colorTipo} font-black uppercase tracking-tighter">${tipoServ}</div></td><td class="border-r text-center font-mono text-slate-400 text-[9px] italic">${initials}</td><td class="border-r text-center">${statusBadge}</td><td class="border-r text-center"><a href="${v.direccion?.indexOf('http') !== -1 ? v.direccion : 'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(v.direccion || v.callePrincipal)}" target="_blank" class="bg-fix-light text-white px-3 py-2 rounded-lg text-[8px] font-black shadow-md italic inline-block w-full text-center">üìç MAPA</a></td><td class="text-center"><div class="flex justify-center gap-2 items-center p-1"><a href="tel:${v.telefono}" class="text-2xl">üìû</a><a href="https://wa.me/593${v.telefono?.replace(/\D/g,'')}" target="_blank" class="text-2xl">üí¨</a></div></td>${!currentTechUser ? `<td class="text-center admin-only"><button onclick="openEditModal('${v.id}')" class="bg-fix-blue text-white px-2 py-1 rounded text-[7px] font-black uppercase">EDIT</button></td>` : ''}</tr>
                <tr id="detail-${v.id}" class="hidden detail-row uppercase font-black"><td colspan="9" class="p-4 bg-slate-50 border-y border-slate-200"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="bg-white p-4 rounded-xl shadow-sm"><p class="text-[10px] font-black text-fix-blue uppercase mb-2 italic">üìÑ Informaci√≥n</p><p class="text-xs uppercase"><b>EQUIPOS:</b> ${v.esMantenimiento ? v.mantenimientoEquipo : (v.equipos || []).map(e=>e.descProducto).join(', ')}</p>${v.descFalla ? `<p class="text-[10px] text-fix-error mt-2 font-black italic"><b>FALLA REPORTE:</b> ${v.descFalla}</p>` : ''}<div class="mt-4 p-2 bg-slate-50 rounded-lg"><p class="text-[8px] text-slate-400 font-black italic">Comentario Cliente/Novedad:</p><p class="text-[10px] font-bold text-slate-600">${v.commentarioCliente || 'Sin registro'}</p></div></div><div class="bg-white p-4 rounded-xl shadow-sm"><p class="text-[10px] font-black text-fix-report uppercase mb-2 italic">üõ†Ô∏è Cierre T√©cnico</p><div class="grid grid-cols-2 gap-2 mb-2 italic"><select id="status_${v.id}" class="p-2 bg-slate-100 rounded text-[10px] font-black uppercase"><option value="PENDIENTE">--- ESTADO CIERRE ---</option><option value="Atendido" ${v.estado === 'Atendido' ? 'selected' : ''}>‚úÖ ATENDIDO/FINALIZADO</option><option value="No Atendido" ${v.estado === 'No Atendido' ? 'selected' : ''}>‚ùå NO ATENDIDO (FALLIDO)</option><option value="Pendiente (Tramite)" ${v.estado === 'Pendiente (Tramite)' ? 'selected' : ''}>‚è≥ PENDIENTE (RECAMBIO/REPUESTO)</option></select><select id="type_${v.id}" class="p-2 bg-slate-100 rounded text-[10px] font-black uppercase">${TIPOS_SERVICIO.map(t=>`<option value="${t}" ${v.tipoAtencion === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div><div class="p-2 bg-blue-50 border border-blue-100 rounded-xl mb-2"><p class="text-[8px] font-black text-fix-blue mb-1">üì∏ FOTOS Y COMENTARIO:</p><input type="file" accept="image/*" multiple onchange="handleImageSelect(event, '${v.id}')" class="w-full text-[8px] mb-2"><textarea id="client_comment_${v.id}" placeholder="TESTIMONIO O NOVEDAD FINAL..." class="w-full p-2 text-[10px] font-black uppercase bg-white rounded border-none"></textarea></div><div class="max-h-24 overflow-y-auto mb-2 border rounded p-1 bg-slate-50">
                    ${Object.entries(ACCESORIOS_DEFAULT).map(function(item){
                        const n = item[0]; const p = item[1];
                        const existing = (v.accesoriosVendidos || []).find(a => a.nombre === n);
                        return `<div class="flex justify-between items-center mb-1 bg-white p-1 rounded font-black border border-slate-100"><span class="text-[8px] uppercase">${n} ($${p.toFixed(2)})</span><input type="number" min="0" value="${existing ? existing.cantidad : 0}" data-name="${n}" data-price="${p}" class="acc-${v.id} w-10 text-center text-[10px] border-none font-black text-fix-blue bg-slate-50 rounded shadow-inner"></div>`;
                    }).join('')}
                </div><textarea id="reason_${v.id}" placeholder="MOTIVO DEL PENDIENTE O NOTA INTERNA..." class="w-full p-2 text-xs bg-slate-50 rounded mb-2 border-none font-bold uppercase italic">${v.razonNoAtencion || ''}</textarea><button onclick="closeVisitByTech('${v.id}')" class="w-full bg-fix-report text-white py-2 rounded-xl text-[10px] font-black uppercase shadow-md">üíæ GUARDAR CIERRE</button></div></div></td></tr>`;
            }).join('');
        }

        // --- FUNCI√ìN DE RE-AGENDAMIENTO DESDE SEGUIMIENTO ---
        window.reScheduleVisit = function(id) {
            const newDate = document.getElementById('date_pend_' + id).value;
            const newNote = document.getElementById('note_pend_' + id).value;
            
            if(!newDate) {
                showMessage("‚ö†Ô∏è SELECCIONE UNA FECHA", "fix-accent");
                return;
            }

            database.ref('visits/' + id).update({
                fechaInstalacion: newDate,
                razonNoAtencion: newNote.toUpperCase(),
                estado: 'PENDIENTE', // RESETEA ESTADO PARA QUE VUELVA A LA AGENDA
                priority: 0 // Reset de prioridad para el nuevo d√≠a
            }).then(() => {
                showMessage("‚úÖ RE-AGENDADO Y ACTIVADO", "fix-report");
                renderPendientes();
                renderUIAgenda();
            }).catch(() => {
                showMessage("‚ùå ERROR AL ACTUALIZAR", "fix-error");
            });
        };

        function renderPendientes() {
            const container = document.getElementById('pendientesList'); if(!container) return;
            const techFilter = document.getElementById('pendingTechFilter').value;
            const typeFilter = document.getElementById('pendingTypeFilter').value;
            
            // --- FILTRAR SOLO LO QUE NO ESTA EN AGENDA ACTIVA ---
            let filtered = visitsArray.filter(v => v.estado !== 'Atendido' && v.estado !== 'PENDIENTE');
            
            if(techFilter) filtered = filtered.filter(v => v.tecnico === techFilter);
            if(typeFilter !== 'TODOS') filtered = filtered.filter(v => v.estado === typeFilter);

            if(filtered.length === 0) { container.innerHTML = '<p class="p-10 text-center text-slate-300 font-black uppercase italic">No hay casos pendientes en seguimiento</p>'; return; }
            
            container.innerHTML = filtered.map(v => {
                const color = v.estado.includes('Pendiente') ? 'border-fix-pending' : 'border-fix-accent';
                return `<div class="bg-white p-5 rounded-[2rem] shadow-lg border-l-[12px] ${color} mb-4">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex flex-col">
                            <h3 class="text-sm font-black text-slate-800 italic underline uppercase">${v.nombreCliente}</h3>
                            <span class="text-[9px] font-bold text-slate-400">ESTADO ACTUAL: ${v.estado.toUpperCase()} ‚Ä¢ T√âCNICO: ${v.tecnico}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openEditModal('${v.id}')" class="bg-slate-100 text-slate-400 px-3 py-1 rounded-full text-[8px] font-black italic">MODIFICAR DATOS</button>
                            <button onclick="deleteVisit('${v.id}')" class="text-fix-error text-sm">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <p class="text-[8px] font-black text-slate-400 uppercase italic">Historial de Novedad:</p>
                            <p class="text-[10px] font-black text-red-600 bg-red-50 p-2 rounded-xl italic uppercase border border-red-100">${v.razonNoAtencion || 'SIN REGISTRO PREVIO'}</p>
                        </div>
                        
                        <div class="bg-slate-50 p-4 rounded-3xl border border-slate-200">
                            <p class="text-[8px] font-black text-fix-blue mb-2 uppercase italic underline">Panel de Re-agendamiento y Seguimiento:</p>
                            <textarea id="note_pend_${v.id}" placeholder="ESCRIBA UNA NUEVA NOVEDAD O TR√ÅMITE..." class="w-full p-2 text-[10px] font-black uppercase border-none rounded-xl mb-2 shadow-inner">${v.razonNoAtencion || ''}</textarea>
                            <div class="flex gap-2 items-center">
                                <input type="date" id="date_pend_${v.id}" class="flex-grow p-2 rounded-xl text-[10px] font-mono font-black border-none shadow-inner bg-white">
                                <button onclick="reScheduleVisit('${v.id}')" class="bg-fix-report text-white px-4 py-2 rounded-xl text-[10px] font-black shadow-lg active:scale-95 transition-all italic uppercase">üöÄ ACTIVAR Y AGENDAR</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex gap-4 border-t pt-2 border-dashed">
                        <a href="tel:${v.telefono}" class="text-[9px] font-black text-slate-500 hover:text-fix-blue tracking-tighter italic">üìû LLAMAR: ${v.telefono}</a>
                        <a href="https://wa.me/593${v.telefono?.replace(/\D/g,'')}" target="_blank" class="text-[9px] font-black text-green-600 tracking-tighter italic">üí¨ WHATSAPP</a>
                    </div>
                </div>`;
            }).join('');
        }

        function renderReporteMantenimiento() {
            const body = document.getElementById('mantenimientoReporteBody'); if(!body) return;
            const start = document.getElementById('maintBalanceStart')?.value;
            const end = document.getElementById('maintBalanceEnd')?.value;
            let filtered = visitsArray.filter(v => v.esMantenimiento);
            if(start && end) filtered = filtered.filter(v => v.fechaInstalacion >= start && v.fechaInstalacion <= end);
            body.innerHTML = filtered.map(v => `<tr class="border-b row-hover font-black uppercase"><td class="report-cell font-mono font-black">${v.fechaInstalacion}</td><td class="report-cell font-black text-fix-blue">${v.nombreCliente}</td><td class="report-cell font-mono">${v.telefono || '-'}</td><td class="report-cell uppercase text-[7px] max-w-[100px] truncate">${v.callePrincipal || '-'}</td><td class="report-cell uppercase text-[7px] font-bold text-fix-accent">${v.mantenimientoEquipo || 'General'}</td><td class="report-cell font-black text-right text-fix-report">$${(v.financiera ? v.financiera.totalCliente : 0).toFixed(2)}</td><td class="report-cell text-center font-black">${v.estado === 'Atendido' ? '‚úÖ' : '‚è≥'}</td><td class="report-cell text-center font-black"><button onclick="deleteVisit('${v.id}')" class="text-fix-error">üóëÔ∏è</button></td></tr>`).join('');
        }

        function processMaintBalance() {
            const start = document.getElementById('maintBalanceStart')?.value;
            const end = document.getElementById('maintBalanceEnd')?.value;
            let filtered = visitsArray.filter(v => v.esMantenimiento && v.estado === 'Atendido' && v.financiera);
            if(start && end) filtered = filtered.filter(v => v.fechaInstalacion >= start && v.fechaInstalacion <= end);
            let cash = 0, trans = 0;
            filtered.forEach(v => {
                const monto = v.financiera.totalCliente || 0;
                if(v.financiera.formaPago === 'TRANSFERENCIA') trans += monto; else cash += monto;
            });
            if(document.getElementById('maintTotalCash')) document.getElementById('maintTotalCash').textContent = "$" + cash.toFixed(2);
            if(document.getElementById('maintTotalTrans')) document.getElementById('maintTotalTrans').textContent = "$" + trans.toFixed(2);
            if(document.getElementById('maintTotalGeneral')) document.getElementById('maintTotalGeneral').textContent = "$" + (cash + trans).toFixed(2);
        }

        function downloadCSV() {
            const start = document.getElementById('maestroDateStart').value || "HISTORICO";
            let csv = "NRO,FECHA DE EMISION,LUGAR DE COMPRA,FACTURA,CODIGO,DESCRIPCION,SERIE,SAP,TECNICO,CIUDAD,FECHA ATENCION,CLIENTE,CALLE,TELEFONO,PRECIO,LLEGADA INFO,TECNICO QUE ATENDIO,VIATICO,FACTURA REP,CEDULA,CORREO\n";
            document.querySelectorAll('#tekaReporteBody tr').forEach(row => { const cols = row.querySelectorAll('td'); if(cols.length >= 21) { let rowData = []; for(let i=0; i<21; i++) { rowData.push('"' + cols[i].innerText.replace(/"/g, '""') + '"'); } csv += rowData.join(",") + "\n"; } });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.setAttribute("download", "REPORTE_FIX_" + start + ".csv"); link.click();
        }

        function downloadMantenimientoCSV() {
            let csv = "FECHA,CLIENTE,TEL√âFONO,CALLE,EQUIPO,VALOR,ESTADO\n";
            document.querySelectorAll('#mantenimientoReporteBody tr').forEach(row => { const cols = row.querySelectorAll('td'); if(cols.length >= 7) { csv += Array.from(cols).slice(0,7).map(c => '"' + c.innerText + '"').join(",") + "\n"; } });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.setAttribute("download", "MANTENIMIENTOS.csv"); link.click();
        }

        function downloadCajaCSV() {
            let csv = "FECHA,TIPO,DETALLE,MONTO\n";
            document.querySelectorAll('#contabilidadTableBody tr').forEach(row => { const cols = row.querySelectorAll('td'); if(cols.length >= 4) { csv += Array.from(cols).slice(0,4).map(c => '"' + c.innerText + '"').join(",") + "\n"; } });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.setAttribute("download", "CAJA_FIX.csv"); link.click();
        }

        function downloadInventoryCSV() {
            let csv = "INSUMO,ENTRADAS,UTILIZADO,STOCK,PVP\n";
            document.querySelectorAll('#inventoryTableBody tr').forEach(row => { const cols = row.querySelectorAll('td'); if(cols.length >= 5) { csv += Array.from(cols).map(c => '"' + c.innerText + '"').join(",") + "\n"; } });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.setAttribute("download", "STOCK_FIX.csv"); link.click();
        }

        function renderReporteTeka() {
            const body = document.getElementById('tekaReporteBody'); if(!body) return;
            const start = document.getElementById('maestroDateStart').value; const end = document.getElementById('maestroDateEnd').value;
            let filtered = visitsArray.filter(v => !v.esMantenimiento && v.estado === 'Atendido');
            if(start && end) filtered = filtered.filter(v => v.fechaInstalacion >= start && v.fechaInstalacion <= end);
            let rowCount = 1;
            body.innerHTML = filtered.flatMap(v => (v.equipos || []).map(eq => `<tr class="border-b row-hover font-black uppercase"><td class="report-cell text-center font-mono bg-slate-50">${rowCount++}</td><td class="report-cell font-mono">${v.fechaEmision || ''}</td><td class="report-cell">${v.lugarCompra || 'OTRO'}</td><td class="report-cell font-mono">${v.numFactura || '-'}</td><td class="report-cell font-mono">${eq.codProducto || '-'}</td><td class="report-cell italic text-slate-400"></td><td class="report-cell font-mono tracking-widest">${eq.serieEquipo || '-'}</td><td class="report-cell font-black">SAP</td><td class="report-cell">CAPELO</td><td class="report-cell">CUENCA</td><td class="report-cell font-mono">${v.fechaInstalacion}</td><td class="report-cell font-black italic">${v.nombreCliente}</td><td class="report-cell max-w-[150px] truncate">${v.callePrincipal || '-'}</td><td class="report-cell font-mono">${v.telefono || '-'}</td><td class="report-cell font-black text-right font-mono">$${(eq.costoBase || 0).toFixed(2)}</td><td class="report-cell">CLIENTE FINAL</td><td class="report-cell">CAPELO</td><td class="report-cell italic text-slate-400"></td><td class="report-cell font-mono">${v.numFactura || '-'}</td><td class="report-cell font-mono">${v.cedula || '-'}</td><td class="report-cell lowercase">${v.email || '-'}</td><td class="report-cell text-center"><button onclick="deleteVisit('${v.id}')" class="text-fix-error">üóëÔ∏è</button></td></tr>`)).join('');
        }

        function renderInventoryView() {
            const container = document.getElementById('inventoryTableBody'); if(!container) return;
            const selectAcc = document.getElementById('invAccSelect');
            if(selectAcc && selectAcc.options.length === 0) { Object.keys(ACCESORIOS_DEFAULT).forEach(n => selectAcc.add(new Option(n, n))); }
            container.innerHTML = Object.entries(ACCESORIOS_DEFAULT).map(item => {
                const name = item[0]; const price = item[1];
                const totalIn = inventoryEntries.filter(e => e.accesorio === name).reduce((sum, e) => sum + e.cantidad, 0);
                let totalOut = 0;
                visitsArray.filter(v => v.estado === 'Atendido' && v.accesoriosVendidos).forEach(v => { const sold = v.accesoriosVendidos.find(a => a.nombre === name); if(sold) totalOut += sold.cantidad; });
                const stock = totalIn - totalOut;
                return `<tr class="border-b row-hover font-black uppercase"><td class="p-4 text-xs font-black text-fix-blue tracking-tighter">${name}</td><td class="p-4 text-center text-[10px] font-mono font-bold text-slate-400">${totalIn}</td><td class="p-4 text-center text-[10px] font-mono font-bold text-fix-error">${totalOut}</td><td class="p-4 text-center"><span class="px-3 py-1 rounded-full text-xs font-mono font-black ${stock <= 5 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${stock}</span></td><td class="p-4 text-right text-[10px] font-mono text-slate-400 italic">$${price.toFixed(2)}</td></tr>`;
            }).join('');
        }

        // --- FUNCI√ìN DE DESGLOSE FINANCIERO ---
        window.showDesgloseVisita = function(id) {
            const v = visitsArray.find(item => item.id === id);
            if (!v) return;
            const container = document.getElementById('desgloseContent');
            const modal = document.getElementById('desgloseModal');
            let html = `<div class="space-y-3">`;
            let totalGeneral = 0;
            if (v.tipoAtencion !== 'Garant√≠a') {
                const hasBBQ = (v.equipos || []).some(eq => eq.descProducto === "PARRILLA BBQ");
                const eqCount = (v.equipos || []).length;
                if (eqCount === 1 && !hasBBQ) {
                    const mo = (v.equipos || []).reduce((sum, eq) => sum + (eq.costoBase || 0), 0);
                    if(mo > 0) {
                        html += `<div class="flex justify-between items-center bg-slate-50 p-3 rounded-xl border border-slate-100"><span class="text-xs font-black text-slate-500 uppercase tracking-tighter">üõ†Ô∏è MANO DE OBRA</span><span class="font-mono font-black text-fix-blue text-sm">$${mo.toFixed(2)}</span></div>`;
                        totalGeneral += mo;
                    }
                }
            }
            if (v.accesoriosVendidos && v.accesoriosVendidos.length > 0) {
                v.accesoriosVendidos.forEach(a => {
                    const itemTotal = a.cantidad * a.precio;
                    html += `<div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm"><div class="flex flex-col"><span class="text-[10px] font-black text-slate-800 uppercase tracking-tighter">${a.nombre}</span><span class="text-[8px] font-bold text-slate-400">CANT: ${a.cantidad} x $${a.precio.toFixed(2)}</span></div><span class="font-mono font-black text-fix-report text-sm">$${itemTotal.toFixed(2)}</span></div>`;
                    totalGeneral += itemTotal;
                });
            }
            html += `<div class="pt-4 border-t-2 border-dashed border-slate-200 flex justify-between items-end"><span class="text-[10px] font-black text-slate-400 uppercase italic">Total Liquidado:</span><span class="text-2xl font-mono font-black text-slate-900 tracking-tighter">$${totalGeneral.toFixed(2)}</span></div></div>`;
            document.getElementById('desgloseTitle').textContent = v.nombreCliente;
            container.innerHTML = html;
            modal.classList.remove('hidden');
        };

        window.closeDesgloseModal = function() { document.getElementById('desgloseModal').classList.add('hidden'); };

        function processFinancialBalance() {
            const startInput = document.getElementById('cajaDateStart');
            const endInput = document.getElementById('cajaDateEnd');
            const start = startInput ? startInput.value : ""; 
            const end = endInput ? endInput.value : "";
            const techFilter = document.getElementById('cajaTechFilter') ? document.getElementById('cajaTechFilter').value : "";
            let todos = [];
            visitsArray.filter(v => v.estado === 'Atendido' && v.financiera && !v.esMantenimiento).forEach(v => {
                let monto = (v.tipoAtencion === 'Garant√≠a') ? 0 : (v.equipos?.length === 1 && !v.equipos.some(e=>e.descProducto==="PARRILLA BBQ") ? (v.financiera.totalCliente || 0) : (v.accesoriosVendidos || []).reduce((s,a)=>s+(a.cantidad*a.precio), 0));
                todos.push({ id: v.id, monto, type: 'INGRESO', concepto: "VISITA: " + v.nombreCliente, fecha: v.attendedDate ? new Date(v.attendedDate).getTime() : v.createdAt, dateStr: v.fechaInstalacion, source: 'VISITA', tecnico: v.tecnico || '---', formaPago: v.financiera.formaPago || 'EFECTIVO' });
            });
            movementsArray.forEach(m => todos.push({ id: m.id, monto: m.monto, type: m.type, concepto: "MANUAL: " + m.concepto, fecha: m.fecha, dateStr: new Date(m.fecha).toISOString().split('T')[0], source: 'MANUAL', tecnico: m.tecnico || '---', formaPago: m.formaPago || 'EFECTIVO' }));
            if(start && end) todos = todos.filter(m => m.dateStr >= start && m.dateStr <= end);
            if(techFilter) todos = todos.filter(m => m.tecnico === techFilter);
            todos.sort((a,b) => b.fecha - a.fecha);
            const tb = document.getElementById('contabilidadTableBody');
            if(tb) tb.innerHTML = todos.map(m => {
                const isVisit = m.source === 'VISITA';
                return `<tr class="border-b row-hover uppercase font-black"><td class="p-4 text-[9px] font-mono font-black italic">${new Date(m.fecha).toLocaleDateString()}<br><span class="text-[7px] text-slate-400 font-bold">${m.tecnico}</span></td><td class="p-4 text-[9px] font-bold tracking-tight"><span class="${m.type === 'INGRESO' ? 'text-green-600' : 'text-red-600'}">${m.type}</span><br><span class="text-[7px] ${m.formaPago === 'TRANSFERENCIA' ? 'text-blue-500' : 'text-slate-400'}">${m.formaPago}</span></td><td class="p-4 text-xs font-black uppercase tracking-tighter">${m.concepto}</td><td class="p-4 text-right text-[10px] font-mono font-black">$${(m.monto || 0).toFixed(2)}</td><td class="text-center p-4"><div class="flex gap-2 justify-center">${isVisit ? `<button onclick="showDesgloseVisita('${m.id}')" class="text-green-600 text-xs font-black" title="Ver Desglose">üëÅÔ∏è</button>` : ''}<button onclick="openEditFinanceModal('${m.id}', '${m.source}', ${m.monto}, '${m.concepto}')" class="text-fix-blue text-xs font-black">‚úèÔ∏è</button>${m.source === 'MANUAL' ? `<button onclick="database.ref('movements').child('${m.id}').remove()" class="text-fix-error text-xs">üóëÔ∏è</button>` : ''}</div></td></tr>`;
            }).join('');
            let tIn = 0, tOut = 0, tCashIn = 0, tTransIn = 0;
            todos.forEach(m => { if(m.type === 'INGRESO') { tIn += m.monto; if(m.formaPago === 'EFECTIVO') tCashIn += m.monto; else tTransIn += m.monto; } else { tOut += m.monto; } });
            if(document.getElementById('totalEfectivoDisplay')) document.getElementById('totalEfectivoDisplay').textContent = "$" + tCashIn.toFixed(2);
            if(document.getElementById('totalEgresosDisplay')) document.getElementById('totalEgresosDisplay').textContent = "$" + tOut.toFixed(2);
            if(document.getElementById('balanceNetoDisplay')) document.getElementById('balanceNetoDisplay').textContent = "$" + (tCashIn - tOut).toFixed(2);
            if(document.getElementById('totalTransferDisplay')) document.getElementById('totalTransferDisplay').textContent = "$" + tTransIn.toFixed(2);
            if(document.getElementById('totalIngresosDisplay')) document.getElementById('totalIngresosDisplay').textContent = "$" + tIn.toFixed(2);
        }

        // --- FUNCION PARA RECONSTRUCCI√ìN DE ACCESORIOS EN EDICION ---
        function rebuildEditAccessoriesInputs(vendidos) {
            const container = document.getElementById('editAccesoriosContainer');
            if(!container) return;
            container.innerHTML = Object.entries(ACCESORIOS_DEFAULT).map(function(item){
                const n = item[0]; const p = item[1];
                const v = (vendidos || []).find(function(a){return a.nombre === n;}) || { cantidad: 0 };
                return `<div class="flex justify-between items-center p-2 border-b"><span class="text-[8px] font-black">${n} ($${p.toFixed(2)})</span><input type="number" min="0" value="${v.cantidad}" data-name="${n}" data-price="${p}" class="edit-acc-qty w-10 text-center font-black text-xs border rounded"></div>`;
            }).join('');
        }

        window.openEditModal = function(id) {
            try {
                const v = visitsArray.find(item => item.id === id); if(!v) return;
                document.getElementById('edit_id').value = v.id;
                document.getElementById('edit_nombre').value = v.nombreCliente || "";
                document.getElementById('edit_telefono').value = v.telefono || "";
                document.getElementById('edit_email').value = v.email || "";
                document.getElementById('edit_cedula').value = v.cedula || "";
                document.getElementById('edit_fecha').value = v.fechaInstalacion || "";
                document.getElementById('edit_direccion').value = v.direccion || "";
                document.getElementById('edit_priority').value = v.priority || 0;
                document.getElementById('edit_tecnico').value = v.tecnico || "";
                document.getElementById('edit_numFactura').value = v.numFactura || "";
                document.getElementById('edit_lugarCompra').value = v.lugarCompra || "";
                document.getElementById('edit_numEquipos').value = v.equipos ? v.equipos.length : 1;
                
                rebuildEditEquipmentInputs(v.equipos || []);
                rebuildEditAccessoriesInputs(v.accesoriosVendidos || []);
                document.getElementById('editModal').classList.remove('hidden');
            } catch(e) { console.error(e); showMessage("‚ùå Error al abrir editor", "fix-error"); }
        };

        function rebuildEditEquipmentInputs(equipos) {
            const countInput = document.getElementById('edit_numEquipos');
            const count = parseInt(countInput ? countInput.value : 1) || 1;
            const container = document.getElementById('editEquiposContainer');
            if(!container) return;
            let unitPrice = 0; if (count === 2) unitPrice = 20.00; else if (count >= 3) unitPrice = 15.00;
            container.innerHTML = '';
            for(let i=0; i<count; i++) {
                const eq = equipos[i] || { descProducto: "", costoBase: unitPrice, codProducto: "", serieEquipo: "" };
                container.innerHTML += `<div class="p-3 border rounded-xl bg-slate-50 mb-3 shadow-sm"><p class="text-[9px] font-black mb-2 text-fix-blue">EQUIPO ${i+1}</p><div class="grid grid-cols-1 gap-2"><select class="edit-eq-select w-full p-2 text-[10px] font-black uppercase rounded border" onchange="updateEditPrice(this, ${i})"><option value="">-- ELEGIR PRODUCTO --</option>${TIPOS_EQUIPO.map(t=>`<option value="${t}" ${eq.descProducto === t ? 'selected' : ''}>${t}</option>`).join('')}</select><div class="grid grid-cols-2 gap-2"><div><label class="text-[7px] text-slate-400">C√ìDIGO SAP</label><input type="text" class="edit-eq-code w-full p-2 text-[10px] font-black rounded border" value="${eq.codProducto || ''}"></div><div><label class="text-[7px] text-slate-400">N√öMERO SERIE</label><input type="text" class="edit-eq-serie w-full p-2 text-[10px] font-black rounded border" value="${eq.serieEquipo || ''}"></div></div><div><label class="text-[7px] text-slate-400">VALOR MO $</label><input type="number" step="0.01" value="${(eq.costoBase || 0).toFixed(2)}" class="edit-eq-cost w-full p-2 text-[10px] font-mono font-black rounded border"></div></div></div>`;
            }
        }

        window.updateEditPrice = function(selectEl, index) {
             const costInputs = document.querySelectorAll('.edit-eq-cost');
             const selectedVal = selectEl.value;
             if(!costInputs[index]) return;
             if (selectedVal === "PARRILLA BBQ") costInputs[index].value = "29.00";
             else costInputs[index].value = (COSTOS_EQUIPO[selectedVal] || 0.00).toFixed(2);
        }

        window.saveEditChanges = function() {
            const id = document.getElementById('edit_id').value;
            const selects = document.querySelectorAll('.edit-eq-select');
            const codes = document.querySelectorAll('.edit-eq-code');
            const series = document.querySelectorAll('.edit-eq-serie');
            const selectsCosts = document.querySelectorAll('.edit-eq-cost');
            let updatedEquipos = []; 
            for(let i=0; i<selects.length; i++) {
                updatedEquipos.push({ descProducto: selects[i].value.toUpperCase(), costoBase: parseFloat(selectsCosts[i].value) || 0, codProducto: codes[i].value.toUpperCase(), serieEquipo: series[i].value.toUpperCase() });
            }
            let updatedAccs = [];
            document.querySelectorAll('.edit-acc-qty').forEach(function(i) { const q = parseInt(i.value) || 0; if(q > 0) { updatedAccs.push({ nombre: i.dataset.name, cantidad: q, precio: parseFloat(i.dataset.price) || 0 }); } });
            database.ref('visits/' + id).update({
                nombreCliente: document.getElementById('edit_nombre').value.toUpperCase(), telefono: document.getElementById('edit_telefono').value, email: document.getElementById('edit_email').value.toLowerCase(), cedula: document.getElementById('edit_cedula').value, fechaInstalacion: document.getElementById('edit_fecha').value, direccion: document.getElementById('edit_direccion').value, tecnico: document.getElementById('edit_tecnico').value, numFactura: document.getElementById('edit_numFactura').value.toUpperCase(), lugarCompra: document.getElementById('edit_lugarCompra').value, priority: parseInt(document.getElementById('edit_priority').value) || 0, equipos: updatedEquipos, accesoriosVendidos: updatedAccs
            }).then(() => { showMessage("‚úÖ Actualizado", "fix-report"); closeEditModal(); }).catch(e => { showMessage("‚ùå Error", "fix-error"); });
        };

        window.saveVisit = function() {
            try {
                const form = document.getElementById('visitForm');
                const data = Object.fromEntries(new FormData(form));
                if(!data.nombreCliente || !data.callePrincipal) { showMessage("‚ö†Ô∏è Datos obligatorios", "fix-error"); return; }
                let eqs = [];
                if (data.tipoServicioGlobal === 'Garant√≠a') eqs.push({ descProducto: document.getElementById('warrantyEquipmentSelect').value.toUpperCase(), costoBase: 0, codProducto: "", serieEquipo: "" });
                else { const num = parseInt(data.numEquipos) || 1; for(let i=1; i<=num; i++) { const eqName = data["descProducto_" + i]; if(eqName) eqs.push({ descProducto: eqName.toUpperCase(), costoBase: parseFloat(data["costoEquipo_" + i]) || 0, codProducto: "", serieEquipo: "" }); } }
                let accs = [];
                document.querySelectorAll('.form-acc-qty').forEach(function(i) { const q = parseInt(i.value) || 0; if(q > 0) accs.push({ nombre: i.dataset.name, cantidad: q, precio: parseFloat(i.dataset.price) || 0 }); });
                const totalFinal = parseFloat(document.getElementById('displayTotalFinal').textContent.replace(/[^\d.]/g, '')) || 0;
                const ref = database.ref('visits').push();
                ref.set({ id: ref.key, nombreCliente: data.nombreCliente.toUpperCase(), telefono: data.telefono || '', callePrincipal: data.callePrincipal.toUpperCase(), numFactura: data.numFactura || '', fechaInstalacion: document.getElementById('filterDateInput').value, tecnico: data.tecnico || '', tipoAtencion: data.tipoServicioGlobal, estado: 'PENDIENTE', createdAt: Date.now(), equipos: eqs, accesoriosVendidos: accs, financiera: { totalCliente: totalFinal }, priority: 0 }).then(() => { showMessage("üöÄ Agendado", "fix-report"); form.reset(); expandEquipmentUI(); renderInsumosAdmin(); });
            } catch (err) { showMessage("‚ùå Error Cr√≠tico", "fix-error"); }
        };

        function startSync() {
            database.ref('visits').on('value', snap => {
                visitsArray = snap.val() ? Object.entries(snap.val()).map(item => Object.assign({}, item[1], {id: item[0]})) : [];
                renderUIAgenda(); renderRutero(); renderInventoryView(); renderPendientes();
                if(currentView === 'reporte_teka') renderReporteTeka(); if(currentView === 'mantenimiento') renderReporteMantenimiento(); if(currentView === 'contabilidad') processFinancialBalance();
            });
            database.ref('movements').on('value', snap => { movementsArray = snap.val() ? Object.entries(snap.val()).map(item => Object.assign({}, item[1], {id: item[0]})) : []; if(currentView === 'contabilidad') processFinancialBalance(); });
            database.ref('inventory_entries').on('value', snap => { inventoryEntries = snap.val() ? Object.values(snap.val()) : []; renderInventoryView(); });
        }

        window.saveMantenimiento = function() {
            try {
                const form = document.getElementById('maintForm'); const data = Object.fromEntries(new FormData(form));
                if(!data.mNombre || !data.mCalle) { showMessage("‚ö†Ô∏è Datos obligatorios", "fix-error"); return; }
                const ref = database.ref('visits').push();
                ref.set({ id: ref.key, nombreCliente: data.mNombre.toUpperCase(), telefono: data.mTelefono || '', callePrincipal: data.mCalle.toUpperCase(), mantenimientoEquipo: data.mEquipo.toUpperCase(), tecnico: data.mTecnico || '', tipoAtencion: "Mantenimiento", estado: 'PENDIENTE', createdAt: Date.now(), fechaInstalacion: document.getElementById('maintScheduleDate').value, esMantenimiento: true, financiera: { totalCliente: parseFloat(data.mPrecio) || 0, formaPago: data.mPago || 'EFECTIVO' }, priority: 999 }).then(() => { showMessage("‚úÖ Mantenimiento Guardado", "fix-report"); form.reset(); });
            } catch (err) { showMessage("‚ùå Error", "fix-error"); }
        };

        window.saveInventoryEntry = function() {
            const acc = document.getElementById('invAccSelect').value;
            const qty = parseInt(document.getElementById('invQty').value) || 0;
            if (qty <= 0) return showMessage("‚ö†Ô∏è Ingrese cantidad", "fix-accent");
            const ref = database.ref('inventory_entries').push();
            ref.set({ accesorio: acc, cantidad: qty, fecha: Date.now() }).then(() => { document.getElementById('invQty').value = ''; showMessage("‚úÖ Ingreso Registrado", "fix-report"); });
        };

        window.openEditFinanceModal = function(id, source, currentMonto, concepto) {
            document.getElementById('finance_id').value = id; 
            document.getElementById('finance_source').value = source; 
            document.getElementById('finance_monto').value = currentMonto; 
            document.getElementById('finance_concepto').value = concepto; 
            document.getElementById('editFinanceModal').classList.remove('hidden');
        };

        window.saveFinanceAdjustment = function() {
            const id = document.getElementById('finance_id').value; 
            const source = document.getElementById('finance_source').value; 
            const nuevoMonto = parseFloat(document.getElementById('finance_monto').value) || 0; 
            const nuevoConcepto = document.getElementById('finance_concepto').value.toUpperCase();
            if (source === 'MANUAL') database.ref('movements/' + id).update({ monto: nuevoMonto, concepto: nuevoConcepto.replace('MANUAL: ', '') }).then(() => closeEditFinanceModal());
            else database.ref('visits/' + id).update({ 'financiera/totalCliente': nuevoMonto }).then(() => closeEditFinanceModal());
        };

        window.saveManualMovement = function() {
            const c = document.getElementById('movConcepto').value; 
            const m = parseFloat(document.getElementById('movMonto').value); 
            const t = document.getElementById('movType').value; 
            const p = document.getElementById('movPago').value; 
            const tech = document.getElementById('movTecnico').value;
            if(!c || isNaN(m)) return showMessage("‚ö†Ô∏è Incompleto", "fix-accent");
            const ref = database.ref('movements').push();
            ref.set({ id: ref.key, concepto: c.toUpperCase(), monto: m, fecha: Date.now(), type: t, formaPago: p, tecnico: tech || 'ADMIN' }).then(() => { document.getElementById('movConcepto').value=''; document.getElementById('movMonto').value=''; showMessage("‚úÖ Manual Guardado", "fix-report"); });
        };

        function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
        window.closeEditFinanceModal = function() { document.getElementById('editFinanceModal').classList.add('hidden'); };

        document.addEventListener('DOMContentLoaded', function() {
            const hoy = new Date().toISOString().split('T')[0];
            ['filterDateInput', 'filterDateInputRutero', 'maestroDateStart', 'maestroDateEnd', 'cajaDateStart', 'cajaDateEnd', 'maintScheduleDate', 'maintBalanceStart', 'maintBalanceEnd'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = hoy; });
            const p = new URLSearchParams(window.location.search); 
            const t = p.get('tech');
            if(t && LISTA_TECNICOS.indexOf(t) !== -1) { currentTechUser = t; document.body.classList.add('technician-mode'); document.getElementById('userDisplayLabel').textContent = "RUTA: " + t.toUpperCase(); document.getElementById('adminNav').classList.add('hidden'); changeMasterView('rutero'); } 
            startSync();
            LISTA_TECNICOS.forEach(item => { ['selectTecnico', 'ruteroTechFilter', 'selectTecnicoMaint', 'edit_tecnico', 'movTecnico', 'cajaTechFilter', 'pendingTechFilter'].forEach(id => { const el = document.getElementById(id); if(el) el.add(new Option(item || (id === 'cajaTechFilter' ? "TODOS LOS T√âCNICOS" : "--- T√âCNICO ---"), item)); }); });
            const elLugar = document.getElementById('selectLugar');
            const elLugarEdit = document.getElementById('edit_lugarCompra');
            LUGARES_COMPRA.forEach(i => { if(elLugar) elLugar.add(new Option(i || "--- LUGAR COMPRA ---", i)); if(elLugarEdit) elLugarEdit.add(new Option(i || "--- LUGAR COMPRA ---", i)); });
            renderInsumosAdmin(); expandEquipmentUI();
        });
    </script>
</head>

<body class="bg-slate-100 min-h-screen p-2 md:p-8 font-sans selection:bg-fix-blue text-slate-800 font-black uppercase">

    <div class="max-w-[2800px] mx-auto pb-24">
        
        <header class="mb-4 sm:mb-10 flex flex-col xl:flex-row justify-between items-center gap-2 no-print">
            <div class="flex items-center">
                <div class="bg-fix-blue p-3 sm:p-6 rounded-2xl shadow-lg mr-3"><span class="text-2xl sm:text-5xl font-black text-white italic tracking-tighter uppercase">FIX</span></div>
                <div><h1 class="text-xl sm:text-4xl font-black uppercase italic text-slate-800 tracking-tighter leading-none">Gesti√≥n</h1><div class="flex flex-col"><span id="userDisplayLabel" class="text-[10px] sm:text-xs font-black text-slate-400 uppercase tracking-widest italic font-mono">Admin</span><span class="version-badge">V. 2.7.1</span></div></div>
            </div>
            <!-- MENU ADMIN -->
            <nav id="adminNav" class="flex flex-wrap justify-center bg-white p-1 sm:p-2 rounded-full shadow-md border-2 border-slate-50 gap-1 admin-only">
                <button onclick="changeMasterView('reporte_admin')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-fix-blue text-white italic">Registro</button>
                <button onclick="changeMasterView('mantenimiento')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Mantenimiento</button>
                <button onclick="changeMasterView('pendientes')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Seguimiento</button>
                <button onclick="changeMasterView('inventory')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Inventario</button>
                <button onclick="changeMasterView('rutero')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Log√≠stica</button>
                <button onclick="changeMasterView('reporte_teka')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Maestro</button>
                <button onclick="changeMasterView('contabilidad')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Caja</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-8">
            
            <!-- REGISTRO (ADMIN ONLY) -->
            <div id="formContainer" class="lg:col-span-2 space-y-4 admin-only no-print">
                <div class="bg-white p-4 rounded-3xl shadow-lg"><input type="date" id="filterDateInput" onchange="syncDates('filterDateInput')" class="bg-slate-50 p-3 rounded-xl text-xl font-black italic text-fix-blue outline-none border-none shadow-inner w-full text-center font-mono"></div>
                <div class="bg-white p-6 rounded-[2rem] shadow-xl border-[8px] border-slate-50">
                    <form id="visitForm" onsubmit="event.preventDefault(); saveVisit();">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <input type="text" name="nombreCliente" placeholder="CLIENTE*" required class="p-3 bg-slate-50 rounded-xl font-bold uppercase shadow-inner text-xs font-black"><input type="text" name="callePrincipal" placeholder="CALLE*" required class="p-3 bg-yellow-50 rounded-xl font-bold uppercase shadow-inner text-xs font-black"><input type="text" name="cedula" placeholder="C√âDULA" class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner text-center font-mono"><input type="tel" name="telefono" placeholder="TEL√âFONO*" required class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner text-center font-mono font-black"><input type="email" name="email" placeholder="CORREO" class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner"><input type="text" name="numFactura" placeholder="N¬∞ FACTURA COMPRA" class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner text-center uppercase font-black"><input type="text" name="direccion" placeholder="LINK GPS (OPCIONAL EN REGISTRO)" class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner md:col-span-2"><select name="tecnico" id="selectTecnico" class="p-3 bg-slate-50 rounded-xl font-bold text-[10px] uppercase italic font-black"></select><select id="selectLugar" name="lugarCompra" class="p-3 bg-slate-50 rounded-xl font-bold text-[10px] uppercase italic font-black"></select><div class="flex flex-col"><span class="text-[8px] font-black text-slate-400 ml-2 italic">EMISI√ìN FACTURA</span><input type="date" name="fechaEmision" id="inputEmision" class="p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none shadow-inner text-center font-mono"></div><select name="tipoServicioGlobal" id="tipoServicioGlobal" onchange="toggleServiceTypeUI()" class="p-3 bg-white border-2 border-fix-blue/10 rounded-xl font-black text-[10px] uppercase text-fix-blue italic"><option value="Instalaci√≥n">Instalaci√≥n Est√°ndar</option><option value="Garant√≠a">Garant√≠a de F√°brica</option><option value="Fuera de Garant√≠a">Fuera de Garant√≠a</option><option value="Reparaci√≥n">Reparaci√≥n/Serv.Tecnico</option><option value="Visita T√©cnica">Visita T√©cnica</option></select>
                        </div>
                        <div id="standardServiceFields" class="space-y-4"><div class="bg-slate-50 p-3 rounded-xl flex items-center justify-between shadow-inner"><span class="text-[10px] font-black italic">CANTIDAD EQUIPOS:</span><input type="number" id="numEquipos" name="numEquipos" value="1" min="1" oninput="expandEquipmentUI()" class="w-10 text-center text-xl text-fix-blue bg-transparent outline-none font-black font-mono"></div><div id="productInputsContainer" class="space-y-2"></div><div id="accesoriosContainerAdmin" class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-4 italic font-black"></div></div>
                        <div id="warrantyFields" class="hidden space-y-4 p-4 bg-fix-blue/5 rounded-3xl border-2 border-fix-blue/10 italic"><p class="text-[10px] font-black text-fix-blue underline uppercase">DATOS DE GARANT√çA (SIN COSTO)</p><select id="warrantyEquipmentSelect" class="w-full p-3 bg-white rounded-xl font-black text-xs uppercase shadow-sm outline-none"></select><textarea id="warrantyDamageDesc" placeholder="DESCRIBA LA FALLA O MOTIVO DE LA GARANT√çA..." class="w-full p-4 bg-white rounded-2xl font-black text-xs uppercase shadow-inner min-h-[100px] outline-none border-none"></textarea></div>
                        <div id="financialDashboardRegistration" class="mt-8 grid grid-cols-3 gap-2 text-center"><div class="bg-slate-50 p-2 rounded-xl italic text-[8px]">M.O. (MAESTRO)<br><span id="displayCostoInstalacion" class="text-sm font-black">$0.00</span></div><div class="bg-slate-50 p-2 rounded-xl italic text-[8px]">INSUMOS<br><span id="displayTotalAccesorios" class="text-sm font-black">$0.00</span></div><div class="bg-fix-accent p-2 rounded-xl font-black text-white shadow-lg uppercase">TOTAL CAJA<br><span id="displayTotalFinal" class="text-lg font-mono">$0.00</span></div></div>
                        <button type="submit" class="w-full bg-fix-blue text-white py-4 rounded-2xl mt-4 text-lg font-black uppercase italic shadow-lg active:scale-95 transition-all">üöÄ AGENDAR VISITA</button>
                    </form>
                </div>
            </div>

            <!-- AGENDA (ADMIN ONLY) -->
            <div id="agendaContainer" class="lg:col-span-1 admin-only uppercase font-black">
                <h2 class="text-xl font-black uppercase italic mb-4 border-b-4 border-fix-blue text-slate-800 text-center font-sans italic">Agenda Local</h2>
                <div class="mb-4 relative font-black">
                    <input type="text" id="searchClientInput" oninput="renderUIAgenda()" placeholder="üîç BUSCAR CLIENTE..." class="w-full p-4 bg-white rounded-2xl shadow-md border-2 border-slate-100 font-black text-xs uppercase italic outline-none focus:border-fix-blue transition-all">
                </div>
                <div id="visitsList" class="space-y-3 max-h-[700px] overflow-y-auto pr-2"></div>
            </div>

            <!-- SEGUIMIENTO (ADMIN ONLY) -->
            <div id="pendientesView" class="hidden lg:col-span-3 space-y-6 admin-only">
                <div class="bg-white p-6 rounded-[2rem] shadow-xl border-[8px] border-fix-pending/10">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <h2 class="text-xl font-black uppercase italic font-sans italic underline text-fix-pending tracking-tighter">Seguimiento de Pendientes</h2>
                        <div class="flex flex-wrap gap-2 w-full md:w-auto">
                            <select id="pendingTypeFilter" onchange="renderPendientes()" class="p-2 bg-slate-50 border rounded text-[10px] font-black uppercase">
                                <option value="TODOS">TODOS LOS CASOS</option>
                                <option value="Pendiente (Tramite)">SOLO PENDIENTES</option>
                                <option value="No Atendido">SOLO NO ATENDIDOS</option>
                            </select>
                            <select id="pendingTechFilter" onchange="renderPendientes()" class="p-2 bg-slate-50 border rounded text-[10px] font-black uppercase"></select>
                        </div>
                    </div>
                    <div id="pendientesList" class="space-y-4 max-h-[800px] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- MANTENIMIENTOS (ADMIN ONLY) -->
            <div id="mantenimientoView" class="hidden lg:col-span-3 space-y-6 admin-only">
                <div class="bg-white p-4 rounded-3xl shadow-lg border-[4px] border-fix-accent/20">
                    <p class="text-[8px] font-black text-fix-accent mb-1 ml-2 italic underline">üìÖ AGENDAR FECHA PARA MANTENIMIENTO:</p>
                    <input type="date" id="maintScheduleDate" class="bg-slate-50 p-3 rounded-xl text-xl font-black italic text-fix-accent outline-none border-none shadow-inner w-full text-center font-mono">
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
                    <div class="xl:col-span-2 bg-white p-6 rounded-[2rem] shadow-xl border-[8px] border-slate-50 font-black italic">
                        <h2 class="text-xl font-black uppercase mb-6 border-b-4 border-fix-blue pb-2 font-sans italic">MANTENIMIENTOS FIX - REGISTRO</h2>
                        <form id="maintForm" onsubmit="event.preventDefault(); saveMantenimiento();">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 uppercase font-black">
                                <input type="text" name="mNombre" placeholder="CLIENTE*" required class="p-4 bg-slate-50 rounded-xl font-black shadow-inner uppercase text-sm"><input type="tel" name="mTelefono" placeholder="TEL√âFONO*" required class="p-4 bg-slate-50 rounded-xl font-black shadow-inner font-mono text-sm"><input type="text" name="mCalle" placeholder="CALLE*" required class="p-4 bg-yellow-50 rounded-xl font-bold uppercase shadow-inner text-sm"><input type="text" name="mDireccion" placeholder="LINK GPS (OPCIONAL)" class="p-4 bg-slate-50 rounded-xl font-black shadow-inner text-sm"><input type="text" name="mEquipo" placeholder="EQUIPO*" required class="p-4 bg-slate-50 rounded-xl font-black shadow-inner text-sm"><select name="mTecnico" id="selectTecnicoMaint" class="p-4 bg-slate-50 rounded-xl font-black shadow-inner uppercase italic text-sm"></select><input type="number" name="mPrecio" placeholder="VALOR ESTIMADO $ (OPCIONAL)" step="0.01" class="p-4 bg-blue-50 border border-fix-blue/20 rounded-xl font-black text-fix-blue font-mono text-sm"><select name="mPago" class="p-4 bg-slate-50 rounded-xl font-black shadow-inner italic text-sm"><option value="EFECTIVO">EFECTIVO</option><option value="TRANSFERENCIA">TRANSFERENCIA</option></select>
                            </div>
                            <button type="submit" class="w-full bg-fix-blue text-white py-4 rounded-2xl mt-6 text-lg font-black uppercase italic shadow-lg">üöÄ AGENDAR MANTENIMIENTO</button>
                        </form>
                    </div>
                    <div class="bg-slate-900 p-6 rounded-[2rem] shadow-2xl text-white font-black flex flex-col justify-between italic">
                        <div><div class="flex justify-between items-center mb-4 border-b border-white/20 pb-2"><h2 class="text-sm uppercase tracking-tighter text-fix-accent underline">COBROS MANTENIMIENTO</h2></div><div class="space-y-4"><div class="bg-white/5 p-3 rounded-xl border border-white/10"><span class="text-[9px] text-slate-400 block mb-1">INGRESOS EFECTIVO:</span><span id="maintTotalCash" class="text-2xl font-mono text-green-400">$0.00</span></div><div class="bg-white/5 p-3 rounded-xl border border-white/10"><span class="text-[9px] text-slate-400 block mb-1">INGRESOS TRANSFERENCIA:</span><span id="maintTotalTrans" class="text-2xl font-mono text-blue-400">$0.00</span></div></div></div><div class="mt-6 pt-4 border-t-2 border-dashed border-white/20"><span class="text-[10px] text-fix-accent block mb-1 uppercase tracking-widest">TOTAL EMPRESA MANT.</span><span id="maintTotalGeneral" class="text-4xl font-mono tracking-tighter text-white">$0.00</span></div>
                    </div>
                </div>
            </div>

            <!-- INVENTARIO (ADMIN ONLY) -->
            <div id="inventoryView" class="hidden lg:col-span-3 space-y-6 admin-only">
                <div class="bg-white p-6 rounded-[2rem] shadow-xl border-[8px] border-slate-50 font-black italic uppercase"><h2 class="text-xl font-black uppercase mb-6 border-b-4 border-fix-report pb-2 font-sans italic text-fix-report">CONTROL DE INVENTARIO Y STOCK</h2><div class="bg-slate-50 p-6 rounded-2xl mb-8 flex flex-wrap gap-4 items-end border border-slate-200"><div class="flex-grow"><label class="text-[8px] ml-2">ACCESORIO / INSUMO</label><select id="invAccSelect" class="w-full p-3 bg-white rounded-xl border font-black text-xs uppercase"></select></div><div class="w-32"><label class="text-[8px] ml-2">CANTIDAD ENTRADA</label><input type="number" id="invQty" placeholder="0" class="w-full p-3 bg-white rounded-xl border text-center font-black font-mono"></div><button onclick="saveInventoryEntry()" class="bg-fix-report text-white px-8 py-3 rounded-xl font-black text-xs shadow-lg active:scale-95 transition-all italic">üíæ REGISTRAR INGRESO</button></div><div class="overflow-x-auto border-2 border-slate-50 rounded-xl"><table class="w-full border-collapse admin-table"><thead><tr class="bg-slate-900 text-white text-[8px] uppercase"><th class="text-left">Nombre del Insumo</th><th>Total Entradas</th><th>Utilizado</th><th>Stock Disponible</th><th class="text-right">PVP Estimado</th></tr></thead><tbody id="inventoryTableBody" class="font-bold"></tbody></table></div></div>
            </div>

            <!-- LOG√çSTICA (PARA TODOS) -->
            <div id="ruteroView" class="hidden lg:col-span-3 bg-white p-4 rounded-[2rem] shadow-xl">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 px-2 gap-2"><h2 class="text-sm font-black uppercase italic font-sans">Log√≠stica Diaria</h2><div class="flex gap-2 w-full md:w-auto"><select id="ruteroTechFilter" onchange="renderRutero()" class="admin-only flex-grow p-1.5 bg-slate-100 rounded-lg text-[9px] font-black outline-none border-none italic uppercase"></select><input type="date" id="filterDateInputRutero" onchange="syncDates('filterDateInputRutero')" class="p-1.5 rounded-lg text-xs font-black italic text-fix-blue outline-none shadow-sm border font-mono"></div></div><div class="overflow-x-auto w-full border-2 border-slate-50 rounded-2xl shadow-inner font-black uppercase"><table class="w-full border-collapse rutero-table"><thead><tr class="bg-slate-900 text-white text-[7px] uppercase"><th class="w-12">Hora</th><th class="text-left w-32">Cliente</th><th class="text-left w-40">Calle Principal</th><th class="w-20">Servicio</th><th class="w-10">T√©c</th><th class="w-16">Estado</th><th class="w-24">Mapa</th><th class="w-32">Contacto</th><th class="w-10 admin-only">Adm</th></tr></thead><tbody id="ruteroListBody" class="uppercase italic font-black"></tbody></table></div>
            </div>

            <!-- MAESTRO (ADMIN ONLY) -->
            <div id="reporteTekaView" class="hidden lg:col-span-3 bg-white p-6 rounded-[2rem] shadow-xl font-black uppercase admin-only"><div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-6"><div><h2 class="text-lg font-black uppercase italic font-sans italic underline text-fix-blue">Maestro SAP</h2><div class="flex gap-2 mt-2 font-black"><input type="date" id="maestroDateStart" class="bg-slate-50 p-1 rounded text-[10px] outline-none border font-black"><input type="date" id="maestroDateEnd" class="bg-slate-50 p-1 rounded text-[10px] outline-none border font-black"><button onclick="renderReporteTeka()" class="bg-fix-blue text-white px-2 rounded text-[10px]">VER</button></div></div><button onclick="downloadCSV()" class="bg-fix-report text-white px-4 py-2 rounded-full font-black text-[9px] uppercase shadow-md italic">üìä DESCARGAR SAP FINAL</button></div><div class="overflow-x-auto border-2 border-slate-50 rounded-xl"><table class="w-full border-collapse admin-table"><thead><tr class="bg-slate-900 text-white text-[7px] uppercase"><th class="bg-slate-800">NRO</th><th>FECHA DE EMISI√ìN</th><th>LUGAR DE COMPRA</th><th>FACTURA</th><th>C√ìDIGO</th><th>DESCRIPCI√ìN</th><th>SERIE</th><th>SAP</th><th>T√âCNICO</th><th>CIUDAD</th><th>FECHA ATENCI√ìN</th><th>CLIENTE</th><th>CALLE</th><th>TEL√âFONO</th><th>PRECIO</th><th>LLEGADA INFO</th><th>T√âCNICO ATENDI√ì</th><th>VI√ÅTICO</th><th>FACTURA REP</th><th>C√âDULA</th><th>CORREO</th><th>X</th></tr></thead><tbody id="tekaReporteBody" class="uppercase font-bold"></tbody></table></div></div>

            <!-- CAJA (ADMIN ONLY) -->
            <div id="contabilidadView" class="hidden lg:col-span-3 space-y-6 admin-only"><div class="bg-white p-6 rounded-[2rem] shadow-xl font-black uppercase"><div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-6"><div><h2 class="text-lg font-black uppercase underline font-sans italic">CONTABILIDAD Y CAJA</h2><div class="flex flex-wrap gap-2 mt-2 font-black"><input type="date" id="cajaDateStart" class="bg-slate-50 p-1 rounded text-[10px] border font-black"><input type="date" id="cajaDateEnd" class="bg-slate-50 p-1 rounded text-[10px] border font-black"><select id="cajaTechFilter" onchange="processFinancialBalance()" class="bg-slate-50 p-1 rounded text-[10px] border font-black"></select><button onclick="downloadCajaCSV()" class="bg-fix-report text-white px-4 py-2 rounded-full font-black text-[9px] uppercase shadow-md italic ml-4">üìä EXPORTAR CAJA</button></div></div></div><div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-6 text-center italic font-black"><div class="p-3 bg-green-50 rounded-xl border border-green-100 flex flex-col justify-center"><span class="text-[8px] uppercase text-slate-500">INGRESOS (EFECTIVO)</span><div id="totalEfectivoDisplay" class="text-lg font-black text-green-700">$0.00</div></div><div class="p-3 bg-red-50 rounded-xl border border-red-100 flex flex-col justify-center"><span class="text-[8px] uppercase text-slate-500">EGRESOS / GASTOS</span><div id="totalEgresosDisplay" class="text-lg font-black text-red-700">$0.00</div></div><div class="p-3 bg-slate-900 rounded-xl text-white shadow-xl col-span-2 md:col-span-1 flex flex-col justify-center border-2 border-fix-accent"><span class="text-[8px] uppercase text-fix-accent">SALDO NETO (CASH)</span><div id="balanceNetoDisplay" class="text-xl font-black text-fix-accent">$0.00</div></div><div class="p-3 bg-blue-50 rounded-xl border border-blue-100 flex flex-col justify-center opacity-80"><span class="text-[8px] uppercase text-slate-500">BANCO (TRANSFER.)</span><div id="totalTransferDisplay" class="text-lg font-black text-blue-700">$0.00</div></div><div class="p-3 bg-slate-50 rounded-xl border border-slate-200 flex flex-col justify-center opacity-60"><span class="text-[8px] uppercase text-slate-500">VENTA TOTAL PERIODO</span><div id="totalIngresosDisplay" class="text-lg font-black text-slate-600">$0.00</div></div></div><div class="overflow-x-auto rounded-xl border border-slate-100"><table class="w-full text-left admin-table font-mono"><thead><tr class="text-[9px] uppercase"><th>FECHA/T√âCNICO</th><th>TIPO/PAGO</th><th>DETALLE</th><th class="text-right">MONTO</th><th class="text-center">X</th></tr></thead><tbody id="contabilidadTableBody"></tbody></table></div></div>
        </div>
    </div>

    <!-- MODAL DE DESGLOSE -->
    <div id="desgloseModal" class="hidden fixed inset-0 z-[30000] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 border-[6px] border-slate-50 uppercase italic font-black">
            <div class="flex justify-between items-start mb-6 border-b-2 pb-2">
                <div>
                    <h2 class="text-lg text-fix-blue leading-tight underline">Liquidaci√≥n Detallada</h2>
                    <p id="desgloseTitle" class="text-[10px] text-slate-400 mt-1 uppercase"></p>
                </div>
                <button onclick="closeDesgloseModal()" class="text-slate-300 hover:text-fix-error text-xl">‚úï</button>
            </div>
            <div id="desgloseContent" class="space-y-4 mb-8 max-h-[50vh] overflow-y-auto pr-2">
            </div>
            <button onclick="closeDesgloseModal()" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black shadow-lg active:scale-95 transition-all text-sm uppercase italic">Entendido</button>
        </div>
    </div>

    <!-- MODAL DE EDICI√ìN ADMINISTRATIVA -->
    <div id="editModal" class="hidden fixed inset-0 z-[20000] modal-overlay flex items-center justify-center p-4 font-black admin-only">
        <div class="bg-white w-full max-w-3xl rounded-[2rem] shadow-2xl p-8 font-black italic border-[6px] border-slate-50 uppercase overflow-y-auto max-h-[95vh]">
            <div class="flex justify-between items-start mb-6 border-b-2 pb-2">
                <h2 class="text-xl font-black uppercase text-fix-blue italic tracking-tighter">Corregir Datos del Cliente</h2>
                <button onclick="closeEditModal()" class="text-slate-300 hover:text-fix-error text-2xl">‚úï</button>
            </div>
            <input type="hidden" id="edit_id">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6 bg-slate-50 p-4 rounded-2xl border border-slate-100">
                <div class="md:col-span-3 text-[10px] text-fix-blue font-black mb-1 italic underline">Informaci√≥n de contacto</div>
                <div><label class="text-[7px] text-slate-400 ml-2">NOMBRE CLIENTE</label><input type="text" id="edit_nombre" class="w-full p-2 bg-white rounded-lg border font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">TEL√âFONO</label><input type="text" id="edit_telefono" class="w-full p-2 bg-white rounded-lg border font-mono font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">C√âDULA</label><input type="text" id="edit_cedula" class="w-full p-2 bg-white rounded-lg border font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">CORREO</label><input type="email" id="edit_email" class="w-full p-2 bg-white rounded-lg border font-black text-xs"></div>
                <div class="md:col-span-3 text-[10px] text-fix-blue font-black mt-2 mb-1 italic underline">Log√≠stica y Venta</div>
                <div><label class="text-[7px] text-slate-400 ml-2">N¬∞ FACTURA COMPRA</label><input type="text" id="edit_numFactura" class="w-full p-2 bg-white rounded-lg border font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">LUGAR COMPRA</label><select id="edit_lugarCompra" class="w-full p-2 bg-white rounded-lg border font-black text-[10px] uppercase"></select></div>
                <div><label class="text-[7px] text-slate-400 ml-2">FECHA ATENCI√ìN</label><input type="date" id="edit_fecha" class="w-full p-2 bg-white rounded-lg border font-black text-xs font-mono"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">T√âCNICO</label><select id="edit_tecnico" class="w-full p-2 bg-white rounded-lg border font-black text-[10px]"></select></div>
                <div><label class="text-[7px] text-slate-400 ml-2">PRIORIDAD (RUTA)</label><input type="number" id="edit_priority" class="w-full p-2 bg-yellow-50 rounded-lg border font-black text-xs font-mono"></div>
                <div class="md:col-span-3"><label class="text-[7px] text-slate-400 ml-2">LINK GPS / DIRECCI√ìN</label><input type="text" id="edit_direccion" class="w-full p-2 bg-white rounded-lg border font-black text-xs"></div>
            </div>
            <div class="p-4 bg-blue-50/50 border border-blue-100 rounded-3xl mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-xs font-black text-fix-blue uppercase underline italic">Equipos registrados</h3>
                    <div class="flex items-center gap-2 bg-white px-2 py-1 rounded-full shadow-sm border"><label class="text-[8px] font-black">CANTIDAD:</label><input type="number" id="edit_numEquipos" min="1" oninput="rebuildEditEquipmentInputs([])" class="w-8 text-center bg-transparent font-black text-xs outline-none"></div>
                </div>
                <div id="editEquiposContainer" class="space-y-3"></div>
            </div>
            <div class="p-4 bg-slate-100 rounded-2xl mb-6">
                <h3 class="text-[10px] font-black text-fix-report mb-2 uppercase italic underline">Insumos y accesorios</h3>
                <div id="editAccesoriosContainer" class="grid grid-cols-1 md:grid-cols-2 gap-x-4"></div>
            </div>
            <div class="grid grid-cols-2 gap-4 sticky bottom-0 bg-white pt-4 border-t-2 border-dashed">
                <button onclick="saveEditChanges()" class="bg-fix-report text-white py-4 rounded-2xl font-black shadow-xl active:scale-95 transition-all text-lg tracking-tighter uppercase italic">üíæ Guardar Cambios</button>
                <button onclick="closeEditModal()" class="bg-slate-200 text-slate-600 py-4 rounded-2xl font-black uppercase italic">Descartar</button>
            </div>
        </div>
    </div>

    <!-- MODAL AJUSTE FINANCIERO (ADMIN ONLY) -->
    <div id="editFinanceModal" class="hidden fixed inset-0 z-[20000] modal-overlay flex items-center justify-center p-4 admin-only"><div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl p-8 font-black border-[6px] border-slate-50 uppercase italic"><h2 class="text-xl font-black uppercase text-fix-blue mb-4 border-b-2 pb-2">VALOR REAL</h2><input type="hidden" id="finance_id"><input type="hidden" id="finance_source"><div class="space-y-4"><input type="text" id="finance_concepto" class="w-full p-3 bg-slate-50 rounded-xl border font-black text-xs"><input type="number" step="0.01" id="finance_monto" class="w-full p-3 bg-yellow-50 rounded-xl border font-mono font-black text-xl text-right"></div><div class="grid grid-cols-2 gap-3 mt-6"><button onclick="saveFinanceAdjustment()" class="bg-fix-report text-white py-3 rounded-xl font-black shadow-lg">üíæ AJUSTAR</button><button onclick="closeEditFinanceModal()" class="bg-slate-200 text-slate-600 py-3 rounded-xl font-black">SALIR</button></div></div></div>

    <button onclick="refreshData()" class="btn-refresh-float no-print" title="Actualizar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg></button>
    <div id="messageBox" class="opacity-0 fixed transition-opacity duration-500 pointer-events-none z-[99999] font-black uppercase text-center"></div>

</body>
</html>
