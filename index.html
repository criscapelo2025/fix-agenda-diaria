<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIX - SISTEMA INTEGRAL 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fix-blue': '#1e3a8a',
                        'fix-accent': '#f59e0b',
                        'fix-report': '#059669',
                        'fix-error': '#dc2626',
                        'fix-ai': '#8b5cf6'
                    },
                    boxShadow: {
                        'premium': '0 25px 60px -15px rgba(0, 0, 0, 0.2)',
                        'ai-glow': '0 0 40px rgba(139, 92, 246, 0.4)'
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        @media print { .no-print { display: none !important; } }
        
        /* Modo T√©cnico: Oculta la administraci√≥n */
        body.technician-mode .admin-only { display: none !important; }
        body.technician-mode .main-layout { grid-template-columns: 1fr !important; }
        
        .row-hover:hover { background-color: #f8fafc; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
</head>

<body class="bg-slate-50 min-h-screen p-4 md:p-10">

    <div class="max-w-[1600px] mx-auto">
        
        <!-- HEADER -->
        <header class="mb-10 flex flex-col lg:flex-row justify-between items-center gap-6 no-print">
            <div class="flex items-center gap-6">
                <div class="bg-fix-blue p-6 rounded-3xl shadow-lg">
                    <span class="text-4xl font-black text-white italic">FIX</span>
                </div>
                <div>
                    <h1 class="text-4xl font-black uppercase italic tracking-tighter text-slate-800">Panel de Control</h1>
                    <span id="userDisplayLabel" class="text-sm font-bold text-slate-400 uppercase tracking-widest">Cargando Sistema...</span>
                </div>
            </div>

            <nav class="flex bg-white p-2 rounded-full shadow-md border-4 border-slate-100 gap-2 admin-only">
                <button onclick="changeMasterView('agenda')" id="nav-agenda" class="nav-btn py-3 px-8 rounded-full font-black text-xs uppercase bg-fix-blue text-white italic">Agenda</button>
                <button onclick="changeMasterView('reportes')" id="nav-reportes" class="nav-btn py-3 px-8 rounded-full font-black text-xs uppercase bg-slate-100 text-slate-500 italic">Reporte Teka</button>
                <button onclick="changeMasterView('almacen')" id="nav-almacen" class="nav-btn py-3 px-8 rounded-full font-black text-xs uppercase bg-slate-100 text-slate-500 italic">Almac√©n</button>
                <button onclick="changeMasterView('caja')" id="nav-caja" class="nav-btn py-3 px-8 rounded-full font-black text-xs uppercase bg-slate-100 text-slate-500 italic">Caja / Gastos</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 main-layout">
            
            <!-- COLUMNA IZQUIERDA: FORMULARIO (ADMIN ONLY) -->
            <aside id="formSection" class="lg:col-span-5 space-y-8 admin-only no-print">
                <div class="bg-white p-8 rounded-[3rem] shadow-premium border-8 border-white">
                    <form id="mainForm" onsubmit="event.preventDefault(); saveVisit();">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-black italic uppercase text-fix-blue">Nueva Visita</h2>
                            <div class="flex items-center gap-2 bg-slate-100 px-4 py-2 rounded-2xl">
                                <span class="text-[10px] font-black text-slate-400">EQUIPOS:</span>
                                <input type="number" id="numEquipos" name="numEquipos" value="1" min="1" oninput="renderEquipmentFields()" class="w-12 text-center font-black text-fix-blue bg-transparent outline-none">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <input type="text" name="nombreCliente" placeholder="CLIENTE*" required class="p-4 bg-slate-50 rounded-2xl font-bold text-sm uppercase outline-none focus:ring-2 ring-fix-blue">
                            <input type="tel" name="telefono" placeholder="TEL√âFONO" class="p-4 bg-slate-50 rounded-2xl font-bold text-sm outline-none focus:ring-2 ring-fix-blue">
                            <input type="text" name="direccion" placeholder="DIRECCI√ìN*" required class="md:col-span-2 p-4 bg-slate-50 rounded-2xl font-bold text-sm uppercase outline-none focus:ring-2 ring-fix-blue">
                            
                            <select name="tecnico" id="selectTecnico" class="p-4 bg-slate-50 rounded-2xl font-bold text-sm outline-none"></select>
                            <input type="date" name="fechaInstalacion" id="inputFecha" required class="p-4 bg-slate-50 rounded-2xl font-bold text-sm outline-none">
                        </div>

                        <div id="equipmentFields" class="space-y-4 mb-8"></div>

                        <div class="bg-slate-50 p-6 rounded-[2rem] mb-8">
                            <div class="flex justify-between items-center text-slate-400 font-black text-[10px] uppercase mb-4">
                                <span>Insumos Extra</span>
                                <span>Precio Fijo</span>
                            </div>
                            <div id="accFormList" class="space-y-2"></div>
                        </div>

                        <div class="bg-fix-blue p-8 rounded-[2rem] text-center mb-6">
                            <span class="block text-white/60 font-black text-[10px] uppercase italic">Total a Cobrar</span>
                            <span id="displayTotal" class="text-5xl font-black text-white italic">$0.00</span>
                        </div>

                        <button type="submit" class="w-full bg-fix-accent text-white py-6 rounded-full text-xl font-black italic uppercase shadow-xl hover:scale-105 transition-all">
                            üöÄ Agendar Visita
                        </button>
                    </form>
                </div>
            </aside>

            <!-- COLUMNA DERECHA: AGENDA / VISTAS -->
            <main id="contentSection" class="lg:col-span-7">
                
                <!-- AGENDA VIEW -->
                <div id="view-agenda" class="space-y-6">
                    <div class="flex justify-between items-center mb-4 no-print">
                        <h2 class="text-4xl font-black italic uppercase text-slate-800 tracking-tighter underline decoration-fix-blue decoration-8">Ruta Diaria</h2>
                        <input type="date" id="agendaDateFilter" onchange="renderAgenda()" class="p-3 bg-white rounded-2xl font-black shadow-sm outline-none border-4 border-slate-100">
                    </div>
                    <div id="agendaList" class="space-y-6"></div>
                </div>

                <!-- REPORTE TEKA VIEW -->
                <div id="view-reportes" class="hidden space-y-6">
                    <h2 class="text-4xl font-black italic uppercase text-slate-800 tracking-tighter">Reporte Maestro Teka</h2>
                    <div class="bg-white rounded-3xl shadow-xl overflow-hidden border-8 border-white">
                        <table class="w-full text-left">
                            <thead class="bg-slate-900 text-white text-[10px] uppercase font-black italic">
                                <tr>
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">C√≥digo</th>
                                    <th class="p-4">Descripci√≥n</th>
                                    <th class="p-4">Serie</th>
                                    <th class="p-4">Cliente</th>
                                    <th class="p-4 text-right">Costo</th>
                                </tr>
                            </thead>
                            <tbody id="tekaTableBody" class="text-xs font-bold uppercase italic"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ALMAC√âN VIEW -->
                <div id="view-almacen" class="hidden space-y-6">
                    <h2 class="text-4xl font-black italic uppercase text-slate-800 tracking-tighter">Inventario Insumos</h2>
                    <div class="bg-white p-6 rounded-3xl shadow-md flex gap-4 no-print">
                        <select id="invAccSelect" class="flex-grow p-4 bg-slate-50 rounded-2xl font-bold"></select>
                        <input type="number" id="invQty" placeholder="Cant" class="w-24 p-4 bg-slate-50 rounded-2xl text-center font-bold">
                        <input type="number" id="invCost" placeholder="Costo Total" class="w-32 p-4 bg-slate-50 rounded-2xl text-right font-bold">
                        <button onclick="addInventory()" class="bg-fix-report text-white px-8 rounded-2xl font-black">+</button>
                    </div>
                    <div id="inventoryStats" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>

                <!-- CAJA VIEW -->
                <div id="view-caja" class="hidden space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-green-500 p-6 rounded-3xl text-center shadow-lg">
                            <span class="block text-white/70 font-black text-xs uppercase">Ingresos</span>
                            <span id="cajaIngresos" class="text-4xl font-black text-white italic">$0.00</span>
                        </div>
                        <div class="bg-fix-error p-6 rounded-3xl text-center shadow-lg">
                            <span class="block text-white/70 font-black text-xs uppercase">Egresos</span>
                            <span id="cajaEgresos" class="text-4xl font-black text-white italic">$0.00</span>
                        </div>
                        <div class="bg-slate-900 p-6 rounded-3xl text-center shadow-lg">
                            <span class="block text-white/40 font-black text-xs uppercase">Neto</span>
                            <span id="cajaNeto" class="text-4xl font-black text-white italic">$0.00</span>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl shadow-xl overflow-x-auto border-8 border-white">
                        <table class="w-full text-left">
                            <thead class="border-b-2 border-slate-100 text-[10px] uppercase font-black text-slate-400 italic">
                                <tr>
                                    <th class="p-4">Fecha</th>
                                    <th class="p-4">Concepto</th>
                                    <th class="p-4 text-right">Monto</th>
                                </tr>
                            </thead>
                            <tbody id="cajaTableBody" class="text-sm font-bold uppercase italic"></tbody>
                        </table>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- MODAL IA -->
    <div id="aiModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md flex items-center justify-center p-6 z-[9999]">
        <div class="bg-white w-full max-w-2xl rounded-[3rem] p-10 shadow-ai-glow border-8 border-fix-ai/20">
            <h3 class="text-3xl font-black italic uppercase text-fix-ai mb-4 flex items-center gap-3">
                ‚ú® Asistente IA Gemini
            </h3>
            <div id="aiContent" class="bg-slate-50 p-8 rounded-3xl min-h-[200px] text-lg font-bold italic text-slate-700 leading-relaxed mb-8 shadow-inner">
                Generando respuesta...
            </div>
            <div class="flex gap-4">
                <button onclick="applyAI()" class="flex-grow bg-fix-ai text-white py-5 rounded-full font-black uppercase italic shadow-lg">Aplicar Texto</button>
                <button onclick="toggleAI(false)" class="px-8 bg-slate-200 text-slate-500 rounded-full font-black uppercase italic">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="msgBox" class="fixed bottom-10 left-1/2 -translate-x-1/2 opacity-0 pointer-events-none transition-all duration-500 z-[9999]"></div>

    <!-- LOGICA DEL SISTEMA -->
    <script>
        // --- CONFIGURACI√ìN FIREBASE (Mant√©n la tuya) ---
        const config = {
          apiKey: "AIzaSyCiESorKZljYeFHr19c_XPth2qWluz1Dro",
          authDomain: "fix-agenda-app.firebaseapp.com",
          projectId: "fix-agenda-app",
          storageBucket: "fix-agenda-app.firebasestorage.app",
          messagingSenderId: "98719439808",
          appId: "1:98719439808:web:66576c19c8b5233a718625",
        };
        firebase.initializeApp(config);
        const db = firebase.database();
        const geminiKey = ""; // Llave autom√°tica

        // --- MAESTROS ---
        let visits = [];
        let movements = [];
        let inventory = [];
        let currentTechUser = null;
        const LISTA_TECNICOS = ["", "Andres Cardenas", "Cristian Capelo", "Juan Carlos Pando", "Juana Cardenas", "Allan Skykaz"];
        const ACCESORIOS = { 
            'Enchufe 110V': 5.00, 'Enchufe 220V 20V': 7.00, 'Enchufe 220V 50V': 10.00, 
            'Manguera c/bridas': 4.00, 'Ducto 4 pulg mt': 5.00, 'Enchufe chinito': 5.00, 'Teflon': 1.50
        };
        const SERVICIOS = ["Instalaci√≥n", "Garant√≠a", "Mantenimiento", "Reparaci√≥n", "Visita"];

        // --- NAVEGACI√ìN ---
        function changeMasterView(view) {
            const views = ['view-agenda', 'view-reportes', 'view-almacen', 'view-caja'];
            views.forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(`view-${view}`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(b => {
                b.classList.remove('bg-fix-blue', 'text-white');
                b.classList.add('bg-slate-100', 'text-slate-500');
            });
            const btn = document.getElementById(`nav-${view}`);
            if(btn) { btn.classList.add('bg-fix-blue', 'text-white'); btn.classList.remove('bg-slate-100', 'text-slate-500'); }
            
            if(view === 'caja') renderCaja();
            if(view === 'almacen') renderInventory();
            if(view === 'reportes') renderReporteTeka();
        }

        // --- AGENDA Y RENDERING ---
        function renderAgenda() {
            const list = document.getElementById('agendaList');
            const date = document.getElementById('agendaDateFilter').value;
            let filtered = visits.sort((a,b) => b.createdAt - a.createdAt);
            
            if(currentTechUser) filtered = filtered.filter(v => v.tecnico === currentTechUser);
            if(date) filtered = filtered.filter(v => v.fechaInstalacion === date);

            list.innerHTML = filtered.map(v => `
                <div class="bg-white p-10 rounded-[4rem] shadow-premium border-l-[30px] ${v.estado === 'Atendido' ? 'border-fix-report' : 'border-fix-accent'} mb-8 group overflow-hidden transition-all">
                    <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6">
                        <div>
                            <h3 class="text-5xl font-black italic uppercase text-slate-800 tracking-tighter leading-none mb-2">${v.nombreCliente}</h3>
                            <span class="text-xs font-black text-slate-300 uppercase italic">T√©cnico: ${v.tecnico || 'S/N'}</span>
                            <p class="text-xl font-bold text-slate-500 mt-4 uppercase italic border-l-4 border-fix-accent pl-4">${v.direccion}</p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="px-6 py-2 rounded-full font-black uppercase italic text-[10px] ${v.estado === 'Atendido' ? 'bg-fix-report text-white' : 'bg-fix-accent text-white'}">${v.estado}</span>
                            <span class="text-[10px] font-bold text-slate-300 uppercase font-mono tracking-widest">${new Date(v.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-6 rounded-[2.5rem] border-4 border-white shadow-inner no-print">
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <select id="st_${v.id}" class="p-4 bg-white rounded-2xl font-black text-sm border-none shadow-sm text-fix-blue outline-none">
                                <option value="PENDIENTE">Estado...</option>
                                <option value="SI" ${v.estado === 'Atendido' ? 'selected' : ''}>SI (Atendido)</option>
                                <option value="NO" ${v.estado === 'No Atendido' ? 'selected' : ''}>NO (Fallido)</option>
                            </select>
                            <select id="ty_${v.id}" class="p-4 bg-white rounded-2xl font-black text-sm border-none shadow-sm outline-none">
                                ${SERVICIOS.map(s => `<option value="${s}" ${v.tipoAtencion === s ? 'selected' : ''}>${s}</option>`).join('')}
                            </select>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mb-6">
                            ${Object.entries(ACCESORIOS).map(([n, p]) => `
                                <div class="flex items-center justify-between p-3 bg-white rounded-2xl border border-slate-100">
                                    <span class="text-[10px] font-black uppercase text-slate-400">${n}</span>
                                    <input type="number" value="0" data-n="${n}" data-p="${p}" class="acc-${v.id} w-12 text-center bg-slate-50 rounded-lg font-black text-lg p-2">
                                </div>`).join('')}
                        </div>
                        <textarea id="obs_${v.id}" placeholder="Notas de cierre..." class="w-full bg-white p-6 rounded-3xl border-none font-bold text-sm uppercase text-slate-500 mb-6 h-24 outline-none">${v.razonNoAtencion || ''}</textarea>
                        <button onclick="closeVisit('${v.id}')" class="w-full bg-fix-blue text-white py-5 rounded-full font-black italic uppercase shadow-lg active:scale-95 transition-all">üíæ Guardar Reporte</button>
                    </div>
                </div>`).join('');
        }

        // --- L√ìGICA DE NEGOCIO ---
        function saveVisit() {
            const form = document.getElementById('mainForm');
            const data = Object.fromEntries(new FormData(form));
            const eqs = [];
            for(let i=1; i<=data.numEquipos; i++) {
                eqs.push({ desc: data[`descProducto_${i}`], cod: data[`codProducto_${i}`] || '-', serie: (data[`serieEquipo_${i}`] || '-').toUpperCase(), costo: parseFloat(data[`costoEquipo_${i}`]) || 0 });
            }
            
            const total = parseFloat(document.getElementById('displayTotal').textContent.replace('$',''));
            const ref = db.ref('visits').push();
            ref.set({
                id: ref.key, ...data, nombreCliente: data.nombreCliente.toUpperCase(), direccion: data.direccion.toUpperCase(),
                estado: 'PENDIENTE', createdAt: Date.now(), equipos: eqs, financiera: { totalCliente: total }
            }).then(() => { msg("‚úÖ Agendado", "fix-report"); form.reset(); renderEquipmentFields(); });
        }

        function closeVisit(id) {
            const s = document.getElementById(`st_${id}`).value;
            const t = document.getElementById(`ty_${id}`).value;
            const r = document.getElementById(`obs_${id}`).value;
            const accs = [];
            document.querySelectorAll(`.acc-${id}`).forEach(i => {
                const q = parseInt(i.value) || 0;
                if(q > 0) accs.push({ nombre: i.dataset.n, cantidad: q, precio: parseFloat(i.dataset.p) });
            });

            if(s === 'PENDIENTE') return msg("Elija SI o NO", "fix-accent");

            db.ref('visits/' + id).update({
                estado: s === 'SI' ? 'Atendido' : 'No Atendido',
                tipoAtencion: t, razonNoAtencion: r, accesoriosVendidos: accs,
                attendedDate: new Date().toISOString()
            }).then(() => msg("‚úÖ Reporte Guardado", "fix-report"));
        }

        // --- COMPONENTES DIN√ÅMICOS ---
        function renderEquipmentFields() {
            const count = document.getElementById('numEquipos').value;
            const container = document.getElementById('equipmentFields');
            container.innerHTML = '';
            for(let i=1; i<=count; i++) {
                container.innerHTML += `
                    <div class="p-6 bg-slate-50 rounded-3xl border-2 border-slate-100 grid grid-cols-2 md:grid-cols-4 gap-3">
                        <select name="descProducto_${i}" class="col-span-2 p-3 rounded-xl font-bold text-xs" required><option value="">Servicio...</option>${SERVICIOS.map(s => `<option value="${s}">${s}</option>`).join('')}</select>
                        <input type="text" name="serieEquipo_${i}" placeholder="Serie" class="p-3 rounded-xl font-bold text-xs uppercase">
                        <input type="number" name="costoEquipo_${i}" value="25.00" oninput="calculateTotalForm()" class="p-3 rounded-xl font-black text-lg text-right bg-yellow-50">
                    </div>`;
            }
            calculateTotalForm();
        }

        function calculateTotalForm() {
            let total = 0;
            document.querySelectorAll('input[name^="costoEquipo_"]').forEach(i => total += parseFloat(i.value) || 0);
            document.querySelectorAll('.form-acc-qty').forEach(i => total += (parseInt(i.value) || 0) * (parseFloat(i.dataset.p) || 0));
            document.getElementById('displayTotal').textContent = `$${total.toFixed(2)}`;
        }

        function renderReporteTeka() {
            const body = document.getElementById('tekaTableBody');
            const atended = visits.filter(v => v.estado === 'Atendido');
            body.innerHTML = atended.flatMap(v => (v.equipos || []).map(eq => `
                <tr class="border-b row-hover">
                    <td class="p-4">${v.fechaInstalacion}</td>
                    <td class="p-4">${eq.cod || '-'}</td>
                    <td class="p-4 font-black text-fix-blue">${eq.desc}</td>
                    <td class="p-4 font-mono">${eq.serie}</td>
                    <td class="p-4 italic">${v.nombreCliente}</td>
                    <td class="p-4 text-right font-black">$${(eq.costo || 0).toFixed(2)}</td>
                </tr>`)).join('');
        }

        function renderCaja() {
            const body = document.getElementById('cajaTableBody');
            const ingresos = visits.filter(v => v.estado === 'Atendido' && v.financiera).map(v => ({ concepto: `SERVICIO: ${v.nombreCliente}`, monto: v.financiera.totalCliente, fecha: v.createdAt, t: 'IN' }));
            // Aqu√≠ puedes agregar egresosArray si tienes
            let tIn = 0; ingresos.forEach(i => tIn += i.monto);
            
            body.innerHTML = ingresos.map(i => `<tr class="border-b"><td class="p-4 font-mono">${new Date(i.fecha).toLocaleDateString()}</td><td class="p-4 font-bold uppercase">${i.concepto}</td><td class="p-4 text-right font-black text-green-600">$${i.monto.toFixed(2)}</td></tr>`).join('');
            document.getElementById('cajaIngresos').textContent = `$${tIn.toFixed(2)}`;
            document.getElementById('cajaNeto').textContent = `$${tIn.toFixed(2)}`;
        }

        // --- INICIALIZACI√ìN ---
        function msg(t, c) {
            const b = document.getElementById('msgBox');
            b.textContent = t; b.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-10 py-5 rounded-full shadow-2xl text-white font-black bg-${c} opacity-100 z-[9999]`;
            setTimeout(() => b.className = "opacity-0", 3000);
        }

        function detectUser() {
            const p = new URLSearchParams(window.location.search);
            const t = p.get('tech');
            if(t && LISTA_TECNICOS.includes(t)) {
                currentTechUser = t; document.body.classList.add('technician-mode');
                document.getElementById('userDisplayLabel').textContent = "T√âCNICO: " + t.toUpperCase();
                changeMasterView('agenda');
            } else { document.getElementById('userDisplayLabel').textContent = "ADMINISTRACI√ìN FIX"; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('agendaDateFilter').value = hoy;
            document.getElementById('inputFecha').value = hoy;

            detectUser();
            LISTA_TECNICOS.forEach(t => document.getElementById('selectTecnico').add(new Option(t || "TECNICO...", t)));
            
            const accList = document.getElementById('accFormList');
            accList.innerHTML = Object.entries(ACCESORIOS).map(([n, p]) => `
                <div class="flex justify-between items-center">
                    <span class="text-[10px] font-bold text-slate-500">${n} ($${p})</span>
                    <input type="number" data-p="${p}" oninput="calculateTotalForm()" class="form-acc-qty w-12 text-center bg-white rounded-lg font-bold">
                </div>`).join('');

            db.ref('visits').on('value', s => { visits = s.val() ? Object.values(s.val()) : []; renderAgenda(); });
            renderEquipmentFields();
        });
    </script>
</body>
</html>
