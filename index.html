<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIX - GESTI√ìN</title>
    
    <!-- TAILWIND Y CONFIGURACI√ìN DE DISE√ëO -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fix-blue': '#1e3a8a',
                        'fix-light': '#3b82f6',
                        'fix-accent': '#f59e0b',
                        'fix-report': '#059669',
                        'fix-error': '#dc2626',
                        'fix-ai': '#8b5cf6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        .currency-input { text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        @media print { .no-print { display: none !important; } }
        
        /* MODO T√âCNICO */
        body.technician-mode .admin-only { display: none !important; }
        body.technician-mode .main-grid { grid-template-columns: 1fr !important; }
        
        /* Estilos de tablas */
        .admin-table thead th {
            position: sticky;
            top: 0;
            background: #1e293b;
            color: #ffffff;
            z-index: 10;
            padding: 0.75rem;
            text-transform: uppercase;
            font-size: 0.55rem;
            letter-spacing: 0.05em;
        }

        .rutero-table td {
            font-size: 10px;
            padding: 6px 8px !important;
            text-transform: uppercase;
            font-weight: 700;
            line-height: 1.2;
        }
        .rutero-table th {
            font-size: 9px;
            padding: 6px !important;
            background: #f8fafc;
            color: #64748b;
        }
        
        .row-hover:hover { background-color: #f1f5f9; }
        .detail-row { background-color: #f8fafc; border-left: 6px solid #1e3a8a; }
        html { scroll-behavior: smooth; }

        .report-cell { font-size: 8px; line-height: 1.1; padding: 4px !important; white-space: nowrap; border: 1px solid #e2e8f0; }
    </style>
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // --- CONFIGURACI√ìN FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCiESorKZljYeFHr19c_XPth2qWluz1Dro",
          authDomain: "fix-agenda-app.firebaseapp.com",
          projectId: "fix-agenda-app",
          storageBucket: "fix-agenda-app.firebasestorage.app",
          messagingSenderId: "98719439808",
          appId: "1:98719439808:web:66576c19c8b5233a718625",
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- VARIABLES GLOBALES ---
        let visitsArray = [];      
        let egresosArray = [];     
        let inventarioMovs = [];   
        let currentView = 'reporte_admin';
        let currentTechUser = null; 
        let ruteroFilterTech = ""; 

        const LISTA_TECNICOS = ["", "Andres Cardenas", "Cristian Capelo", "Juan Carlos Pando", "Allan Skykaz", "Juana Cardenas"];
        const LUGARES_COMPRA = ["", "COMERCIAL KYWI", "COMERCIAL SOLIS", "COMO HOGAR", "SUKASA", "LUNA PAZMI√ëO", "Macaofertas", "Home Vega", "Mercard", "Teka Directo", "Otro"];
        const ACCESORIOS_DEFAULT = { 
            'Enchufe 110V': 5.00, 'Enchufe 220V 20V': 7.00, 'Enchufe 220V 50V': 10.00, 
            'Manguera c/bridas': 4.00, 'Ducto 4 pulgadas metro': 5.00, 'Enchufe chinito': 5.00, 'Abrazadera': 1.00, 'Teflon': 1.50
        };
        const TIPOS_SERVICIO = ["Instalaci√≥n", "Garant√≠a", "Fuera de Garant√≠a", "Mantenimiento", "Reparaci√≥n", "Visita T√©cnica"];
        const TIPOS_EQUIPO = ["Cocina Inducci√≥n", "Cocina a Gas", "Horno El√©ctrico", "Horno a Gas", "Campana Tradicional", "Campana Decorativa", "Microondas", "Refrigerador", "Lavavajillas", "Triturador", "Fregadero/Grifer√≠a"];

        // --- FUNCIONES DE INTERFAZ ---

        window.renderInsumosAdmin = function() {
            const container = document.getElementById('accesoriosContainerAdmin');
            if(!container) return;
            container.innerHTML = Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => `
                <div class="flex items-center justify-between p-6 bg-white rounded-[2.5rem] border-4 border-slate-50 shadow-sm transition-all hover:scale-95">
                    <span class="text-[11px] font-black text-slate-400 uppercase italic">${n}</span>
                    <div class="flex items-center gap-3">
                        <span class="text-[11px] font-black text-fix-blue bg-blue-50 px-3 py-1 rounded-full italic">$${p.toFixed(2)}</span>
                        <input type="number" min="0" value="0" data-price="${p}" data-name="${n}" oninput="calculateFinancials()" class="form-acc-qty w-16 text-center bg-slate-50 rounded-xl p-2 text-xl font-black text-fix-blue outline-none border-b-2 border-slate-200">
                    </div>
                </div>`).join('');
        };

        function renderUIAgenda() {
            const list = document.getElementById('visitsList');
            if(!list) return;
            const filterDate = document.getElementById('filterDateInput').value;
            
            let filtered = visitsArray.sort((a,b) => b.createdAt - a.createdAt);
            if(currentTechUser) filtered = filtered.filter(v => v.tecnico === currentTechUser);
            if(filterDate) filtered = filtered.filter(v => v.fechaInstalacion === filterDate);

            list.innerHTML = filtered.map(v => `
                <div class="bg-white p-6 rounded-[2.5rem] shadow-premium border-l-[15px] ${v.estado === 'Atendido' ? 'border-fix-report' : 'border-fix-accent'} mb-6 relative transition-all">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-black text-fix-blue text-2xl uppercase italic leading-none">${v.nombreCliente}</h3>
                            <span class="text-[10px] font-bold text-slate-400 uppercase italic">T√©cnico: ${v.tecnico || 'S/A'}</span>
                        </div>
                        <span class="text-[9px] font-black uppercase ${v.estado === 'Atendido' ? 'text-fix-report' : 'text-fix-accent'} italic underline">${v.estado}</span>
                    </div>
                    <details class="mt-4 no-print">
                        <summary class="text-[9px] font-black text-slate-400 uppercase cursor-pointer hover:text-fix-blue">Panel T√©cnico / Reporte</summary>
                        <div class="mt-3 p-4 bg-slate-50 rounded-xl border border-white shadow-inner">
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div class="flex flex-col"><span class="text-[8px] font-black text-slate-300 ml-1">ESTADO</span><select id="status_${v.id}" class="p-3 bg-white rounded-lg font-black text-xs shadow-sm"><option value="PENDIENTE">¬øATENDI√ì?</option><option value="SI" ${v.estado === 'Atendido' ? 'selected' : ''}>S√ç (EXITO)</option><option value="NO" ${v.estado === 'No Atendido' ? 'selected' : ''}>NO (FALL√ì)</option></select></div>
                                <div class="flex flex-col"><span class="text-[8px] font-black text-slate-300 ml-1">SERVICIO</span><select id="type_${v.id}" class="p-3 bg-white rounded-lg font-black text-xs shadow-sm">${TIPOS_SERVICIO.map(t => `<option value="${t}" ${v.tipoAtencion === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mb-4">
                                ${Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => `
                                    <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-slate-100"><span class="text-[9px] font-black uppercase">${n}</span><input type="number" min="0" value="0" data-name="${n}" data-price="${p}" class="acc-${v.id} w-10 text-center bg-slate-50 rounded p-1 font-black text-xs"></div>`).join('')}
                            </div>
                            <textarea id="reason_${v.id}" placeholder="Notas..." class="w-full bg-white p-3 rounded-lg border-none font-bold text-[10px] mb-3 h-20 shadow-inner uppercase">${v.razonNoAtencion || ''}</textarea>
                            <button onclick="closeVisitByTech('${v.id}')" class="w-full bg-fix-blue text-white font-black py-3 rounded-lg text-sm shadow uppercase italic">üíæ GUARDAR REPORTE</button>
                        </div>
                    </details>
                </div>`).join('');
        }

        window.toggleRuteroDetail = (id) => {
            const el = document.getElementById(`detail-${id}`);
            if(el) el.classList.toggle('hidden');
        };

        function renderRutero() {
            const list = document.getElementById('ruteroListBody');
            if(!list) return;
            const filterDateInput = document.getElementById('filterDateInput');
            const filterDate = filterDateInput ? filterDateInput.value : '';
            
            let techToFilter = currentTechUser || ruteroFilterTech;
            let filtered = visitsArray.sort((a,b) => b.createdAt - a.createdAt);
            if(filterDate) filtered = filtered.filter(v => v.fechaInstalacion === filterDate);
            if(techToFilter) filtered = filtered.filter(v => v.tecnico === techToFilter);

            if(filtered.length === 0) {
                list.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-slate-300 italic font-black text-xl uppercase">Sin servicios programados</td></tr>';
                return;
            }

            list.innerHTML = filtered.map(v => {
                const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v.direccion)}`;
                const numEq = (v.equipos || []).length;
                const equipoDetails = (v.equipos || []).map(e => `<div class="mb-1 border-b border-slate-200 pb-1 last:border-0"><span class="text-fix-blue font-black">${e.descProducto}</span> | Cod: ${e.codProducto || '-'} | Ser: ${e.serieEquipo || '-'}</div>`).join('');

                return `
                <tr class="border-b row-hover">
                    <td class="border-r font-black text-fix-blue cursor-pointer" onclick="toggleRuteroDetail('${v.id}')">${v.nombreCliente}</td>
                    <td class="border-r text-slate-400 italic">${v.tecnico || 'S/A'}</td>
                    <td class="border-r text-center font-mono text-fix-accent">${numEq}</td>
                    <td class="border-r">
                        <a href="${mapsUrl}" target="_blank" class="text-fix-light underline leading-tight block">üìç MAPA</a>
                    </td>
                    <td class="border-r text-slate-600 font-mono">
                        <a href="tel:${v.telefono}">${v.telefono || '-'}</a>
                    </td>
                    <td class="text-center admin-only no-print">
                        <button onclick="deleteVisit('${v.id}')" class="text-fix-error p-1">üóëÔ∏è</button>
                    </td>
                </tr>
                <tr id="detail-${v.id}" class="hidden detail-row transition-all">
                    <td colspan="6" class="p-4 bg-slate-50">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-[10px] mb-4 uppercase">
                            <div class="space-y-1">
                                <p><span class="text-slate-400">C√âDULA:</span> ${v.cedula || 'N/A'}</p>
                                <p><span class="text-slate-400">EMAIL:</span> ${v.email || 'N/A'}</p>
                                <p><span class="text-slate-400">LUGAR COMPRA:</span> ${v.lugarCompra || 'N/A'}</p>
                                <p><span class="text-slate-400">DIRECCI√ìN:</span> ${v.direccion}</p>
                            </div>
                            <div class="bg-white p-3 rounded-xl border border-fix-blue/10 shadow-sm">
                                <span class="block font-black text-fix-blue mb-2 text-[8px] border-b pb-1">REAGENDAR / ACTUALIZAR FECHA</span>
                                <div class="flex gap-2">
                                    <input type="date" id="newdate_${v.id}" value="${v.fechaInstalacion}" class="p-2 bg-slate-50 rounded font-black text-xs outline-none">
                                    <button onclick="rescheduleVisit('${v.id}')" class="bg-fix-blue text-white px-3 rounded font-black text-[9px] uppercase">OK</button>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded-xl shadow-inner border border-slate-200">
                            <p class="font-black text-slate-400 mb-2 border-b text-[9px]">EQUIPOS DETALLE:</p>
                            <div class="text-[9px] font-bold">${equipoDetails}</div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- FUNCIONES LOG√çSTICAS ---

        window.rescheduleVisit = (id) => {
            const newDate = document.getElementById(`newdate_${id}`).value;
            if(!newDate) return;
            database.ref('visits/' + id).update({ fechaInstalacion: newDate })
            .then(() => {
                showMessage("‚úÖ Fecha Actualizada", "fix-report");
                renderRutero();
            });
        };

        window.deleteVisit = (id) => {
            // Se quita confirm() por incompatibilidad con entorno iframe y se deja borrado directo con aviso
            database.ref('visits/' + id).remove().then(() => showMessage("üóëÔ∏è Registro eliminado", "fix-error"));
        };

        window.updateRuteroFilter = (val) => {
            ruteroFilterTech = val;
            renderRutero();
        };

        // --- L√ìGICA DE NAVEGACI√ìN ---

        window.changeMasterView = (view) => {
            currentView = view;
            const panels = ['formContainer', 'contabilidadView', 'inventarioView', 'reporteTekaView', 'agendaContainer', 'ruteroView'];
            panels.forEach(p => {
                const el = document.getElementById(p);
                if(el) el.classList.add('hidden');
            });
            
            if(view === 'reporte_admin') {
                document.getElementById('formContainer').classList.remove('hidden');
                document.getElementById('agendaContainer').classList.remove('hidden');
            } else if(view === 'rutero') {
                document.getElementById('ruteroView').classList.remove('hidden');
                renderRutero();
            } else if(view === 'contabilidad') {
                document.getElementById('contabilidadView').classList.remove('hidden');
                processFinancialBalance();
            } else if(view === 'inventario') {
                document.getElementById('inventarioView').classList.remove('hidden');
                recalculateInventoryStock();
            } else if(view === 'agenda_view') {
                document.getElementById('agendaContainer').classList.remove('hidden');
            } else if(view === 'reporte_teka') {
                document.getElementById('reporteTekaView').classList.remove('hidden');
                renderReporteTeka();
            }

            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-fix-blue', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-500');
            });
            const activeBtn = document.querySelector(`[onclick*="changeMasterView('${view}')"]`);
            if(activeBtn) {
                activeBtn.classList.add('bg-fix-blue', 'text-white');
                activeBtn.classList.remove('bg-gray-100', 'text-gray-500');
            }
        };

        // --- GESTI√ìN DE DATOS ---

        function startSync() {
            database.ref('visits').on('value', snap => {
                const data = snap.val();
                visitsArray = data ? Object.keys(data).map(key => ({...data[key], id: key})) : [];
                renderUIAgenda();
                if(currentView === 'rutero') renderRutero();
                if(currentView === 'reporte_teka') renderReporteTeka();
                if(currentView === 'contabilidad') processFinancialBalance();
            });
            database.ref('egresos').on('value', snap => {
                const data = snap.val();
                egresosArray = data ? Object.keys(data).map(key => ({...data[key], id: key})) : [];
                if(currentView === 'contabilidad') processFinancialBalance();
            });
            database.ref('inventarioMovs').on('value', snap => {
                const data = snap.val();
                inventarioMovs = data ? Object.keys(data).map(key => ({...data[key], id: key})) : [];
                if(currentView === 'inventario') recalculateInventoryStock();
            });
        }

        window.expandEquipmentUI = () => {
            const numEquiposInput = document.getElementById('numEquipos');
            if(!numEquiposInput) return;
            const count = parseInt(numEquiposInput.value) || 1;
            const container = document.getElementById('productInputsContainer');
            if(!container) return;
            container.innerHTML = '';
            for(let i=1; i<=count; i++) {
                container.innerHTML += `
                    <div class="p-6 bg-slate-50 rounded-3xl border-4 border-white mb-4 grid grid-cols-1 md:grid-cols-4 gap-4 relative shadow-sm">
                        <div class="flex flex-col"><span class="text-[9px] font-black text-slate-400 mb-1 uppercase ml-2">Equipo*</span><select name="descProducto_${i}" class="p-3 bg-white rounded-xl border-none font-bold text-xs shadow-sm" required><option value="">ELEGIR...</option>${TIPOS_EQUIPO.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                        <div class="flex flex-col"><span class="text-[9px] font-black text-slate-400 mb-1 uppercase ml-2">C√≥digo</span><input type="text" name="codProducto_${i}" placeholder="Cod." class="p-3 bg-white rounded-xl border-none font-black text-xs shadow-sm"></div>
                        <div class="flex flex-col"><span class="text-[9px] font-black text-slate-400 mb-1 uppercase ml-2">Serie</span><input type="text" name="serieEquipo_${i}" placeholder="S/N" class="p-3 bg-white rounded-xl border-none font-black text-xs shadow-sm uppercase"></div>
                        <div class="flex flex-col"><span class="text-[9px] font-black text-slate-400 mb-1 uppercase text-right">M.O. ($)*</span><input type="number" name="costoEquipo_${i}" step="0.01" value="25.00" oninput="calculateFinancials()" class="p-3 bg-yellow-50 rounded-xl border-none font-black text-lg text-right text-fix-blue italic tracking-tighter"></div>
                    </div>`;
            }
            calculateFinancials();
        };

        window.calculateFinancials = () => {
            let moTotal = 0; 
            document.querySelectorAll('input[name^="costoEquipo_"]').forEach(i => moTotal += parseFloat(i.value) || 0);
            
            let accTotal = 0; 
            document.querySelectorAll('.form-acc-qty').forEach(i => accTotal += (parseInt(i.value) || 0) * (parseFloat(i.dataset.price) || 0));
            
            const moDisplay = document.getElementById('displayCostoInstalacion');
            const accDisplay = document.getElementById('displayTotalAccesorios');
            const totalDisplay = document.getElementById('displayTotalFinal');

            if(moDisplay) moDisplay.textContent = `$${moTotal.toFixed(2)}`;
            if(accDisplay) accDisplay.textContent = `$${accTotal.toFixed(2)}`;
            if(totalDisplay) totalDisplay.textContent = `$${(moTotal + accTotal).toFixed(2)}`;
        };

        window.saveVisit = () => {
            const form = document.getElementById('visitForm');
            const data = Object.fromEntries(new FormData(form));
            const eqs = []; const numEq = parseInt(data.numEquipos) || 1;
            for(let i=1; i<=numEq; i++) {
                if(!data[`descProducto_${i}`]) { showMessage("Falta equipo #" + i, "fix-error"); return; }
                eqs.push({ descProducto: data[`descProducto_${i}`], codProducto: data[`codProducto_${i}`] || '', serieEquipo: (data[`serieEquipo_${i}`] || '').toUpperCase(), costoBase: parseFloat(data[`costoEquipo_${i}`]) || 0 });
            }
            const ref = database.ref('visits').push();
            ref.set({ id: ref.key, nombreCliente: data.nombreCliente.toUpperCase(), cedula: data.cedula || '', email: data.email || '', telefono: data.telefono || '', direccion: data.direccion.toUpperCase(), fechaInstalacion: data.fechaInstalacion, fechaEmision: data.fechaEmision || data.fechaInstalacion, lugarCompra: data.lugarCompra || '', tecnico: data.tecnico || '', tipoAtencion: data.tipoAtencion, estado: 'PENDIENTE', createdAt: Date.now(), equipos: eqs, financiera: { totalCliente: parseFloat(document.getElementById('displayTotalFinal').textContent.replace('$','')), formaPago: 'PENDIENTE' } })
            .then(() => { 
                showMessage("‚úÖ Agendado con √©xito", "fix-report"); 
                form.reset(); 
                document.getElementById('filterDateInput').value = data.fechaInstalacion;
                expandEquipmentUI(); 
                renderInsumosAdmin(); 
            });
        };

        window.closeVisitByTech = (id) => {
            const s = document.getElementById(`status_${id}`).value;
            const t = document.getElementById(`type_${id}`).value;
            const r = document.getElementById(`reason_${id}`).value;
            const accs = []; let totalAccs = 0;
            document.querySelectorAll(`.acc-${id}`).forEach(i => {
                const q = parseInt(i.value) || 0;
                if(q > 0) { const p = parseFloat(i.dataset.price); accs.push({ nombre: i.dataset.name, cantidad: q, precio: p }); totalAccs += q * p; }
            });
            if(s === 'PENDIENTE') return showMessage("‚ö†Ô∏è Elija SI o NO", "fix-accent");
            const visit = visitsArray.find(v => v.id === id);
            const mo = (visit.equipos || []).reduce((acc, eq) => acc + (eq.costoBase || 0), 0);
            database.ref('visits/' + id).update({ estado: s === 'SI' ? 'Atendido' : 'No Atendido', tipoAtencion: t, razonNoAtencion: r, accesoriosVendidos: accs, attendedDate: new Date().toISOString(), 'financiera/totalCliente': (mo + totalAccs) })
            .then(() => showMessage("‚úÖ Reporte Guardado", "fix-report"));
        };

        window.saveManualEgreso = () => {
            const c = document.getElementById('egConcepto').value;
            const m = parseFloat(document.getElementById('egMonto').value);
            if(!c || !m) return showMessage("Falta concepto/monto", "fix-error");
            database.ref('egresos').push({ concepto: c.toUpperCase(), monto: m, fecha: Date.now(), type: 'EGRESO' })
            .then(() => { showMessage("‚úÖ Gasto registrado", "fix-report"); document.getElementById('egConcepto').value = ''; document.getElementById('egMonto').value = ''; });
        };

        window.deleteEgreso = (id) => {
            // Borrado directo sin confirm() para evitar bloqueos de navegador
            database.ref('egresos/' + id).remove().then(() => showMessage("üóëÔ∏è Registro eliminado", "fix-error"));
        };

        window.saveFacturaCompra = () => {
            const a = document.getElementById('invAccesorioSelect').value;
            const qInput = document.getElementById('invCantidad');
            const cInput = document.getElementById('invCostoTotal');
            const q = parseInt(qInput.value);
            const c = parseFloat(cInput.value);
            if(!q || !c) return showMessage("Faltan datos", "fix-error");
            database.ref('inventarioMovs').push({ accesorio: a, cantidad: q, costoTotal: c, fecha: Date.now(), type: 'COMPRA' })
            .then(() => { showMessage("‚úÖ Stock Cargado", "fix-report"); qInput.value = ''; cInput.value = ''; recalculateInventoryStock(); });
        };

        function recalculateInventoryStock() {
            let stockMap = {}; Object.keys(ACCESORIOS_DEFAULT).forEach(n => stockMap[n] = { qty: 0, valor: 0 });
            inventarioMovs.filter(m => m.type === 'COMPRA').forEach(m => { if(stockMap[m.accesorio]) { stockMap[m.accesorio].qty += m.cantidad; stockMap[m.accesorio].valor += m.costoTotal; } });
            visitsArray.filter(v => v.estado === 'Atendido' && v.accesoriosVendidos).forEach(v => { v.accesoriosVendidos.forEach(item => { if(stockMap[item.nombre]) stockMap[item.nombre].qty -= item.cantidad; }); });
            const body = document.getElementById('inventarioTableBody');
            if(body) {
                body.innerHTML = Object.entries(stockMap).map(([n, d]) => `<tr class="border-b row-hover"><td class="p-8 font-black uppercase italic text-2xl">${n}</td><td class="p-8 text-center"><span class="bg-fix-blue text-white px-8 py-3 rounded-2xl font-black text-3xl">${d.qty}</span></td><td class="p-8 text-right font-black text-2xl italic">$${d.valor.toFixed(2)}</td></tr>`).join('');
            }
        }

        function processFinancialBalance() {
            const ingresos = visitsArray.filter(v => v.estado === 'Atendido' && v.financiera).map(v => ({ monto: v.financiera.totalCliente, type: 'INGRESO', concepto: `VISITA: ${v.nombreCliente}`, fecha: v.attendedDate ? new Date(v.attendedDate).getTime() : v.createdAt, id: v.id }));
            const egres = egresosArray.map(e => ({ monto: e.monto, type: 'EGRESO', concepto: e.concepto, fecha: e.fecha, id: e.id }));
            const todos = [...ingresos, ...egres].sort((a,b) => b.fecha - a.fecha);
            
            let tIn = 0; let tOut = 0;
            const tb = document.getElementById('contabilidadTableBody');
            if(tb) {
                tb.innerHTML = todos.map(m => {
                    if(m.type === 'INGRESO') tIn += m.monto; else tOut += m.monto;
                    return `<tr class="border-b row-hover">
                        <td class="p-4 font-mono text-[10px] italic font-black">${new Date(m.fecha).toLocaleDateString()}</td>
                        <td class="p-4"><span class="${m.type==='INGRESO'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'} px-4 py-1 rounded-full font-black text-[9px] uppercase italic">${m.type}</span></td>
                        <td class="p-4 text-xs font-bold uppercase italic">${m.concepto}</td>
                        <td class="p-4 text-sm text-right font-black italic">$${m.monto.toFixed(2)}</td>
                        <td class="p-4 text-right">${m.type==='EGRESO' ? `<button onclick="deleteEgreso('${m.id}')" class="bg-red-100 text-red-500 p-2 rounded-lg">üóëÔ∏è</button>` : ''}</td>
                    </tr>`;
                }).join('');
            }
            const inDisp = document.getElementById('totalIngresosDisplay');
            const outDisp = document.getElementById('totalEgresosDisplay');
            const netDisp = document.getElementById('balanceNetoDisplay');
            if(inDisp) inDisp.textContent = `$${tIn.toFixed(2)}`;
            if(outDisp) outDisp.textContent = `$${tOut.toFixed(2)}`;
            if(netDisp) netDisp.textContent = `$${(tIn - tOut).toFixed(2)}`;
        }

        window.downloadCSV = (type) => {
            let data = []; let filename = "reporte.csv";
            if(type === 'teka') {
                filename = `Reporte_Maestro_Teka.csv`;
                data = visitsArray.flatMap(v => (v.equipos || []).map(eq => {
                    const fechaAtencion = v.attendedDate ? new Date(v.attendedDate).toLocaleDateString() : v.fechaInstalacion;
                    return {
                        "FECHA DE COMPRA": v.fechaEmision || "", 
                        "LUGAR DE COMPRA": v.lugarCompra || "", 
                        "FACTURA": "", 
                        "CODIGO DEL PRODUCTO": eq.codProducto || "", 
                        "DESCRIPCION DEL PRODUCTO": eq.descProducto || "", 
                        "SERIE": eq.serieEquipo || "", 
                        "GARANTIA DEL EQUIPO": "SAP", 
                        "TECNICO": "capelo", 
                        "CIUDAD": "Cuenca", 
                        "FECHA DE ATENCION": fechaAtencion, 
                        "NOMBRE DEL CLIENTE": v.nombreCliente || "",
                        "DIRECCION DE INSTALACION": v.direccion || "",
                        "CELULAR DEL CLIENTE": v.telefono || "", 
                        "PRECIO": (eq.costoBase || 0).toFixed(2), 
                        "COMO LLEGO": "cliente final", 
                        "TECNICO QUE ATENDIO": "capelo", 
                        "VIATICO": "", 
                        "FACTURA_2": "", 
                        "CEDULA O RUC": v.cedula || "", 
                        "CORREO": v.email || ""
                    };
                }));
            }
            if(data.length === 0) return showMessage("Sin datos", "fix-accent");
            const headers = Object.keys(data[0]).join(",");
            const rows = data.map(obj => Object.values(obj).join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + headers + "\n" + rows)); link.setAttribute("download", filename);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        function renderReporteTeka() {
            const body = document.getElementById('tekaReporteBody');
            if(!body) return;
            if(visitsArray.length === 0) { body.innerHTML = '<tr><td colspan="20" class="p-10 text-center text-slate-400 italic">Sin datos registrados</td></tr>'; return; }
            
            body.innerHTML = visitsArray.flatMap(v => (v.equipos || []).map(eq => {
                const fechaAtencion = v.attendedDate ? new Date(v.attendedDate).toLocaleDateString() : v.fechaInstalacion;
                return `
                <tr class="border-b row-hover">
                    <td class="border report-cell font-bold uppercase">${v.fechaEmision || ''}</td>
                    <td class="border report-cell font-bold uppercase">${v.lugarCompra || ''}</td>
                    <td class="border report-cell"></td> <!-- Factura 1 -->
                    <td class="border report-cell font-bold uppercase">${eq.codProducto || ''}</td>
                    <td class="border report-cell font-bold uppercase">${eq.descProducto || ''}</td>
                    <td class="border report-cell font-bold uppercase">${eq.serieEquipo || ''}</td>
                    <td class="border report-cell font-black uppercase text-fix-blue">SAP</td>
                    <td class="border report-cell font-black uppercase">capelo</td>
                    <td class="border report-cell font-black uppercase">Cuenca</td>
                    <td class="border report-cell font-bold uppercase">${fechaAtencion}</td>
                    <td class="border report-cell font-black uppercase italic">${v.nombreCliente || ''}</td>
                    <td class="border report-cell font-bold uppercase text-[7px]">${v.direccion || ''}</td>
                    <td class="border report-cell font-bold uppercase">${v.telefono || ''}</td>
                    <td class="border report-cell font-black text-right">$${(eq.costoBase || 0).toFixed(2)}</td>
                    <td class="border report-cell font-black uppercase">cliente final</td>
                    <td class="border report-cell font-black uppercase">capelo</td>
                    <td class="border report-cell"></td> <!-- Vi√°tico -->
                    <td class="border report-cell"></td> <!-- Factura 2 -->
                    <td class="border report-cell font-bold uppercase">${v.cedula || ''}</td>
                    <td class="border report-cell font-bold uppercase">${v.email || ''}</td>
                </tr>`;
            })).join('');
        }

        // --- INICIALIZACI√ìN ---

        function detectUserIdentity() {
            const params = new URLSearchParams(window.location.search);
            const tech = params.get('tech');
            if(tech && LISTA_TECNICOS.includes(tech)) {
                currentTechUser = tech; document.body.classList.add('technician-mode');
                const label = document.getElementById('userDisplayLabel');
                if(label) label.textContent = "RUTA: " + tech.toUpperCase();
                changeMasterView('rutero'); 
            } else { 
                const label = document.getElementById('userDisplayLabel');
                if(label) label.textContent = "ADMINISTRACI√ìN CENTRAL FIX"; 
            }
        }

        function showMessage(msg, color) {
            const box = document.getElementById('messageBox'); if(!box) return;
            box.textContent = msg; box.style.opacity = '1';
            box.className = `fixed bottom-32 left-1/2 -translate-x-1/2 p-12 rounded-[5rem] shadow-premium text-white font-black uppercase text-xl bg-${color} z-[9999] transition-opacity duration-500`;
            setTimeout(() => { box.style.opacity = '0'; }, 5000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date().toISOString().split('T')[0];
            const filterDateInput = document.getElementById('filterDateInput');
            const inputFecha = document.getElementById('inputFecha');
            const inputEmision = document.getElementById('inputEmision');
            
            if(filterDateInput) filterDateInput.value = hoy;
            if(inputFecha) inputFecha.value = hoy;
            if(inputEmision) inputEmision.value = hoy;
            
            detectUserIdentity();
            startSync();
            
            const selTec = document.getElementById('selectTecnico');
            const selLug = document.getElementById('selectLugar');
            const ruteroFilter = document.getElementById('ruteroTechFilter');
            if(selTec) LISTA_TECNICOS.forEach(t => selTec.add(new Option(t || "--- T√âCNICO ---", t)));
            if(selLug) LUGARES_COMPRA.forEach(l => selLug.add(new Option(l || "--- LUGAR COMPRA ---", l)));
            if(ruteroFilter) LISTA_TECNICOS.forEach(t => ruteroFilter.add(new Option(t || "TODOS LOS T√âCNICOS", t)));
            const invSel = document.getElementById('invAccesorioSelect');
            if(invSel) invSel.innerHTML = Object.keys(ACCESORIOS_DEFAULT).map(k => `<option value="${k}">${k}</option>`).join('');
            
            renderInsumosAdmin(); expandEquipmentUI();
        });
    </script>
</head>

<body class="bg-slate-100 min-h-screen p-4 md:p-14 font-sans selection:bg-fix-blue selection:text-white">

    <div class="max-w-[2800px] mx-auto">
        
        <header class="mb-14 flex flex-col xl:flex-row justify-between items-center gap-10 no-print text-center xl:text-left">
            <div class="flex items-center">
                <div class="bg-fix-blue p-8 rounded-[3rem] shadow-premium mr-10"><span class="text-7xl font-black text-white italic tracking-tighter">FIX</span></div>
                <div><h1 class="text-7xl font-black uppercase italic tracking-tighter text-slate-800 leading-none">Gesti√≥n</h1><span id="userDisplayLabel" class="text-xl font-black text-slate-400 uppercase italic tracking-[0.2em]">Cargando...</span></div>
            </div>

            <nav id="adminNav" class="flex flex-wrap justify-center bg-white p-4 rounded-[5rem] shadow-premium border-[8px] border-slate-50 gap-4 admin-only">
                <button onclick="changeMasterView('reporte_admin')" class="view-btn py-4 px-10 rounded-[5rem] font-black text-sm uppercase bg-fix-blue text-white italic shadow-md">Agenda Registro</button>
                <button onclick="changeMasterView('rutero')" class="view-btn py-4 px-10 rounded-[5rem] font-black text-sm uppercase bg-gray-100 text-gray-500 italic">Rutero Operativo</button>
                <button onclick="changeMasterView('reporte_teka')" class="view-btn py-4 px-10 rounded-[5rem] font-black text-sm uppercase bg-gray-100 text-gray-500 italic">Reporte Teka</button>
                <button onclick="changeMasterView('inventario')" class="view-btn py-4 px-10 rounded-[5rem] font-black text-sm uppercase bg-gray-100 text-gray-500 italic">Stock</button>
                <button onclick="changeMasterView('contabilidad')" class="view-btn py-4 px-10 rounded-[5rem] font-black text-sm uppercase bg-gray-100 text-gray-500 italic">Caja</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-14 main-grid">
            
            <div id="formContainer" class="lg:col-span-2 space-y-14 admin-only no-print">
                <div class="bg-white p-10 rounded-[4rem] shadow-premium border-[12px] border-white flex flex-wrap gap-8 items-center">
                    <div class="flex flex-col flex-grow">
                        <span class="text-xs font-black uppercase text-slate-400 mb-2 ml-4">Fecha de Trabajo Actual</span>
                        <input type="date" id="filterDateInput" onchange="renderUIAgenda(); renderRutero();" class="bg-slate-50 p-6 rounded-[2.5rem] text-4xl font-black italic text-fix-blue outline-none border-none shadow-inner">
                    </div>
                    <button onclick="window.print()" class="bg-black text-white px-12 py-8 rounded-[3rem] font-black text-xl uppercase shadow-xl">üñ®Ô∏è Imprimir Ruta</button>
                </div>

                <div class="bg-white p-12 rounded-[6rem] shadow-premium border-[15px] border-slate-50">
                    <form id="visitForm" onsubmit="event.preventDefault(); saveVisit();">
                        <h2 class="text-6xl font-black mb-12 italic uppercase text-fix-blue underline decoration-4 underline-offset-8 decoration-slate-100">Registro de Cliente</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                            <input type="text" name="nombreCliente" placeholder="NOMBRE COMPLETO*" required class="p-8 bg-slate-50 rounded-[3rem] font-black text-2xl uppercase shadow-inner">
                            <input type="text" name="cedula" placeholder="C√âDULA / RUC*" class="p-8 bg-slate-50 rounded-[3rem] font-black text-2xl shadow-inner">
                            <input type="email" name="email" placeholder="EMAIL*" class="p-8 bg-slate-50 rounded-[3rem] font-black text-2xl shadow-inner lowercase">
                            <input type="tel" name="telefono" placeholder="TEL√âFONO*" class="p-8 bg-slate-50 rounded-[3rem] font-black text-2xl shadow-inner">
                            <input type="text" name="direccion" placeholder="DIRECCI√ìN / GOOGLE MAPS*" required class="md:col-span-2 p-8 bg-slate-50 rounded-[3rem] font-black text-2xl uppercase shadow-inner">
                            <select name="tecnico" id="selectTecnico" class="p-8 bg-slate-50 rounded-[3rem] font-black text-xl outline-none shadow-inner"></select>
                            <select name="lugarCompra" id="selectLugar" class="p-8 bg-slate-50 rounded-[3rem] font-black text-xl outline-none shadow-inner"></select>
                            <div class="flex flex-col"><span class="text-xs font-black text-slate-400 mb-2 ml-4">Fecha Instalaci√≥n*</span><input type="date" name="fechaInstalacion" id="inputFecha" required class="p-8 bg-slate-50 rounded-[3rem] font-black text-2xl shadow-inner"></div>
                            <div class="flex flex-col"><span class="text-xs font-black text-slate-400 mb-2 ml-4">Fecha Emisi√≥n*</span><input type="date" name="fechaEmision" id="inputEmision" required class="p-8 bg-slate-50 rounded-[3rem] font-black text-2xl shadow-inner"></div>
                            <div class="md:col-span-2 bg-slate-50 p-8 rounded-[3rem] flex items-center justify-between shadow-inner font-black uppercase italic text-slate-300">N¬∞ Equipos: <input type="number" id="numEquipos" name="numEquipos" value="1" min="1" oninput="expandEquipmentUI()" class="w-20 text-center text-5xl text-fix-blue bg-transparent outline-none"></div>
                        </div>
                        <div id="productInputsContainer" class="space-y-8"></div>
                        <textarea id="obsInputGeneral" name="tipoAtencion" placeholder="Observaciones generales del caso..." class="w-full bg-slate-50 p-8 rounded-[3rem] border-none font-black italic text-2xl uppercase shadow-inner h-32 mb-10"></textarea>
                        <div id="accesoriosContainerAdmin" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
                        <div class="mt-12 grid grid-cols-1 xl:grid-cols-3 gap-8 border-t-4 pt-12 border-slate-50">
                            <div class="bg-slate-50 p-10 rounded-[3rem] text-center shadow-inner italic uppercase">Servicio<br><span id="displayCostoInstalacion" class="text-6xl font-black text-fix-blue">$0.00</span></div>
                            <div class="bg-slate-50 p-10 rounded-[3rem] text-center shadow-inner italic uppercase">Insumos<br><span id="displayTotalAccesorios" class="text-6xl font-black text-fix-blue">$0.00</span></div>
                            <div class="bg-fix-accent p-10 rounded-[3rem] text-center shadow-2xl italic uppercase scale-105">Cobro Final<br><span id="displayTotalFinal" class="text-7xl font-black text-white">$0.00</span></div>
                        </div>
                        <button type="submit" class="w-full bg-fix-blue text-white py-12 rounded-[6rem] mt-16 text-5xl font-black italic uppercase shadow-xl hover:scale-95 transition-all">üöÄ AGENDAR VISITA</button>
                    </form>
                </div>
            </div>

            <div id="agendaContainer" class="lg:col-span-1"><h2 class="text-6xl font-black uppercase italic mb-8 border-b-[10px] border-fix-blue text-slate-800">Historial Agenda</h2><div id="visitsList" class="space-y-8"></div></div>

            <!-- RUTERO COMPACTO VIEW -->
            <div id="ruteroView" class="hidden lg:col-span-3 bg-white p-10 rounded-[4rem] shadow-premium">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
                    <h2 class="text-6xl font-black uppercase italic text-slate-800 underline decoration-4 decoration-fix-blue">Rutero Operativo</h2>
                    <select id="ruteroTechFilter" onchange="updateRuteroFilter(this.value)" class="p-6 bg-slate-100 rounded-3xl font-black text-xl admin-only shadow-inner border-none outline-none text-fix-blue">
                        <option value="">TODOS LOS T√âCNICOS</option>
                    </select>
                </div>
                <div class="overflow-x-auto w-full border-4 border-slate-50 rounded-[3rem] shadow-inner">
                    <table class="w-full border-collapse rutero-table">
                        <thead>
                            <tr>
                                <th class="border-r">Nombre del Cliente (Click)</th>
                                <th class="border-r">T√©cnico</th>
                                <th class="border-r text-center">Eq.</th>
                                <th class="border-r text-center">GPS</th>
                                <th class="text-center">Tel√©fono</th>
                                <th class="admin-only no-print">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="ruteroListBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="reporteTekaView" class="hidden lg:col-span-3 bg-white p-6 rounded-[3rem] shadow-premium overflow-hidden">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-4xl font-black uppercase italic tracking-tighter">Reporte Maestro Teka</h2>
                    <button onclick="downloadCSV('teka')" class="bg-fix-report text-white px-8 py-4 rounded-full font-black text-lg shadow-xl uppercase italic">üìä Descargar Excel Oficial</button>
                </div>
                <div class="overflow-x-auto w-full">
                    <table class="w-full border-collapse admin-table">
                        <thead>
                            <tr class="bg-slate-950 text-white">
                                <th>Fecha Compra</th><th>Lugar</th><th>Factura</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Serie</th><th>Garant√≠a</th><th>T√©cnico</th><th>Ciudad</th><th>Atenci√≥n</th><th>Nombre Cliente</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Precio</th><th>Origen</th><th>Atendi√≥</th><th>Vi√°tico</th><th>Factura 2</th><th>C√©dula</th><th>Email</th>
                            </tr>
                        </thead>
                        <tbody id="tekaReporteBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="inventarioView" class="hidden lg:col-span-3 bg-white p-12 rounded-[4rem] border-[15px] border-white shadow-premium"><h2 class="text-7xl font-black mb-10 italic uppercase text-center">Stock</h2><div class="bg-slate-100 p-8 rounded-[3rem] mb-10 flex flex-wrap gap-4 items-center border-4 border-white shadow-inner"><select id="invAccesorioSelect" class="flex-grow p-6 rounded-[2rem] font-black uppercase text-lg shadow-sm"></select><input type="number" id="invCantidad" placeholder="CANT" class="w-32 p-6 rounded-[2rem] text-center font-black text-lg"><input type="number" id="invCostoTotal" placeholder="COSTO" class="w-40 p-6 rounded-[2rem] text-right font-black text-lg"><button onclick="saveFacturaCompra()" class="bg-fix-report text-white px-10 py-5 rounded-[2rem] font-black text-lg uppercase italic shadow-xl">Cargar Stock</button></div><table class="w-full text-left admin-table"><thead><tr><th class="p-6">Insumo</th><th class="p-6 text-center">Stock Real</th><th class="p-6 text-right">Valor</th></tr></thead><tbody id="inventarioTableBody"></tbody></table></div>

            <div id="contabilidadView" class="hidden lg:col-span-3 bg-white p-12 rounded-[4rem] border-[15px] border-white shadow-premium">
                <div class="grid grid-cols-3 gap-8 mb-12"><div class="p-10 bg-green-50 rounded-[3rem] text-center italic shadow-sm"><span class="text-xl font-black uppercase">Ingresos</span><div id="totalIngresosDisplay" class="text-7xl font-black">$0.00</div></div><div class="p-10 bg-red-50 rounded-[3rem] text-center italic shadow-sm"><span class="text-xl font-black uppercase">Egresos</span><div id="totalEgresosDisplay" class="text-7xl font-black">$0.00</div></div><div class="p-10 bg-slate-950 rounded-[3rem] text-center shadow-2xl italic scale-105"><span class="text-xl font-black text-slate-400 uppercase tracking-widest">Utilidad</span><div id="balanceNetoDisplay" class="text-7xl font-black text-white">$0.00</div></div></div>
                <div class="bg-red-50 p-8 rounded-[3rem] mb-12 border-4 border-white shadow-inner flex flex-wrap gap-4 items-center"><input type="text" id="egConcepto" placeholder="DESCRIPCI√ìN GASTO..." class="flex-grow p-6 rounded-[2rem] font-black uppercase text-xl shadow-sm outline-none"><input type="number" id="egMonto" placeholder="0.00" class="w-48 p-6 rounded-[2rem] text-right font-black text-xl"><button onclick="saveManualEgreso()" class="bg-fix-error text-white px-10 py-5 rounded-[2rem] font-black text-xl shadow-xl italic uppercase">üí∏ REGISTRAR GASTO</button></div>
                <table class="w-full text-left admin-table"><thead><tr><th>Fecha</th><th>Tipo</th><th>Concepto</th><th class="text-right">Monto</th><th class="text-right">Acci√≥n</th></tr></thead><tbody id="contabilidadTableBody" class="font-black italic uppercase"></tbody></table>
            </div>

        </div>
    </div>

    <div id="messageBox" class="opacity-0 fixed transition-opacity duration-500 pointer-events-none z-[10000]"></div>

</body>
</html>
