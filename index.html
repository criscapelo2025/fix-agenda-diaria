<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIX - GESTI√ìN</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fix-blue': '#1e3a8a',
                        'fix-light': '#3b82f6',
                        'fix-accent': '#f59e0b',
                        'fix-report': '#059669',
                        'fix-error': '#dc2626'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace']
                    }
                }
            }
        }
    </script>

    <style>
        .currency-input { text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        @media print { .no-print { display: none !important; } }
        
        body.technician-mode .admin-only { display: none !important; }
        body.technician-mode .main-grid { grid-template-columns: 1fr !important; }
        
        .admin-table thead th {
            position: sticky;
            top: 0;
            background: #1e293b;
            color: #ffffff;
            z-index: 10;
            padding: 0.75rem;
            text-transform: uppercase;
            font-size: 0.55rem;
            letter-spacing: 0.05em;
        }

        .rutero-table td {
            font-size: 10px;
            padding: 8px 8px !important;
            text-transform: uppercase;
            font-weight: 700;
            line-height: 1.2;
        }
        .rutero-table th {
            font-size: 9px;
            padding: 8px !important;
            background: #f8fafc;
            color: #64748b;
        }
        
        .row-hover:hover { background-color: #f1f5f9; }
        .detail-row { background-color: #f8fafc; border-left: 8px solid #1e3a8a; }
        html { scroll-behavior: smooth; }

        .report-cell { font-size: 8px; line-height: 1.1; padding: 4px !important; white-space: nowrap; border: 1px solid #e2e8f0; }
        
        .time-badge {
            background: #1e3a8a;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
        }
    </style>
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCiESorKZljYeFHr19c_XPth2qWluz1Dro",
          authDomain: "fix-agenda-app.firebaseapp.com",
          projectId: "fix-agenda-app",
          storageBucket: "fix-agenda-app.firebasestorage.app",
          messagingSenderId: "98719439808",
          appId: "1:98719439808:web:66576c19c8b5233a718625",
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let visitsArray = [];      
        let egresosArray = [];     
        let currentView = 'reporte_admin';
        let currentTechUser = null; 
        let ruteroFilterTech = ""; 

        const LISTA_TECNICOS = ["", "Andres Cardenas", "Cristian Capelo", "Juan Carlos Pando", "Allan Skykaz", "Juana Cardenas"];
        const LUGARES_COMPRA = ["", "COMERCIAL KYWI", "COMERCIAL SOLIS", "COMO HOGAR", "SUKASA", "LUNA PAZMI√ëO", "Macaofertas", "Home Vega", "Mercard", "Teka Directo", "Otro"];
        const TIPOS_SERVICIO = ["Instalaci√≥n", "Garant√≠a", "Fuera de Garant√≠a", "Mantenimiento", "Reparaci√≥n", "Visita T√©cnica"];
        const TIPOS_EQUIPO = ["Cocina Inducci√≥n", "Cocina a Gas", "Horno El√©ctrico", "Horno a Gas", "Campana Tradicional", "Campana Decorativa", "Microondas", "Refrigerador", "Lavavajillas", "Triturador", "Fregadero/Grifer√≠a"];
        const ACCESORIOS_DEFAULT = { 'Enchufe 110V': 5.00, 'Enchufe 220V 20V': 7.00, 'Enchufe 220V 50V': 10.00, 'Manguera c/bridas': 4.00, 'Ducto 4 pulgadas metro': 5.00, 'Enchufe chinito': 5.00 };

        // --- LOG√çSTICA ---
        function getCoords(address) {
            if (!address) return null;
            const regex = /q=(-?\d+\.\d+),(-?\d+\.\d+)/;
            const match = address.match(regex);
            return match ? { lat: parseFloat(match[1]), lng: parseFloat(match[2]) } : null;
        }

        function getDistance(p1, p2) {
            if (!p1 || !p2) return 99999;
            return Math.sqrt(Math.pow(p1.lat - p2.lat, 2) + Math.pow(p1.lng - p2.lng, 2));
        }

        function calculateDuration(numEq) {
            return numEq <= 1 ? 60 : 60 + (numEq - 1) * 30;
        }

        function formatMinutes(totalMin) {
            const h = Math.floor(totalMin / 60);
            const m = totalMin % 60;
            const ampm = h >= 12 ? 'PM' : 'AM';
            const displayH = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            return `${displayH}:${m.toString().padStart(2, '0')} ${ampm}`;
        }

        // --- RENDERIZADO ---
        function renderRutero() {
            const list = document.getElementById('ruteroListBody');
            if(!list) return;
            const filterDate = document.getElementById('filterDateInput').value;
            let techToFilter = currentTechUser || ruteroFilterTech;
            
            let filtered = visitsArray.filter(v => v.fechaInstalacion === filterDate);
            if(techToFilter) filtered = filtered.filter(v => v.tecnico === techToFilter);

            if(filtered.length === 0) {
                list.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-slate-300 italic font-black uppercase">Sin servicios asignados</td></tr>';
                return;
            }

            let currentPos = { lat: -2.900, lng: -79.005 }; 
            let sorted = [];
            let pool = [...filtered];

            while(pool.length > 0) {
                pool.sort((a,b) => getDistance(currentPos, getCoords(a.direccion)) - getDistance(currentPos, getCoords(b.direccion)));
                const next = pool.shift();
                sorted.push(next);
                const nextCoords = getCoords(next.direccion);
                if(nextCoords) currentPos = nextCoords;
            }

            let startTime = 9 * 60; // 09:00 AM

            list.innerHTML = sorted.map(v => {
                const duration = calculateDuration((v.equipos || []).length);
                const timeStr = formatMinutes(startTime);
                startTime += duration + 15; 

                const mapsUrl = v.direccion.includes('http') ? v.direccion : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v.direccion)}`;
                const eqInfo = (v.equipos || []).map(e => `<div class="border-b py-1 last:border-0"><span class="text-fix-blue font-black">${e.descProducto}</span> | COSTO M.O: $${e.costoBase || '0'}</div>`).join('');

                return `
                <tr class="border-b row-hover">
                    <td class="border-r"><span class="time-badge">${timeStr}</span></td>
                    <td class="border-r font-black text-fix-blue cursor-pointer" onclick="toggleDetail('${v.id}')">${v.nombreCliente}</td>
                    <td class="border-r text-slate-400 italic">${v.tecnico || 'S/A'}</td>
                    <td class="border-r text-center font-mono text-fix-accent">${(v.equipos || []).length}</td>
                    <td class="border-r text-center"><a href="${mapsUrl}" target="_blank" onclick="event.stopPropagation();" class="bg-fix-light text-white px-2 py-1 rounded text-[8px] font-black uppercase">üìç MAPA</a></td>
                    <td class="text-center"><a href="tel:${v.telefono}" onclick="event.stopPropagation();" class="bg-slate-100 p-2 rounded inline-block shadow-sm">üìû</a></td>
                </tr>
                <tr id="detail-${v.id}" class="hidden detail-row">
                    <td colspan="6" class="p-4 bg-slate-50">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-[10px] mb-4 uppercase">
                            <div class="space-y-1 font-bold">
                                <p><span class="text-slate-400">C√âDULA:</span> ${v.cedula || 'N/A'}</p>
                                <p><span class="text-slate-400">EMAIL:</span> ${v.email || 'N/A'}</p>
                                <p><span class="text-slate-400">DIRECCI√ìN:</span> ${v.direccion}</p>
                            </div>
                            <div class="bg-white p-3 rounded-xl border-2 border-fix-blue/10 shadow-sm">
                                <p class="text-fix-blue mb-2 text-center border-b pb-1 font-black text-[9px] uppercase italic">Reporte de Servicio</p>
                                <div class="grid grid-cols-2 gap-2 mb-3">
                                    <select id="status_${v.id}" class="p-2 bg-slate-50 rounded font-black text-xs border-none shadow-inner"><option value="PENDIENTE">¬øATENDI√ì?</option><option value="SI" ${v.estado === 'Atendido' ? 'selected' : ''}>S√ç</option><option value="NO" ${v.estado === 'No Atendido' ? 'selected' : ''}>NO</option></select>
                                    <select id="type_${v.id}" class="p-2 bg-slate-50 rounded font-black text-xs border-none shadow-inner">${TIPOS_SERVICIO.map(t => `<option value="${t}" ${v.tipoAtencion === t ? 'selected' : ''}>${t}</option>`).join('')}</select>
                                </div>
                                <div class="grid grid-cols-2 gap-1 mb-3">
                                    ${Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => `<div class="flex items-center justify-between p-1 bg-slate-50 rounded border border-white"><span class="text-[8px] uppercase font-black text-slate-400">${n}</span><input type="number" min="0" value="0" data-name="${n}" data-price="${p}" class="acc-${v.id} w-8 text-center text-[9px] font-black rounded border-none shadow-inner outline-none"></div>`).join('')}
                                </div>
                                <textarea id="reason_${v.id}" placeholder="Observaciones..." class="w-full bg-slate-50 p-2 rounded text-[9px] mb-2 uppercase h-12 shadow-inner border-none outline-none font-bold">${v.razonNoAtencion || ''}</textarea>
                                <button onclick="closeVisitByTech('${v.id}')" class="w-full bg-fix-report text-white font-black py-2 rounded text-xs uppercase shadow active:scale-95 transition-all">üíæ GUARDAR REPORTE</button>
                            </div>
                        </div>
                        <div class="bg-white p-3 rounded shadow-inner text-[9px] font-bold uppercase">
                            <p class="text-slate-400 border-b mb-1 italic">Equipos registrados en este servicio:</p>
                            ${eqInfo}
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        // --- CORE ADMIN ---
        window.toggleDetail = (id) => document.getElementById(`detail-${id}`)?.classList.toggle('hidden');

        window.calculateFinancials = () => {
            let moTotalVal = 0; document.querySelectorAll('input[name^="costoEquipo_"]').forEach(i => moTotalVal += parseFloat(i.value) || 0);
            let accTotalVal = 0; document.querySelectorAll('.form-acc-qty').forEach(i => accTotalVal += (parseInt(i.value) || 0) * (parseFloat(i.dataset.price) || 0));
            document.getElementById('displayCostoInstalacion').textContent = `$${moTotalVal.toFixed(2)}`;
            document.getElementById('displayTotalAccesorios').textContent = `$${accTotalVal.toFixed(2)}`;
            document.getElementById('displayTotalFinal').textContent = `$${(moTotalVal + accTotalVal).toFixed(2)}`;
        };

        window.saveVisit = () => {
            const form = document.getElementById('visitForm');
            const data = Object.fromEntries(new FormData(form));
            const eqs = []; const numEq = parseInt(data.numEquipos) || 1;
            for(let i=1; i<=numEq; i++) eqs.push({ descProducto: data[`descProducto_${i}`], codProducto: "", serieEquipo: "", costoBase: parseFloat(data[`costoEquipo_${i}`]) || 0 });
            const ref = database.ref('visits').push();
            ref.set({ id: ref.key, nombreCliente: data.nombreCliente.toUpperCase(), cedula: data.cedula || '', email: data.email || '', telefono: data.telefono || '', direccion: data.direccion, fechaInstalacion: data.fechaInstalacion, fechaEmision: data.fechaEmision || data.fechaInstalacion, lugarCompra: data.lugarCompra || '', tecnico: data.tecnico || '', tipoAtencion: data.tipoAtencion, estado: 'PENDIENTE', createdAt: Date.now(), equipos: eqs, financiera: { totalCliente: parseFloat(document.getElementById('displayTotalFinal').textContent.replace('$','')), formaPago: 'PENDIENTE' } })
            .then(() => { showMessage("‚úÖ Agendado", "fix-report"); form.reset(); expandEquipmentUI(); renderInsumosAdmin(); });
        };

        window.closeVisitByTech = (id) => {
            const s = document.getElementById(`status_${id}`).value;
            const t = document.getElementById(`type_${id}`).value;
            const r = document.getElementById(`reason_${id}`).value;
            const accs = []; let totalAccs = 0;
            document.querySelectorAll(`.acc-${id}`).forEach(i => {
                const q = parseInt(i.value) || 0;
                if(q > 0) { const p = parseFloat(i.dataset.price); accs.push({ nombre: i.dataset.name, cantidad: q, precio: p }); totalAccs += q * p; }
            });
            if(s === 'PENDIENTE') return showMessage("‚ö†Ô∏è Seleccione estado", "fix-accent");
            const visit = visitsArray.find(v => v.id === id);
            const mo = (visit.equipos || []).reduce((acc, eq) => acc + (eq.costoBase || 0), 0);
            database.ref('visits/' + id).update({ estado: s === 'SI' ? 'Atendido' : 'No Atendido', tipoAtencion: t, razonNoAtencion: r, accesoriosVendidos: accs, attendedDate: new Date().toISOString(), 'financiera/totalCliente': (mo + totalAccs) })
            .then(() => showMessage("‚úÖ Guardado", "fix-report"));
        };

        window.saveAdminEq = (id) => {
            const visit = visitsArray.find(v => v.id === id);
            if(!visit) return;
            const newEqs = visit.equipos.map((e, i) => ({
                ...e,
                codProducto: document.getElementById(`admin_cod_${id}_${i}`).value.toUpperCase(),
                serieEquipo: document.getElementById(`admin_ser_${id}_${i}`).value.toUpperCase()
            }));
            database.ref('visits/' + id).update({ equipos: newEqs }).then(() => showMessage("‚úÖ Actualizado", "fix-report"));
        };

        window.deleteVisit = (id) => { if(confirm("¬øEliminar?")) database.ref('visits/' + id).remove().then(() => showMessage("üóëÔ∏è Borrado", "fix-error")); };

        window.saveManualEgreso = () => {
            const c = document.getElementById('egConcepto').value;
            const m = parseFloat(document.getElementById('egMonto').value);
            if(!c || !m) return;
            const ref = database.ref('egresos').push();
            ref.set({ id: ref.key, concepto: c.toUpperCase(), monto: m, fecha: Date.now(), type: 'EGRESO' })
            .then(() => { document.getElementById('egConcepto').value = ''; document.getElementById('egMonto').value = ''; showMessage("‚úÖ Gasto registrado", "fix-report"); });
        };

        // --- NAVEGACI√ìN CORREGIDA ---
        window.changeMasterView = (view) => {
            currentView = view;
            const panels = ['formContainer', 'contabilidadView', 'reporteTekaView', 'agendaContainer', 'ruteroView'];
            panels.forEach(p => document.getElementById(p)?.classList.add('hidden'));
            
            // L√≥gica de visualizaci√≥n din√°mica
            if(view === 'reporte_admin') {
                document.getElementById('formContainer')?.classList.remove('hidden');
                document.getElementById('agendaContainer')?.classList.remove('hidden');
            } else if(view === 'agenda_view') {
                document.getElementById('agendaContainer')?.classList.remove('hidden');
            } else if(view === 'reporte_teka') {
                document.getElementById('reporteTekaView')?.classList.remove('hidden');
                renderReporteTeka();
            } else {
                document.getElementById(view + 'View')?.classList.remove('hidden');
            }

            if(view === 'rutero') renderRutero();
            if(view === 'contabilidad') processFinancialBalance();
            
            // Estilo de botones activos
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-fix-blue', 'text-white');
                btn.classList.add('bg-gray-100', 'text-gray-500');
            });
            const activeBtn = document.querySelector(`[onclick*="'${view}'"]`);
            if(activeBtn) {
                activeBtn.classList.add('bg-fix-blue', 'text-white');
                activeBtn.classList.remove('bg-gray-100', 'text-gray-500');
            }
        };

        function startSync() {
            database.ref('visits').on('value', snap => {
                const data = snap.val();
                visitsArray = data ? Object.entries(data).map(([id, val]) => ({...val, id})) : [];
                renderUIAgenda(); 
                if(currentView === 'rutero') renderRutero();
                if(currentView === 'reporte_teka') renderReporteTeka();
                if(currentView === 'contabilidad') processFinancialBalance();
            });
            database.ref('egresos').on('value', snap => { 
                const data = snap.val();
                egresosArray = data ? Object.entries(data).map(([id, val]) => ({...val, id})) : []; 
                if(currentView === 'contabilidad') processFinancialBalance(); 
            });
        }

        function renderUIAgenda() {
            const list = document.getElementById('visitsList');
            if(!list) return;
            const df = document.getElementById('filterDateInput').value;
            let filtered = visitsArray.filter(v => v.fechaInstalacion === df);
            list.innerHTML = filtered.map(v => `
                <div class="bg-white p-4 rounded-3xl shadow-md border-l-[10px] ${v.estado === 'Atendido' ? 'border-fix-report' : 'border-fix-accent'} mb-4">
                    <div class="flex justify-between items-start mb-2">
                        <p class="font-black text-fix-blue text-sm uppercase italic tracking-tighter">${v.nombreCliente}</p>
                        <button onclick="deleteVisit('${v.id}')" class="text-fix-error text-[10px] uppercase font-black">üóëÔ∏è Borrar</button>
                    </div>
                    <div class="space-y-2 mt-2">
                        ${(v.equipos || []).map((e, i) => `
                            <div class="bg-slate-50 p-2 rounded grid grid-cols-2 gap-2 border border-white">
                                <p class="col-span-2 text-[8px] font-black text-slate-400 uppercase italic">${e.descProducto}</p>
                                <input type="text" id="admin_cod_${v.id}_${i}" value="${e.codProducto || ''}" placeholder="C√ìDIGO" class="p-1 text-[8px] font-bold uppercase rounded border-none shadow-inner outline-none">
                                <input type="text" id="admin_ser_${v.id}_${i}" value="${e.serieEquipo || ''}" placeholder="SERIE" class="p-1 text-[8px] font-bold uppercase rounded border-none shadow-inner outline-none">
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="saveAdminEq('${v.id}')" class="w-full mt-2 bg-fix-blue text-white text-[8px] py-1 rounded font-black uppercase shadow-md active:scale-95 transition-transform">Guardar Datos Admin</button>
                </div>`).join('');
        }

        window.expandEquipmentUI = () => {
            const count = parseInt(document.getElementById('numEquipos').value) || 1;
            const container = document.getElementById('productInputsContainer');
            if(!container) return; container.innerHTML = '';
            for(let i=1; i<=count; i++) {
                container.innerHTML += `
                    <div class="p-4 bg-slate-50 rounded-2xl border-2 border-white mb-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                        <select name="descProducto_${i}" class="p-2 bg-white rounded font-bold text-xs border-none shadow-sm outline-none" required><option value="">ELEGIR EQUIPO...</option>${TIPOS_EQUIPO.map(t => `<option value="${t}">${t}</option>`).join('')}</select>
                        <input type="number" name="costoEquipo_${i}" step="0.01" value="25.00" oninput="calculateFinancials()" class="p-2 bg-yellow-50 rounded font-black text-right text-fix-blue border-none shadow-inner outline-none">
                    </div>`;
            }
            calculateFinancials();
        };

        window.renderInsumosAdmin = function() {
            const container = document.getElementById('accesoriosContainerAdmin');
            if(!container) return;
            container.innerHTML = Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => `<div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 shadow-sm"><span class="text-[9px] font-black text-slate-400 uppercase">${n}</span><input type="number" min="0" value="0" data-price="${p}" data-name="${n}" oninput="calculateFinancials()" class="form-acc-qty w-10 text-center bg-slate-50 rounded p-1 text-xs font-black outline-none border-none shadow-inner"></div>`).join('');
        };

        function processFinancialBalance() {
            const ingresos = visitsArray.filter(v => v.estado === 'Atendido' && v.financiera).map(v => ({ id: v.id, monto: v.financiera.totalCliente, type: 'INGRESO', concepto: `VENTA: ${v.nombreCliente}`, fecha: v.attendedDate ? new Date(v.attendedDate).getTime() : v.createdAt }));
            const egres = egresosArray.map(e => ({ id: e.id, monto: e.monto, type: 'EGRESO', concepto: e.concepto, fecha: e.fecha }));
            const todos = [...ingresos, ...egres].sort((a,b) => b.fecha - a.fecha);
            const tb = document.getElementById('contabilidadTableBody');
            if(tb) {
                tb.innerHTML = todos.map(m => `
                    <tr class="border-b row-hover"><td class="p-4 text-[9px] font-black italic">${new Date(m.fecha).toLocaleDateString()}</td><td class="p-4 text-[9px] uppercase font-bold tracking-tight">${m.concepto}</td><td class="p-4 text-right text-[10px] font-black italic">$${m.monto.toFixed(2)}</td><td class="text-center p-4">${m.type === 'EGRESO' ? `<button onclick="database.ref('egresos').child('${m.id}').remove()" class="text-fix-error">üóëÔ∏è</button>` : ''}</td></tr>`).join('');
            }
            
            let tIn = 0, tOut = 0;
            todos.forEach(m => m.type === 'INGRESO' ? tIn += m.monto : tOut += m.monto);
            document.getElementById('totalIngresosDisplay').textContent = `$${tIn.toFixed(2)}`;
            document.getElementById('totalEgresosDisplay').textContent = `$${tOut.toFixed(2)}`;
            document.getElementById('balanceNetoDisplay').textContent = `$${(tIn - tOut).toFixed(2)}`;
        }

        window.downloadCSV = (type) => {
            let data = [];
            if(type === 'teka') {
                data = visitsArray.flatMap(v => (v.equipos || []).map(eq => ({ "FECHA COMPRA": v.fechaEmision || "", "LUGAR": v.lugarCompra || "", "FACTURA": "", "C√ìDIGO": eq.codProducto || "", "DESCRIPCI√ìN": eq.descProducto || "", "SERIE": eq.serieEquipo || "", "GARANT√çA": "SAP", "T√âCNICO": "capelo", "CIUDAD": "Cuenca", "FECHA ATENCI√ìN": v.attendedDate ? new Date(v.attendedDate).toLocaleDateString() : v.fechaInstalacion, "NOMBRE CLIENTE": v.nombreCliente || "", "DIRECCI√ìN": v.direccion || "", "CELULAR": v.telefono || "", "PRECIO": (eq.costoBase || 0).toFixed(2), "ORIGEN": "cliente final", "T√âCNICO QUE ATENDI√ì": "capelo", "VI√ÅTICO": "", "FACTURA2": "", "C√âDULA": v.cedula || "", "CORREO": v.email || "" })));
            }
            if(data.length === 0) return;
            const headers = Object.keys(data[0]).join(",");
            const rows = data.map(obj => Object.values(obj).join(",")).join("\n");
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + headers + "\n" + rows)); link.setAttribute("download", "Reporte_FIX_Oficial.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        function renderReporteTeka() {
            const body = document.getElementById('tekaReporteBody');
            if(!body) return;
            body.innerHTML = visitsArray.flatMap(v => (v.equipos || []).map(eq => `
                <tr class="border-b row-hover">
                    <td class="border report-cell font-bold">${v.fechaEmision || ''}</td><td class="border report-cell">${v.lugarCompra || ''}</td><td class="border report-cell"></td><td class="border report-cell">${eq.codProducto || ''}</td><td class="border report-cell font-black uppercase text-fix-blue tracking-tighter">${eq.descProducto || ''}</td><td class="border report-cell">${eq.serieEquipo || ''}</td><td class="border report-cell font-black">SAP</td><td class="border report-cell">capelo</td><td class="border report-cell font-black">Cuenca</td><td class="border report-cell font-black">${v.fechaInstalacion}</td><td class="border report-cell font-black uppercase italic">${v.nombreCliente || ''}</td><td class="border report-cell text-[6px] break-words max-w-[80px]">${v.direccion || ''}</td><td class="border report-cell">${v.telefono || ''}</td><td class="border report-cell font-black text-right">$${(eq.costoBase || 0).toFixed(2)}</td><td class="border report-cell">cliente final</td><td class="border report-cell">capelo</td><td class="border report-cell"></td><td class="border report-cell"></td><td class="border report-cell font-black">${v.cedula || ''}</td><td class="border report-cell">${v.email || ''}</td>
                </tr>`)).join('');
        }

        function showMessage(msg, color) {
            const box = document.getElementById('messageBox'); if(!box) return;
            box.textContent = msg; box.style.opacity = '1';
            box.className = `fixed bottom-32 left-1/2 -translate-x-1/2 p-10 rounded-full shadow-premium text-white font-black uppercase text-xs bg-${color} z-[9999] transition-opacity duration-500`;
            setTimeout(() => { box.style.opacity = '0'; }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('filterDateInput').value = hoy;
            document.getElementById('inputEmision').value = hoy;
            const params = new URLSearchParams(window.location.search);
            const tech = params.get('tech');
            if(tech && LISTA_TECNICOS.includes(tech)) {
                currentTechUser = tech; document.body.classList.add('technician-mode');
                document.getElementById('userDisplayLabel').textContent = "RUTA: " + tech.toUpperCase();
                changeMasterView('rutero'); 
            } else { document.getElementById('userDisplayLabel').textContent = "ADMIN CENTRAL FIX"; }
            startSync();
            LISTA_TECNICOS.forEach(t => document.getElementById('selectTecnico').add(new Option(t || "--- T√âCNICO ---", t)));
            LUGARES_COMPRA.forEach(l => {
                const s = document.getElementById('selectLugar');
                if(s) s.add(new Option(l || "--- LUGAR COMPRA ---", l));
            });
            LISTA_TECNICOS.forEach(t => {
                const s = document.getElementById('ruteroTechFilter');
                if(s) s.add(new Option(t || "TODOS LOS T√âCNICOS", t));
            });
            renderInsumosAdmin(); expandEquipmentUI();
        });
    </script>
</head>

<body class="bg-slate-100 min-h-screen p-4 md:p-10 font-sans selection:bg-fix-blue selection:text-white">

    <div class="max-w-[2800px] mx-auto">
        
        <header class="mb-14 flex flex-col xl:flex-row justify-between items-center gap-10 no-print">
            <div class="flex items-center">
                <div class="bg-fix-blue p-8 rounded-[1.5rem] shadow-premium mr-10"><span class="text-7xl font-black text-white italic tracking-tighter">FIX</span></div>
                <div><h1 class="text-6xl font-black uppercase italic text-slate-800 tracking-tighter leading-none">Gesti√≥n</h1><span id="userDisplayLabel" class="text-xs font-black text-slate-400 uppercase italic tracking-[0.2em]">Cargando...</span></div>
            </div>
            <nav id="adminNav" class="flex flex-wrap justify-center bg-white p-3 rounded-full shadow-premium border-[6px] border-slate-50 gap-4 admin-only">
                <button onclick="changeMasterView('reporte_admin')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-fix-blue text-white italic">Registro</button>
                <button onclick="changeMasterView('rutero')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-gray-100 text-gray-500 italic">Log√≠stica</button>
                <button onclick="changeMasterView('reporte_teka')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-gray-100 text-gray-500 italic">Maestro</button>
                <button onclick="changeMasterView('contabilidad')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-gray-100 text-gray-500 italic">Caja</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 main-grid">
            
            <div id="formContainer" class="lg:col-span-2 space-y-10 admin-only no-print">
                <div class="bg-white p-8 rounded-[3rem] shadow-premium border-[8px] border-white">
                    <span class="text-[10px] font-black uppercase text-slate-400 mb-2 ml-4 block italic">Fecha del Trabajo Actual</span>
                    <input type="date" id="filterDateInput" onchange="renderUIAgenda(); renderRutero();" class="bg-slate-50 p-4 rounded-2xl text-3xl font-black italic text-fix-blue outline-none border-none shadow-inner w-full">
                </div>

                <div class="bg-white p-10 rounded-[5rem] shadow-premium border-[15px] border-slate-50">
                    <form id="visitForm" onsubmit="event.preventDefault(); saveVisit();">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 tracking-tighter">
                            <input type="text" name="nombreCliente" placeholder="NOMBRE COMPLETO*" required class="p-6 bg-slate-50 rounded-2xl font-black text-xl uppercase shadow-inner outline-none">
                            <input type="text" name="cedula" placeholder="C√âDULA / RUC*" class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner outline-none">
                            <input type="tel" name="telefono" placeholder="TEL√âFONO*" class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner outline-none">
                            <input type="text" name="direccion" placeholder="ENLACE GOOGLE MAPS (Coordenadas)*" required class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner outline-none">
                            <select name="tecnico" id="selectTecnico" class="p-6 bg-slate-50 rounded-2xl font-black text-lg outline-none"></select>
                            <select id="selectLugar" name="lugarCompra" class="p-6 bg-slate-50 rounded-2xl font-black text-lg outline-none"></select>
                            <div class="flex flex-col"><span class="text-[9px] font-black text-slate-300 ml-2 uppercase">Emisi√≥n Factura</span><input type="date" name="fechaEmision" id="inputEmision" required class="p-6 bg-slate-50 rounded-2xl font-black text-xl outline-none shadow-inner"></div>
                            <div class="bg-slate-50 p-6 rounded-2xl flex items-center justify-between shadow-inner font-black italic text-slate-300 uppercase">Equipos: <input type="number" id="numEquipos" name="numEquipos" value="1" min="1" oninput="expandEquipmentUI()" class="w-16 text-center text-4xl text-fix-blue bg-transparent outline-none"></div>
                            <input type="hidden" name="fechaInstalacion" id="inputFecha">
                        </div>
                        <div id="productInputsContainer" class="space-y-4"></div>
                        <div id="accesoriosContainerAdmin" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>
                        <div class="mt-10 grid grid-cols-3 gap-4 text-center">
                            <div class="bg-slate-50 p-6 rounded-3xl shadow-inner font-black italic uppercase text-[8px] tracking-widest text-slate-400">M.O.<br><span id="displayCostoInstalacion" class="text-3xl text-fix-blue">$0.00</span></div>
                            <div class="bg-slate-50 p-6 rounded-3xl shadow-inner font-black italic uppercase text-[8px] tracking-widest text-slate-400">Insumos<br><span id="displayTotalAccesorios" class="text-3xl text-fix-blue">$0.00</span></div>
                            <div class="bg-fix-accent p-6 rounded-3xl shadow-2xl font-black italic uppercase text-[8px] tracking-widest text-white scale-105">Total Final<br><span id="displayTotalFinal" class="text-4xl">$0.00</span></div>
                        </div>
                        <button type="submit" class="w-full bg-fix-blue text-white py-8 rounded-[4rem] mt-10 text-3xl font-black uppercase italic shadow-xl tracking-tighter" onclick="document.getElementById('inputFecha').value = document.getElementById('filterDateInput').value">üöÄ AGENDAR VISITA</button>
                    </form>
                </div>
            </div>

            <div id="agendaContainer" class="lg:col-span-1 admin-only"><h2 class="text-3xl font-black uppercase italic mb-6 border-b-[6px] border-fix-blue text-slate-800 tracking-tighter">Completar Datos</h2><div id="visitsList" class="space-y-4"></div></div>

            <!-- RUTERO LOG√çSTICO -->
            <div id="ruteroView" class="hidden lg:col-span-3 bg-white p-8 rounded-[4rem] shadow-premium">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                    <h2 class="text-5xl font-black uppercase italic text-slate-800 underline decoration-4 decoration-fix-blue tracking-tighter">Hoja de Ruta Optimizada</h2>
                    <select id="ruteroTechFilter" onchange="updateRuteroFilter(this.value)" class="p-4 bg-slate-100 rounded-2xl font-black text-sm admin-only shadow-inner text-fix-blue outline-none border-none"></select>
                </div>
                <div class="overflow-x-auto w-full border-4 border-slate-50 rounded-[2.5rem] shadow-inner">
                    <table class="w-full border-collapse rutero-table">
                        <thead><tr><th class="border-r">Hora</th><th class="border-r text-left">Cliente (Anotar)</th><th class="border-r">T√©cnico</th><th class="border-r text-center">Eq.</th><th class="border-r text-center">GPS</th><th class="text-center">Tel.</th></tr></thead>
                        <tbody id="ruteroListBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- MAESTRO -->
            <div id="reporteTekaView" class="hidden lg:col-span-3 bg-white p-6 rounded-[3rem] shadow-premium overflow-hidden">
                <div class="flex justify-between items-center mb-6"><h2 class="text-3xl font-black uppercase italic underline decoration-4 tracking-tighter">Reporte Maestro</h2><button onclick="downloadCSV('teka')" class="bg-fix-report text-white px-8 py-3 rounded-full font-black text-xs shadow-xl uppercase italic">üìä Descargar Excel Oficial</button></div>
                <div class="overflow-x-auto w-full"><table class="w-full border-collapse admin-table"><thead><tr class="bg-slate-950 text-white font-black text-[7px] uppercase"><th>Compra</th><th>Lugar</th><th>Factura</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Serie</th><th>Garant√≠a</th><th>T√©cnico</th><th>Ciudad</th><th>Atenci√≥n</th><th>Cliente</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Precio</th><th>Origen</th><th>Atendi√≥</th><th>Vi√°tico</th><th>F2</th><th>C√©dula</th><th>Email</th></tr></thead><tbody id="tekaReporteBody"></tbody></table></div>
            </div>

            <!-- CAJA -->
            <div id="contabilidadView" class="hidden lg:col-span-3 bg-white p-10 rounded-[4rem] shadow-premium">
                <div class="grid grid-cols-3 gap-6 mb-10 text-center uppercase italic font-black">
                    <div class="p-6 bg-green-50 rounded-3xl shadow-inner"><span class="text-xs text-green-900">Ingresos</span><div id="totalIngresosDisplay" class="text-6xl font-black text-green-950">$0.00</div></div>
                    <div class="p-6 bg-red-50 rounded-3xl shadow-inner"><span class="text-xs text-red-900">Egresos</span><div id="totalEgresosDisplay" class="text-6xl font-black text-red-950">$0.00</div></div>
                    <div class="p-6 bg-slate-950 rounded-3xl shadow-2xl scale-105"><span class="text-xs text-slate-400">Balance</span><div id="balanceNetoDisplay" class="text-6xl text-white">$0.00</div></div>
                </div>
                <div class="bg-red-50 p-6 rounded-3xl mb-8 border-4 border-white shadow-inner flex flex-wrap gap-4 items-center"><input type="text" id="egConcepto" placeholder="DESCRIPCI√ìN DEL GASTO..." class="flex-grow p-4 rounded-xl font-black uppercase outline-none shadow-sm"><input type="number" id="egMonto" placeholder="0.00" class="w-32 p-4 rounded-xl text-right font-black border-none"><button onclick="saveManualEgreso()" class="bg-fix-error text-white px-8 py-4 rounded-xl font-black italic shadow-lg uppercase text-xs">üí∏ Registrar Gasto</button></div>
                <table class="w-full text-left admin-table"><thead><tr><th class="p-4">Fecha</th><th class="p-4">Concepto</th><th class="p-4 text-right">Monto</th><th class="p-4 text-center">Acci√≥n</th></tr></thead><tbody id="contabilidadTableBody" class="font-black italic uppercase"></tbody></table>
            </div>

        </div>
    </div>

    <div id="messageBox" class="opacity-0 fixed transition-opacity duration-500 pointer-events-none z-[10000]"></div>

</body>
</html>
