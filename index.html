<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIX - GESTI√ìN</title>
    
    <!-- CONFIGURACI√ìN DE APLICACI√ìN (PWA) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FIX GESTI√ìN">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- ICONO DE LA APP -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231e3a8a'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial Black' font-size='40' fill='white' font-style='italic'>FIX</text></svg>">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%231e3a8a'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial Black' font-size='40' fill='white' font-style='italic'>FIX</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fix-blue': '#1e3a8a',
                        'fix-light': '#3b82f6',
                        'fix-accent': '#f59e0b',
                        'fix-report': '#059669',
                        'fix-error': '#dc2626'
                    }
                }
            }
        }
    </script>

    <style>
        .currency-input { text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        @media print { .no-print { display: none !important; } }
        
        body.technician-mode .admin-only { display: none !important; }
        body.technician-mode header { padding: 0.5rem !important; }
        .admin-table thead th { position: sticky; top: 0; background: #1e293b; color: white; z-index: 10; padding: 0.75rem; text-transform: uppercase; font-size: 0.55rem; border: 1px solid #334155; }
        .rutero-table td { font-size: 10px; padding: 8px; text-transform: uppercase; font-weight: 700; }
        .detail-row { background-color: #f8fafc; border-left: 15px solid #1e3a8a; }

        .btn-refresh-float {
            position: fixed; bottom: 2rem; right: 2rem; z-index: 1000;
            width: 4rem; height: 4rem; border-radius: 50%;
            background: #1e3a8a; color: white; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .btn-refresh-float:active { transform: scale(0.9) rotate(180deg); }
        .version-badge { background: #fbbf24; color: #1e3a8a; padding: 2px 10px; border-radius: 8px; font-weight: 900; font-size: 12px; margin-top: 6px; display: inline-block; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal-overlay { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .report-cell { font-size: 9px; padding: 4px !important; border: 1px solid #e2e8f0; white-space: nowrap; font-weight: 700; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyCiESorKZljYeFHr19c_XPth2qWluz1Dro",
          authDomain: "fix-agenda-app.firebaseapp.com",
          projectId: "fix-agenda-app",
          storageBucket: "fix-agenda-app.firebasestorage.app",
          messagingSenderId: "98719439808",
          appId: "1:98719439808:web:66576c19c8b5233a718625",
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- CATALOGS ---
        const LISTA_TECNICOS = ["", "Andres Cardenas", "Cristian Capelo", "Juan Carlos Pando", "Allan Skykaz", "Juana Cardenas"];
        const LUGARES_COMPRA = ["", "COMERCIAL KYWI", "COMERCIAL SOLIS", "COMO HOGAR", "SUKASA", "LUNA PAZMI√ëO", "MACAOFERTAS", "HOME VEGA", "MERCARD", "TEKA DIRECTO", "OTRO"];
        const TIPOS_SERVICIO = ["Instalaci√≥n", "Garant√≠a", "Fuera de Garant√≠a", "Mantenimiento", "Reparaci√≥n", "Visita T√©cnica"];
        const TIPOS_EQUIPO = ["Cocina Inducci√≥n", "Cocina a Gas", "Horno El√©ctrico", "Horno a Gas", "Campana Tradicional", "Campana Decorativa", "Microondas", "Refrigerador", "Lavavajillas", "Triturador", "Fregadero/Grifer√≠a"];
        const ACCESORIOS_DEFAULT = { 'Enchufe 110V': 5.00, 'Enchufe 220V 20V': 7.00, 'Enchufe 220V 50V': 10.00, 'Manguera c/bridas': 4.00, 'Ducto 4 pulgadas metro': 5.00, 'Enchufe chinito': 5.00, 'Segunda visita': 12.00, 'Visita fuera de garant√≠a': 20.00 };

        // --- GLOBAL STATE ---
        let visitsArray = [];      
        let movementsArray = [];     
        let currentView = 'reporte_admin';
        let currentTechUser = null; 

        // --- CORE FUNCTIONS ---

        function showMessage(msg, colorClass) {
            const box = document.getElementById('messageBox');
            if(!box) return;
            box.textContent = msg; box.style.opacity = '1';
            box.className = `fixed bottom-32 left-1/2 -translate-x-1/2 p-6 rounded-full shadow-premium text-white font-black uppercase text-xs z-[9999] transition-opacity duration-500 bg-${colorClass}`;
            setTimeout(() => { if(box) box.style.opacity = '0'; }, 3000);
        }

        function calculateFinancials() {
            let mo = 0; document.querySelectorAll('input[name^="costoEquipo_"]').forEach(i => mo += parseFloat(i.value) || 0);
            let acc = 0; document.querySelectorAll('.form-acc-qty').forEach(i => acc += (parseInt(i.value) || 0) * (parseFloat(i.dataset.price) || 0));
            const cI = document.getElementById('displayCostoInstalacion'), cA = document.getElementById('displayTotalAccesorios'), cT = document.getElementById('displayTotalFinal');
            if(cI) cI.textContent = `$${mo.toFixed(2)}`; if(cA) cA.textContent = `$${acc.toFixed(2)}`; if(cT) cT.textContent = `$${(mo + acc).toFixed(2)}`;
        }

        function expandEquipmentUI() {
            const c = parseInt(document.getElementById('numEquipos').value) || 1;
            let p = 25.00; if (c === 2) p = 20.00; else if (c >= 3) p = 15.00;
            const container = document.getElementById('productInputsContainer'); if(!container) return; container.innerHTML = '';
            for(let i=1; i<=c; i++) container.innerHTML += `<div class="p-4 bg-slate-50 rounded-2xl border-2 border-white mb-2 grid grid-cols-1 md:grid-cols-2 gap-2"><select name="descProducto_${i}" class="p-2 bg-white rounded font-bold text-xs shadow-sm outline-none uppercase" required><option value="">ELEGIR EQUIPO...</option>${TIPOS_EQUIPO.map(t => `<option value="${t}">${t}</option>`).join('')}</select><input type="number" name="costoEquipo_${i}" step="0.01" value="${p.toFixed(2)}" oninput="calculateFinancials()" class="p-2 bg-yellow-50 rounded font-black text-right text-fix-blue border-none shadow-inner outline-none"></div>`;
            calculateFinancials();
        }

        function renderInsumosAdmin() {
            const container = document.getElementById('accesoriosContainerAdmin'); if(!container) return;
            container.innerHTML = Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => `<div class="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-100 shadow-sm"><span class="text-[9px] font-black text-slate-400 uppercase">${n}</span><input type="number" min="0" value="0" data-price="${p}" data-name="${n}" oninput="calculateFinancials()" class="form-acc-qty w-10 text-center bg-slate-50 rounded p-1 text-xs font-black outline-none border-none shadow-inner"></div>`).join('');
        }

        function refreshData() {
            showMessage("üîÑ Sincronizando...", "fix-blue");
            database.ref('visits').once('value', () => {
                renderUIAgenda(); renderRutero(); processFinancialBalance();
                if(currentView === 'reporte_teka') renderReporteTeka();
                showMessage("‚úÖ Actualizado", "fix-report");
            });
        }

        function syncDates(sourceId) {
            const val = document.getElementById(sourceId).value;
            const fA = document.getElementById('filterDateInput'), fR = document.getElementById('filterDateInputRutero');
            if(fA) fA.value = val; if(fR) fR.value = val;
            renderUIAgenda(); renderRutero();
        }

        // --- FUNCI√ìN MEJORADA DE ENV√çO DE ORDEN POR WHATSAPP ---
        function sendServiceOrder(id) {
            const v = visitsArray.find(item => item.id === id);
            if(!v || !v.telefono) return showMessage("‚ö†Ô∏è Tel√©fono inv√°lido", "fix-error");
            
            const cleanNum = v.telefono.replace(/\D/g, '');
            const finalNum = cleanNum.startsWith('593') ? cleanNum : '593' + (cleanNum.startsWith('0') ? cleanNum.substring(1) : cleanNum);
            
            // Construcci√≥n del Resumen de Equipos
            const eqList = (v.equipos || []).map(e => `‚Ä¢ ${e.descProducto}${e.serieEquipo ? ' (S/N: '+e.serieEquipo+')' : ''}`).join('\n');
            
            const msg = `*FIX GESTI√ìN T√âCNICA - RESUMEN DE SERVICIO*\n\n` +
                        `¬°Hola *${v.nombreCliente.split(' ')[0]}*! Gracias por confiar en nuestro equipo t√©cnico.\n\n` +
                        `*DETALLES DE ATENCI√ìN:*\n` +
                        `‚úÖ Tipo: ${v.tipoAtencion || 'Servicio T√©cnico'}\n` +
                        `üìÖ Fecha: ${v.fechaInstalacion}\n` +
                        `üõ†Ô∏è Equipos atendidos:\n${eqList}\n\n` +
                        `*ENCUESTA DE SATISFACCI√ìN:* ‚≠ê\n` +
                        `¬øC√≥mo calificar√≠as nuestra atenci√≥n hoy? Por favor, dinos si todo qued√≥ operativo.\n\n` +
                        `*RECORDATORIO FIX:* üí°\n` +
                        `Te recordamos que tu mantenimiento preventivo sugerido es en *6 MESES*. ¬øDeseas que te contactemos autom√°ticamente para agendarlo? (Responde S√ç o NO).\n\n` +
                        `¬°Que tengas un excelente d√≠a! üõ†Ô∏è`;
            
            window.open(`https://wa.me/${finalNum}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function changeMasterView(view) {
            currentView = view;
            const sections = ['formContainer', 'contabilidadView', 'reporteTekaView', 'agendaContainer', 'ruteroView', 'mantenimientoView'];
            sections.forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
            if(view === 'reporte_admin') { document.getElementById('formContainer')?.classList.remove('hidden'); document.getElementById('agendaContainer')?.classList.remove('hidden'); }
            else if(view === 'reporte_teka') { document.getElementById('reporteTekaView')?.classList.remove('hidden'); renderReporteTeka(); }
            else { const el = document.getElementById(view + 'View'); if(el) el.classList.remove('hidden'); }
            if(view === 'rutero') renderRutero();
            if(view === 'contabilidad') processFinancialBalance();
            document.querySelectorAll('.view-btn').forEach(btn => { btn.classList.remove('bg-fix-blue', 'text-white'); btn.classList.add('bg-gray-100', 'text-gray-500'); });
            const act = document.querySelector(`[onclick*="'${view}'"]`);
            if(act) { act.classList.add('bg-fix-blue', 'text-white'); act.classList.remove('bg-gray-100', 'text-gray-500'); }
        }

        function getCoords(address) { if (!address) return null; const regex = /q=(-?\d+\.\d+),(-?\d+\.\d+)/; const match = address.match(regex); return match ? { lat: parseFloat(match[1]), lng: parseFloat(match[2]) } : null; }
        function getDistance(p1, p2) { if (!p1 || !p2) return 99999; return Math.sqrt(Math.pow(p1.lat - p2.lat, 2) + Math.pow(p1.lng - p2.lng, 2)); }
        function calculateDuration(v) { const count = v.esMantenimiento ? (parseInt(v.numEquipos) || 1) : (v.equipos || []).length; return count <= 1 ? 60 : 60 + (count - 1) * 30; }
        function formatMinutes(totalMin) { const h = Math.floor(totalMin / 60); const m = totalMin % 60; const ampm = h >= 12 ? 'PM' : 'AM'; const displayH = h > 12 ? h - 12 : (h === 0 ? 12 : h); return `${displayH}:${m.toString().padStart(2, '0')} ${ampm}`; }
        function toggleDetail(id) { document.getElementById(`detail-${id}`)?.classList.toggle('hidden'); }

        function renderRutero() {
            const list = document.getElementById('ruteroListBody');
            const header = document.getElementById('ruteroHeaderRow');
            if(!list || !header) return;
            const date = document.getElementById('filterDateInputRutero').value;
            let tech = currentTechUser || document.getElementById('ruteroTechFilter')?.value || "";
            const colCount = currentTechUser ? 5 : 7;
            header.innerHTML = `<th class="border-r">Hora</th><th class="border-r text-left">Cliente</th>${!currentTechUser ? '<th class="border-r">T√©cnico</th>' : ''}<th class="border-r text-center">Tipo</th><th class="border-r text-center">Mapa</th><th class="text-center">Contacto</th>${!currentTechUser ? '<th class="text-center">Admin</th>' : ''}`;
            let filtered = visitsArray.filter(v => v.fechaInstalacion === date);
            if(tech) filtered = filtered.filter(v => v.tecnico === tech);
            if(filtered.length === 0) { list.innerHTML = `<tr><td colspan="${colCount + 1}" class="p-10 text-center text-slate-300 italic font-black uppercase text-xl text-center">Sin servicios hoy</td></tr>`; return; }
            
            let sorted = [];
            let manuallyPrioritized = filtered.filter(v => v.priority && parseInt(v.priority) > 0).sort((a,b) => parseInt(a.priority) - parseInt(b.priority));
            let pool = filtered.filter(v => !v.priority || parseInt(v.priority) <= 0);
            sorted = [...manuallyPrioritized];
            let curPos = sorted.length > 0 ? getCoords(sorted[sorted.length - 1].direccion) || { lat: -2.900, lng: -79.005 } : { lat: -2.900, lng: -79.005 };
            while(pool.length > 0) {
                pool.sort((a,b) => getDistance(curPos, getCoords(a.direccion)) - getDistance(curPos, getCoords(b.direccion)));
                const next = pool.shift(); sorted.push(next);
                const coords = getCoords(next.direccion); if(coords) curPos = coords;
            }
            let start = 9 * 60; 
            list.innerHTML = sorted.map(v => {
                const dur = calculateDuration(v); const time = formatMinutes(start); start += dur + 15; 
                const maps = v.direccion && v.direccion.includes('http') ? v.direccion : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v.direccion || '')}`;
                const waPhone = (v.telefono || "").replace(/\D/g, '').startsWith('593') ? (v.telefono || "").replace(/\D/g, '') : '593' + ((v.telefono || "").replace(/\D/g, '').startsWith('0') ? (v.telefono || "").replace(/\D/g, '').substring(1) : (v.telefono || "").replace(/\D/g, ''));
                return `<tr class="border-b row-hover transition-all">
                    <td class="border-r"><span class="time-badge font-mono">${time}</span></td>
                    <td class="border-r font-black text-fix-blue cursor-pointer" onclick="toggleDetail('${v.id}')">${v.nombreCliente}</td>
                    ${!currentTechUser ? `<td class="border-r text-slate-400 italic">${v.tecnico || '---'} ${v.priority ? `<span class="bg-fix-accent text-white px-1 rounded ml-1">#${v.priority}</span>` : ''}</td>` : ''}
                    <td class="border-r text-center font-mono text-fix-accent text-[8px] font-black">${v.tipoAtencion || 'SERV.'}</td>
                    <td class="border-r text-center"><a href="${maps}" target="_blank" class="bg-fix-light text-white px-2 py-1 rounded text-[8px] uppercase font-black shadow-sm">üìç MAPA</a></td>
                    <td class="text-center">
                        <div class="flex flex-col gap-1 items-center">
                            <a href="tel:${v.telefono}" class="text-lg">üìû</a>
                            ${v.estado === 'Atendido' ? `<button onclick="sendServiceOrder('${v.id}')" class="text-xl bg-green-50 p-1 rounded-lg border border-green-200">‚úÖüí¨</button>` : `<a href="https://wa.me/${waPhone}" target="_blank" class="text-lg">üí¨</a>`}
                        </div>
                    </td>
                    ${!currentTechUser ? `<td class="text-center"><button onclick="openEditModal('${v.id}')" class="bg-fix-blue text-white px-2 py-1 rounded text-[8px] font-black uppercase shadow-sm">EDITAR</button></td>` : ''}
                </tr><tr id="detail-${v.id}" class="hidden detail-row"><td colspan="${colCount + 1}" class="p-6 bg-slate-50 uppercase font-bold text-[12px]"><div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-blue-50 p-6 rounded-3xl border-2 border-fix-blue/10 shadow-inner">
                        <h4 class="text-fix-blue font-black text-[10px] mb-4 border-b border-fix-blue/20 pb-2 italic tracking-widest uppercase">üìÑ Informaci√≥n para el T√©cnico</h4>
                        <div class="space-y-2 text-[11px]">
                            <p><span class="text-slate-500 italic uppercase">Nombre Cliente:</span> <span class="text-fix-blue font-black tracking-tighter">${v.nombreCliente}</span></p>
                            <p><span class="text-slate-500 italic uppercase">Identificaci√≥n:</span> <span class="font-mono text-slate-700">${v.cedula || '---'}</span></p>
                            <p><span class="text-slate-500 italic uppercase">Correo:</span> <span class="lowercase font-mono text-slate-700">${v.email || '---'}</span></p>
                            <div class="py-2 border-y border-fix-blue/5 my-2 italic">
                                <p><span class="text-slate-500 uppercase">Factura de Compra:</span> <span class="font-black text-fix-accent font-mono tracking-widest">${v.numFactura || '---'}</span></p>
                                <p><span class="text-slate-500 uppercase">Establecimiento:</span> <span class="text-slate-700">${v.lugarCompra || '---'}</span></p>
                            </div>
                            <p><span class="text-slate-500 italic uppercase text-[9px]">Direcci√≥n de Trabajo:</span><br><span class="text-slate-700 font-black">${v.callePrincipal || 'N/A'}</span></p>
                            ${v.descFalla ? `<div class="mt-2 p-3 bg-red-100 rounded-xl border border-red-200"><p class='text-fix-error font-black italic'>‚ö†Ô∏è FALLA: ${v.descFalla}</p><p class='text-fix-error font-black italic'>VISITA: ${v.numeroVisita}</p></div>` : ''}
                            <div class="mt-4 pt-2 border-t border-fix-blue/10 font-bold uppercase">
                                <p class="text-fix-blue font-black text-[10px] mb-1">EQUIPOS REGISTRADOS:</p>
                                ${(v.equipos || []).map(e => `<div class="bg-white/50 p-1 px-3 rounded-lg mb-1 border border-fix-blue/5 text-[10px]">‚Ä¢ ${e.descProducto} ${e.serieEquipo ? `(S/N: ${e.serieEquipo})` : ''}</div>`).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl border-2 border-slate-200 shadow-sm">
                        <h4 class="text-slate-400 font-black text-[10px] mb-4 border-b pb-2 italic tracking-widest uppercase">üõ†Ô∏è Reporte de Cierre</h4>
                        <div class="grid grid-cols-2 gap-3 mb-4 font-black"><select id="status_${v.id}" class="p-3 bg-slate-50 rounded-xl text-sm text-fix-blue outline-none border-none shadow-inner"><option value="PENDIENTE">¬øATENDI√ì?</option><option value="SI" ${v.estado === 'Atendido' ? 'selected' : ''}>S√ç</option><option value="NO" ${v.estado === 'No Atendido' ? 'selected' : ''}>NO</option></select><select id="type_${v.id}" class="p-3 bg-slate-50 rounded-xl text-sm outline-none shadow-inner">${TIPOS_SERVICIO.map(t => `<option value="${t}" ${v.tipoAtencion === t ? 'selected' : ''}>${t}</option>`).join('')}</select></div>
                        <div class="mb-4"><span class="text-[9px] font-black text-slate-300 ml-1 italic font-mono uppercase tracking-tighter">Forma de Pago</span><select id="payment_${v.id}" class="w-full p-3 bg-yellow-50 rounded-xl font-black text-sm text-fix-blue shadow-inner border-none outline-none"><option value="EFECTIVO" ${v.financiera?.formaPago === 'EFECTIVO' ? 'selected' : ''}>EFECTIVO</option><option value="TRANSFERENCIA" ${v.financiera?.formaPago === 'TRANSFERENCIA' ? 'selected' : ''}>TRANSFERENCIA</option></select></div>
                        <span class="text-[9px] font-black text-slate-300 ml-1 italic font-mono uppercase tracking-tighter">Insumos Utilizados</span>
                        <div class="grid grid-cols-1 gap-1 mb-4 max-h-[150px] overflow-y-auto pr-1 font-mono">${Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => `<div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg border border-slate-100"><span class="text-[10px] font-black uppercase text-slate-500 tracking-tighter">${n}</span><input type="number" min="0" value="0" data-name="${n}" data-price="${p}" class="acc-${v.id} w-14 text-center bg-white rounded-lg p-1 text-md font-black text-fix-blue shadow-inner outline-none"></div>`).join('')}</div>
                        <textarea id="reason_${v.id}" placeholder="Notas finales de la visita..." class="w-full bg-slate-50 p-4 rounded-2xl text-xs mb-4 h-20 font-bold shadow-inner border-none outline-none italic uppercase"></textarea>
                        <button onclick="closeVisitByTech('${v.id}')" class="w-full bg-fix-report text-white font-black py-5 rounded-2xl text-sm uppercase shadow-xl active:scale-95 italic">üíæ FINALIZAR Y GUARDAR</button>
                    </div>
                </div></td></tr>`;
            }).join('');
        }

        window.openEditModal = function(id) {
            const v = visitsArray.find(item => item.id === id);
            if(!v) return;
            const modal = document.getElementById('editModal');
            document.getElementById('edit_id').value = v.id;
            document.getElementById('edit_nombre').value = v.nombreCliente || "";
            document.getElementById('edit_telefono').value = v.telefono || "";
            document.getElementById('edit_fecha').value = v.fechaInstalacion || "";
            document.getElementById('edit_direccion').value = v.direccion || "";
            document.getElementById('edit_priority').value = v.priority || 0;
            document.getElementById('edit_descFalla').value = v.descFalla || "";
            document.getElementById('edit_numVisita').value = v.numeroVisita || "Primera Visita";
            const tecSel = document.getElementById('edit_tecnico');
            tecSel.innerHTML = LISTA_TECNICOS.map(t => `<option value="${t}" ${v.tecnico === t ? 'selected' : ''}>${t || 'SIN ASIGNAR'}</option>`).join('');
            
            const eqContainer = document.getElementById('edit_equipos_container');
            eqContainer.innerHTML = (v.equipos || []).map((eq, index) => `
                <div class="bg-slate-50 p-4 rounded-3xl border-2 border-fix-blue/5 mb-3 uppercase">
                    <p class="text-[10px] font-black text-fix-blue mb-2 italic tracking-tighter uppercase">Equipo #${index + 1}: ${eq.descProducto}</p>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col"><span class="text-[8px] text-slate-400 ml-2">Modelo / Descripci√≥n</span><input type="text" value="${eq.descProducto}" class="eq-desc-${index} p-3 bg-white rounded-xl shadow-inner text-xs font-bold uppercase"></div>
                        <div class="flex flex-col"><span class="text-[8px] text-slate-400 ml-2">C√≥digo Producto</span><input type="text" value="${eq.codProducto || ''}" class="eq-cod-${index} p-3 bg-white rounded-xl shadow-inner text-xs font-bold font-mono uppercase"></div>
                        <div class="flex flex-col col-span-2"><span class="text-[8px] text-slate-400 ml-2">N√∫mero de Serie (F√≠sico)</span><input type="text" value="${eq.serieEquipo || ''}" class="eq-serie-${index} p-3 bg-yellow-50 rounded-xl shadow-inner text-xs font-black font-mono text-fix-blue tracking-widest uppercase"></div>
                    </div>
                </div>
            `).join('');
            modal.classList.remove('hidden');
        };

        window.closeEditModal = function() { document.getElementById('editModal').classList.add('hidden'); };

        window.saveEditChanges = function() {
            const id = document.getElementById('edit_id').value;
            const v = visitsArray.find(item => item.id === id);
            const updatedEquipos = (v.equipos || []).map((eq, index) => ({
                ...eq,
                descProducto: document.querySelector(`.eq-desc-${index}`).value.toUpperCase(),
                codProducto: document.querySelector(`.eq-cod-${index}`).value.toUpperCase(),
                serieEquipo: document.querySelector(`.eq-serie-${index}`).value.toUpperCase()
            }));

            database.ref('visits/' + id).update({
                nombreCliente: document.getElementById('edit_nombre').value.toUpperCase(),
                telefono: document.getElementById('edit_telefono').value,
                fechaInstalacion: document.getElementById('edit_fecha').value,
                direccion: document.getElementById('edit_direccion').value,
                tecnico: document.getElementById('edit_tecnico').value,
                priority: document.getElementById('edit_priority').value,
                descFalla: document.getElementById('edit_descFalla').value.toUpperCase(),
                numeroVisita: document.getElementById('edit_numVisita').value,
                equipos: updatedEquipos
            }).then(() => { showMessage("‚úÖ Registro Actualizado en la Nube", "fix-report"); closeEditModal(); refreshData(); });
        };

        function processFinancialBalance() {
            const ingresosCaja = visitsArray.filter(v => v.estado === 'Atendido' && v.financiera).map(v => {
                const count = v.esMantenimiento ? 1 : (v.equipos || []).length;
                const accVal = (v.accesoriosVendidos || []).reduce((sum, a) => sum + (a.cantidad * a.precio), 0);
                const moVal = v.esMantenimiento ? (v.financiera.totalCliente || 0) : (v.equipos || []).reduce((sum, e) => sum + (e.costoBase || 0), 0);
                let finalMonto = 0; let nota = "";
                if((v.tipoAtencion || "").includes("Garant√≠a")) { finalMonto = 0; nota = "(Garant√≠a)"; } 
                else if (count >= 2) { finalMonto = accVal; nota = `(Insumos ${count}eq)`; } 
                else { finalMonto = moVal + accVal; nota = ""; }
                return { id: v.id, monto: finalMonto, type: 'INGRESO', concepto: `T√âCNICO: ${v.nombreCliente} ${nota}`, fecha: v.attendedDate ? new Date(v.attendedDate).getTime() : v.createdAt };
            });
            const manuales = movementsArray.map(m => ({ id: m.id, monto: m.monto, type: m.type, concepto: `MANUAL: ${m.concepto}`, fecha: m.fecha }));
            const todos = [...ingresosCaja, ...manuales].sort((a,b) => b.fecha - a.fecha);
            const tb = document.getElementById('contabilidadTableBody');
            if(tb) tb.innerHTML = todos.map(m => `<tr class="border-b row-hover">
                <td class="p-4 text-[9px] font-mono font-black italic">${new Date(m.fecha).toLocaleDateString()}</td><td class="p-4 text-[9px] font-bold tracking-tight ${m.type === 'INGRESO' ? 'text-green-600' : 'text-red-600'}">${m.type}</td><td class="p-4 text-xs font-black uppercase tracking-tighter">${m.concepto}</td><td class="p-4 text-right text-[10px] font-mono font-black">$${m.monto.toFixed(2)}</td><td class="text-center p-4">${m.id && m.concepto.includes('MANUAL') ? `<button onclick="database.ref('movements').child('${m.id}').remove()" class="text-fix-error text-xs">üóëÔ∏è</button>` : ''}</td>
            </tr>`).join('');
            let tIn = 0, tOut = 0; todos.forEach(m => m.type === 'INGRESO' ? tIn += m.monto : tOut += m.monto);
            const iD = document.getElementById('totalIngresosDisplay'), oD = document.getElementById('totalEgresosDisplay'), nD = document.getElementById('balanceNetoDisplay');
            if(iD) iD.textContent = `$${tIn.toFixed(2)}`; if(oD) oD.textContent = `$${tOut.toFixed(2)}`; if(nD) nD.textContent = `$${(tIn - tOut).toFixed(2)}`;
        }

        window.saveVisit = function() {
            const form = document.getElementById('visitForm');
            const data = Object.fromEntries(new FormData(form));
            const eqs = []; for(let i=1; i<=parseInt(data.numEquipos); i++) eqs.push({ descProducto: data[`descProducto_${i}`].toUpperCase(), costoBase: parseFloat(data[`costoEquipo_${i}`]) || 0, codProducto: "", serieEquipo: "" });
            const ref = database.ref('visits').push();
            const tipoG = data.tipoServicioGlobal;
            ref.set({ 
                id: ref.key, nombreCliente: data.nombreCliente.toUpperCase(), cedula: data.cedula || '', telefono: data.telefono || '', email: data.email || '', 
                direccion: data.direccion, callePrincipal: data.callePrincipal.toUpperCase(), numFactura: data.numFactura || '', 
                fechaInstalacion: document.getElementById('filterDateInput').value, fechaEmision: data.fechaEmision || document.getElementById('filterDateInput').value, lugarCompra: (data.lugarCompra || "OTRO").toUpperCase(), tecnico: data.tecnico || '', 
                tipoAtencion: tipoG, descFalla: tipoG === 'Garant√≠a' ? data.descFalla.toUpperCase() : "", numeroVisita: tipoG === 'Garant√≠a' ? data.numeroVisita : "", 
                estado: 'PENDIENTE', createdAt: Date.now(), equipos: eqs, financiera: { totalCliente: parseFloat(document.getElementById('displayTotalFinal').textContent.replace('$','')), formaPago: 'PENDIENTE' }, esMantenimiento: false, priority: 0 
            }).then(() => { showMessage("‚úÖ Registro Maestro Guardado", "fix-report"); form.reset(); expandEquipmentUI(); renderInsumosAdmin(); document.getElementById('warrantyFields').classList.add('hidden'); });
        };

        window.saveMantenimiento = function() {
            const form = document.getElementById('maintForm');
            const data = Object.fromEntries(new FormData(form));
            const ref = database.ref('visits').push();
            ref.set({ id: ref.key, nombreCliente: data.mNombre.toUpperCase(), telefono: data.mTelefono || '', direccion: data.mDireccion, callePrincipal: data.mCalle.toUpperCase(), tecnico: data.mTecnico || '', numEquipos: parseInt(data.mNumEquipos) || 1, tipoAtencion: "Mantenimiento", estado: 'PENDIENTE', createdAt: Date.now(), fechaInstalacion: document.getElementById('filterDateInput').value, mantenimientoObs: data.mObs.toUpperCase(), esMantenimiento: true, financiera: { totalCliente: parseFloat(data.mPrecio) || 0, formaPago: data.mPago }, priority: 0 })
            .then(() => { showMessage("‚úÖ Mantenimiento Guardado", "fix-report"); form.reset(); });
        };

        window.closeVisitByTech = function(id) {
            const s = document.getElementById(`status_${id}`).value;
            const t = document.getElementById(`type_${id}`).value;
            const pay = document.getElementById(`payment_${id}`).value;
            const r = document.getElementById(`reason_${id}`).value;
            const accs = []; let totalAccs = 0;
            document.querySelectorAll(`.acc-${id}`).forEach(i => {
                const q = parseInt(i.value) || 0;
                if(q > 0) { const p = parseFloat(i.dataset.price); accs.push({ nombre: i.dataset.name, cantidad: q, precio: p }); totalAccs += q * p; }
            });
            if(s === 'PENDIENTE') return showMessage("‚ö†Ô∏è Seleccione estado", "fix-accent");
            const v = visitsArray.find(item => item.id === id);
            const mo = v.esMantenimiento ? (v.financiera?.totalCliente || 0) : (v.equipos || []).reduce((acc, eq) => acc + (eq.costoBase || 0), 0);
            database.ref('visits/' + id).update({ estado: s === 'SI' ? 'Atendido' : 'No Atendido', tipoAtencion: t, razonNoAtencion: r, accesoriosVendidos: accs, attendedDate: new Date().toISOString(), 'financiera/totalCliente': (mo + totalAccs), 'financiera/formaPago': pay })
            .then(() => { showMessage("‚úÖ Solicitud Finalizada", "fix-report"); renderRutero(); });
        };

        window.saveManualMovement = function() {
            const c = document.getElementById('movConcepto').value; const m = parseFloat(document.getElementById('movMonto').value); const t = document.getElementById('movType').value;
            if(!c || !m) return showMessage("‚ö†Ô∏è Datos incompletos", "fix-accent");
            const ref = database.ref('movements').push();
            ref.set({ id: ref.key, concepto: c.toUpperCase(), monto: m, fecha: Date.now(), type: t }).then(() => { showMessage(`‚úÖ Movimiento registrado`, "fix-report"); document.getElementById('movConcepto').value=''; document.getElementById('movMonto').value=''; });
        };

        window.downloadCSV = function() {
            let csv = "FECHA COMPRA,LUGAR,FACTURA,CODIGO,DESCRIPCION,SERIE,GARANTIA,TECNICO,CIUDAD,FECHA ATENCION,NOMBRE CLIENTE,DIRECCI√ìN,CELULAR,PRECIO,ORIGEN,ATENDIO,VI√ÅTICO,FACTURA2,C√âDULA,CORREO\n";
            visitsArray.filter(v => !v.esMantenimiento).forEach(v => {
                (v.equipos || []).forEach(eq => {
                    const row = [v.fechaEmision || "", v.lugarCompra || "", v.numFactura || "", eq.codProducto || "", eq.descProducto || "", eq.serieEquipo || "", "SAP", "capelo", "Cuenca", v.fechaInstalacion || "", v.nombreCliente || "", v.callePrincipal || "", v.telefono || "", (eq.costoBase || 0).toFixed(2), "cliente final", v.tecnico || "", "", v.numFactura || "", v.cedula || "", v.email || ""];
                    csv += row.map(val => `"${val.toString().replace(/"/g, '""')}"`).join(",") + "\n";
                });
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            link.setAttribute("download", "FIX_REPORTE_MAESTRO.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };

        window.deleteVisit = function(id) { database.ref('visits/' + id).remove().then(() => showMessage("üóëÔ∏è Eliminado", "fix-error")); };

        function startSync() {
            database.ref('visits').on('value', snap => {
                visitsArray = snap.val() ? Object.entries(snap.val()).map(([id, val]) => ({...val, id})) : [];
                renderUIAgenda(); renderRutero(); if(currentView === 'reporte_teka') renderReporteTeka(); if(currentView === 'contabilidad') processFinancialBalance();
            });
            database.ref('movements').on('value', snap => { 
                movementsArray = snap.val() ? Object.entries(snap.val()).map(([id, val]) => ({...val, id})) : []; 
                if(currentView === 'contabilidad') processFinancialBalance(); 
            });
        }

        function renderUIAgenda() {
            const list = document.getElementById('visitsList'); if(!list) return;
            const df = document.getElementById('filterDateInput').value;
            let filtered = visitsArray.filter(v => v.fechaInstalacion === df);
            list.innerHTML = filtered.map(v => `<div class="bg-white p-4 rounded-3xl shadow-md border-l-[10px] ${v.estado === 'Atendido' ? 'border-fix-report' : 'border-fix-accent'} mb-4"><div class="flex justify-between items-start mb-2"><p class="font-black text-fix-blue text-sm uppercase italic tracking-tighter uppercase font-sans">${v.nombreCliente}</p><div class="flex gap-2"><button onclick="deleteVisit('${v.id}')" class="text-fix-error text-[10px]">üóëÔ∏è</button></div></div><div class="space-y-1 font-black text-slate-400 text-[9px] uppercase italic">${v.esMantenimiento ? 'MANTENIMIENTO' : (v.equipos || []).map(e => `<div>‚Ä¢ ${e.descProducto}</div>`).join('')}</div></div>`).join('');
        }

        function renderReporteTeka() {
            const body = document.getElementById('tekaReporteBody'); if(!body) return;
            const regularVisits = visitsArray.filter(v => !v.esMantenimiento);
            body.innerHTML = regularVisits.flatMap(v => (v.equipos || []).map(eq => `<tr class="border-b row-hover">
                <td class="report-cell font-mono">${v.fechaEmision || ''}</td><td class="report-cell">${v.lugarCompra || ''}</td>
                <td class="report-cell font-black font-mono">${v.numFactura || ''}</td><td class="report-cell font-mono">${eq.codProducto || '-'}</td>
                <td class="report-cell font-black uppercase text-fix-blue">${eq.descProducto || ''}</td><td class="report-cell font-mono font-black text-fix-accent tracking-widest">${eq.serieEquipo || '-'}</td>
                <td class="report-cell text-[7px]">SAP</td><td class="report-cell text-slate-400 italic">capelo</td><td class="report-cell">Cuenca</td>
                <td class="report-cell font-black font-mono">${v.fechaInstalacion}</td><td class="report-cell font-black uppercase italic font-sans">${v.nombreCliente || ''}</td>
                <td class="report-cell text-[7px] max-w-[80px] break-words uppercase italic font-normal">${v.callePrincipal || ''}</td><td class="report-cell font-mono">${v.telefono || ''}</td>
                <td class="report-cell font-black text-right font-mono">$${(eq.costoBase || 0).toFixed(2)}</td><td class="report-cell text-[7px]">cliente final</td>
                <td class="report-cell text-slate-400 italic font-black">${v.tecnico || ''}</td><td class="report-cell text-center">${v.estado === 'Atendido' ? `<button onclick="sendServiceOrder('${v.id}')" class="bg-green-500 text-white p-1 rounded-lg text-[8px] font-black uppercase">WA üì≤</button>` : ''}</td>
                <td class="report-cell font-mono font-black text-fix-accent">${v.numFactura || ''}</td><td class="report-cell font-mono">${v.cedula || ''}</td>
                <td class="report-cell lowercase font-mono text-[7px]">${v.email || ''}</td>
                <td class="report-cell text-center"><button onclick="deleteVisit('${v.id}')" class="text-fix-error">üóëÔ∏è</button></td>
            </tr>`)).join('');
        }

        window.updateRuteroFilter = function(val) { renderRutero(); };

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date().toISOString().split('T')[0];
            const fA = document.getElementById('filterDateInput'), fR = document.getElementById('filterDateInputRutero'), iE = document.getElementById('inputEmision');
            if(fA) fA.value = hoy; if(fR) fR.value = hoy; if(iE) iE.value = hoy;
            const p = new URLSearchParams(window.location.search); const t = p.get('tech');
            if(t && LISTA_TECNICOS.includes(t)) { 
                currentTechUser = t; document.body.classList.add('technician-mode'); 
                document.getElementById('userDisplayLabel').textContent = "RUTA: " + t.toUpperCase(); changeMasterView('rutero'); 
            } 
            startSync();
            const selTec = document.getElementById('selectTecnico'), selTecM = document.getElementById('selectTecnicoMaint');
            LISTA_TECNICOS.forEach(item => { if(selTec) selTec.add(new Option(item || "--- T√âCNICO ---", item)); if(selTecM) selTecM.add(new Option(item || "--- T√âCNICO ---", item)); });
            const sl = document.getElementById('selectLugar'); if(sl) LUGARES_COMPRA.forEach(i => sl.add(new Option(i || "--- LUGAR COMPRA ---", i)));
            const rt = document.getElementById('ruteroTechFilter'); if(rt) LISTA_TECNICOS.forEach(i => rt.add(new Option(i || "TODOS LOS T√âCNICOS", i)));
            renderInsumosAdmin(); expandEquipmentUI();
        });
    </script>
</head>

<body class="bg-slate-100 min-h-screen p-4 md:p-10 font-sans selection:bg-fix-blue text-slate-800">

    <div class="max-w-[2800px] mx-auto pb-32">
        
        <header class="mb-14 flex flex-col xl:flex-row justify-between items-center gap-10 no-print transition-all">
            <div class="flex items-center">
                <div class="bg-fix-blue p-8 rounded-[1.5rem] shadow-premium mr-10 logo-container transition-all">
                    <span class="text-7xl font-black text-white italic tracking-tighter logo-text uppercase">FIX</span>
                </div>
                <div>
                    <h1 class="text-6xl font-black uppercase italic text-slate-800 tracking-tighter leading-none main-title font-sans">Gesti√≥n</h1>
                    <div class="flex flex-col">
                        <span id="userDisplayLabel" class="text-xs font-black text-slate-400 uppercase italic user-label tracking-widest tracking-tighter uppercase italic">Panel Administrativo</span>
                        <span class="version-badge">V. 1.1.8 - PRO</span>
                    </div>
                </div>
            </div>
            <nav id="adminNav" class="flex flex-wrap justify-center bg-white p-3 rounded-full shadow-premium border-[6px] border-slate-50 gap-4 admin-only">
                <button onclick="changeMasterView('reporte_admin')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-fix-blue text-white italic shadow-md">Registro</button>
                <button onclick="changeMasterView('mantenimiento')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-gray-100 text-gray-500 italic">Mantenimientos</button>
                <button onclick="changeMasterView('rutero')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-gray-100 text-gray-500 italic">Log√≠stica</button>
                <button onclick="changeMasterView('reporte_teka')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-gray-100 text-gray-500 italic">Maestro</button>
                <button onclick="changeMasterView('contabilidad')" class="view-btn py-3 px-8 rounded-full font-black text-[10px] uppercase bg-gray-100 text-gray-500 italic">Caja</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 main-grid">
            
            <div id="formContainer" class="lg:col-span-2 space-y-10 admin-only no-print">
                <div class="bg-white p-8 rounded-[3rem] shadow-premium border-[8px] border-white">
                    <input type="date" id="filterDateInput" onchange="syncDates('filterDateInput')" class="bg-slate-50 p-4 rounded-2xl text-3xl font-black italic text-fix-blue outline-none border-none shadow-inner w-full text-center font-mono">
                </div>
                <div class="bg-white p-10 rounded-[5rem] shadow-premium border-[15px] border-slate-50 font-sans">
                    <form id="visitForm" onsubmit="event.preventDefault(); saveVisit();">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 tracking-tighter uppercase font-bold italic">
                            <input type="text" name="nombreCliente" placeholder="CLIENTE*" required class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner uppercase">
                            <input type="text" name="callePrincipal" placeholder="CALLE (REPORTE)*" required class="p-6 bg-yellow-50 rounded-2xl font-black text-xl shadow-inner uppercase">
                            <input type="text" name="cedula" placeholder="C√âDULA*" class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner text-center font-mono tracking-tighter uppercase">
                            <input type="email" name="email" placeholder="EMAIL*" class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner outline-none font-mono">
                            <input type="tel" name="telefono" placeholder="TEL√âFONO*" class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner text-center font-mono tracking-tighter uppercase">
                            <input type="text" name="direccion" placeholder="LINK GPS*" required class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner">
                            <input type="text" name="numFactura" placeholder="N¬∞ FACTURA*" class="p-6 bg-slate-50 rounded-2xl font-black text-xl shadow-inner text-center font-mono uppercase tracking-tighter">
                            <select name="tecnico" id="selectTecnico" class="p-6 bg-slate-50 rounded-2xl font-black text-lg outline-none uppercase font-black"></select>
                            <select id="selectLugar" name="lugarCompra" class="p-6 bg-slate-50 rounded-2xl font-black text-lg outline-none uppercase font-black"></select>
                            <div class="flex flex-col font-black italic"><span class="text-[9px] font-black text-slate-300 ml-2 uppercase italic text-center tracking-widest uppercase italic">Emisi√≥n Factura</span><input type="date" name="fechaEmision" id="inputEmision" required class="p-6 bg-slate-50 rounded-2xl font-black text-xl outline-none shadow-inner text-center font-mono"></div>
                            
                            <select name="tipoServicioGlobal" id="tipoServicioGlobal" onchange="toggleWarrantyFields()" class="p-6 bg-white border-2 border-fix-blue/10 rounded-2xl font-black text-lg outline-none shadow-sm text-fix-blue italic uppercase tracking-tighter"><option value="Instalaci√≥n">Instalaci√≥n Est√°ndar</option><option value="Garant√≠a">Garant√≠a de F√°brica</option></select>
                            <div class="bg-slate-50 p-6 rounded-2xl flex items-center justify-between shadow-inner font-black italic text-slate-300 uppercase">Equipos: <input type="number" id="numEquipos" name="numEquipos" value="1" min="1" oninput="expandEquipmentUI()" class="w-16 text-center text-4xl text-fix-blue bg-transparent outline-none"></div>
                            <div id="warrantyFields" class="hidden md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 mt-4 italic uppercase font-black tracking-tighter"><input type="text" name="descFalla" placeholder="DESCRIPCI√ìN DEL DA√ëO/FALLA*" class="p-6 bg-red-50 rounded-2xl font-black text-xl uppercase shadow-inner outline-none border-l-8 border-fix-error uppercase"><select name="numeroVisita" class="p-6 bg-slate-50 rounded-2xl font-black text-lg outline-none shadow-inner uppercase font-mono"><option value="Primera Visita">Primera Visita</option><option value="Segunda Visita">Segunda Visita</option></select></div>
                        </div>
                        <div id="productInputsContainer" class="space-y-4"></div>
                        <div id="accesoriosContainerAdmin" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>
                        <div class="mt-10 grid grid-cols-3 gap-4 text-center font-black">
                            <div class="bg-slate-50 p-6 rounded-3xl shadow-inner italic uppercase text-[8px] text-slate-400">M.O.<br><span id="displayCostoInstalacion" class="text-3xl text-fix-blue tracking-tighter font-mono">$0.00</span></div>
                            <div class="bg-slate-50 p-6 rounded-3xl shadow-inner italic uppercase text-[8px] text-slate-400">Insumos<br><span id="displayTotalAccesorios" class="text-3xl text-fix-blue tracking-tighter font-mono">$0.00</span></div>
                            <div class="bg-fix-accent p-6 rounded-3xl shadow-2xl font-black text-white scale-105">Total Final<br><span id="displayTotalFinal" class="text-4xl tracking-tighter font-mono">$0.00</span></div>
                        </div>
                        <button type="submit" class="w-full bg-fix-blue text-white py-8 rounded-[4rem] mt-10 text-3xl font-black uppercase italic shadow-xl tracking-widest tracking-tighter font-sans uppercase">üöÄ AGENDAR VISITA</button>
                    </form>
                </div>
            </div>

            <!-- MODAL DE EDICI√ìN ADMINISTRATIVA -->
            <div id="editModal" class="hidden fixed inset-0 z-[20000] modal-overlay flex items-center justify-center p-4 overflow-y-auto uppercase font-black text-xs font-sans">
                <div class="bg-white w-full max-w-4xl rounded-[4rem] shadow-2xl p-10 border-[15px] border-slate-50 max-h-[90vh] overflow-y-auto font-black italic">
                    <h2 class="text-4xl font-black uppercase italic text-fix-blue mb-8 border-b-4 pb-4 tracking-tighter uppercase italic">Editar Cita / Registro Maestro</h2>
                    <input type="hidden" id="edit_id">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 uppercase font-bold italic">
                        <div class="flex flex-col"><span class="text-[10px] text-slate-400 ml-4 tracking-widest">Nombre Cliente</span><input type="text" id="edit_nombre" class="p-5 bg-slate-50 rounded-3xl outline-none shadow-inner uppercase font-black"></div>
                        <div class="flex flex-col"><span class="text-[10px] text-slate-400 ml-4 font-mono tracking-widest">Tel√©fono</span><input type="text" id="edit_telefono" class="p-5 bg-slate-50 rounded-3xl outline-none shadow-inner font-mono font-black"></div>
                        <div class="flex flex-col"><span class="text-[10px] text-slate-400 ml-4 font-mono tracking-widest uppercase italic">Fecha Atenci√≥n</span><input type="date" id="edit_fecha" class="p-5 bg-slate-50 rounded-3xl outline-none shadow-inner font-mono font-black"></div>
                        <div class="flex flex-col"><span class="text-[10px] text-slate-400 ml-4 tracking-widest uppercase italic">T√©cnico Asignado</span><select id="edit_tecnico" class="p-5 bg-yellow-50 rounded-3xl outline-none shadow-inner uppercase font-black"></select></div>
                        <div class="flex flex-col"><span class="text-[10px] text-slate-400 ml-4 uppercase tracking-widest uppercase italic">Lugar Compra</span><select id="edit_lugar" class="p-5 bg-slate-50 rounded-3xl outline-none shadow-inner uppercase font-black"></select></div>
                        <div class="flex flex-col"><span class="text-[10px] text-slate-400 ml-4 font-mono tracking-widest uppercase italic">Turno (1-10)</span><input type="number" id="edit_priority" placeholder="0 = Auto" class="p-5 bg-blue-50 rounded-3xl outline-none shadow-inner font-black text-fix-blue font-mono"></div>
                        <div class="flex flex-col md:col-span-2 italic uppercase font-black"><span class="text-[10px] text-slate-400 ml-4">Link GPS / Direcci√≥n</span><input type="text" id="edit_direccion" class="p-5 bg-slate-50 rounded-3xl outline-none shadow-inner font-normal normal-case"></div>
                        <div class="flex flex-col md:col-span-2 italic uppercase font-black"><span class="text-[10px] text-slate-400 ml-4 font-mono tracking-tighter uppercase italic">Da√±o reportado (Solo Garant√≠a)</span><input type="text" id="edit_descFalla" class="p-5 bg-red-50 rounded-3xl outline-none shadow-inner uppercase font-black"></div>
                    </div>
                    <h3 class="text-xl font-black uppercase italic text-slate-400 mb-6 border-b pb-2 tracking-widest uppercase font-sans">‚öôÔ∏è Detalle T√©cnico de Equipos</h3>
                    <div id="edit_equipos_container" class="space-y-4 mb-10"></div>
                    <div class="grid grid-cols-2 gap-4"><button onclick="saveEditChanges()" class="bg-fix-report text-white py-6 rounded-[3rem] font-black uppercase text-xl italic shadow-lg active:scale-95 transition-all">üíæ Guardar Cambios</button><button onclick="closeEditModal()" class="bg-slate-200 text-slate-500 py-6 rounded-[3rem] font-black uppercase text-xl italic shadow-md active:scale-95 transition-all">Cancelar</button></div>
                </div>
            </div>

            <!-- AGENDA LOCAL -->
            <div id="agendaContainer" class="lg:col-span-1 admin-only uppercase italic"><h2 class="text-3xl font-black uppercase italic mb-6 border-b-[6px] border-fix-blue text-slate-800 tracking-tighter text-center tracking-widest tracking-tighter uppercase font-sans">Agenda Local</h2><div id="visitsList" class="space-y-4 font-black italic"></div></div>

            <!-- LOG√çSTICA -->
            <div id="ruteroView" class="hidden lg:col-span-3 bg-white p-6 md:p-8 rounded-[3rem] md:rounded-[4rem] shadow-premium font-sans font-black italic">
                <div class="flex flex-col gap-4 mb-6 transition-all">
                    <div class="flex justify-between items-center"><h2 class="text-base font-bold uppercase italic text-slate-400 tracking-widest tracking-tighter uppercase">Control Log√≠stico</h2><select id="ruteroTechFilter" onchange="updateRuteroFilter(this.value)" class="p-3 bg-slate-100 rounded-xl font-black text-[10px] admin-only shadow-inner text-fix-blue outline-none border-none uppercase font-black"></select></div>
                    <div class="bg-slate-50 p-4 rounded-2xl border-2 border-slate-100 flex items-center justify-between shadow-sm"><span class="text-[9px] font-black uppercase text-slate-400 italic font-mono tracking-tighter uppercase font-black">Filtro Fecha:</span><input type="date" id="filterDateInputRutero" onchange="syncDates('filterDateInputRutero')" class="bg-white p-2 rounded-xl text-lg font-black italic text-fix-blue outline-none shadow-inner text-center font-mono"></div>
                </div>
                <div class="overflow-x-auto w-full border-4 border-slate-50 rounded-[2.5rem] shadow-inner"><table class="w-full border-collapse rutero-table"><thead><tr id="ruteroHeaderRow"></tr></thead><tbody id="ruteroListBody" class="font-black italic"></tbody></table></div>
            </div>

            <!-- MAESTRO -->
            <div id="reporteTekaView" class="hidden lg:col-span-3 bg-white p-6 rounded-[3rem] shadow-premium overflow-hidden font-sans font-black italic">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-black uppercase italic underline decoration-4 tracking-tighter tracking-tighter uppercase">Base Hist√≥rica Administrativa</h2>
                    <button onclick="downloadCSV()" class="bg-fix-report text-white px-8 py-3 rounded-full font-black text-xs shadow-xl uppercase italic uppercase font-mono tracking-widest uppercase font-black">üìä Descargar Excel (Teka)</button>
                </div>
                <div class="overflow-x-auto w-full border-4 border-slate-50 rounded-3xl shadow-inner">
                    <table class="w-full border-collapse admin-table">
                        <thead><tr class="bg-slate-900 text-white font-black text-[7px] uppercase tracking-tighter"><th>F. Compra</th><th>Lugar</th><th>Factura</th><th>C√≥digo</th><th>Descripci√≥n</th><th>Serie</th><th>Gar.</th><th>T√©c.</th><th>Ciudad</th><th>Atenci√≥n</th><th>Cliente</th><th>Direcci√≥n</th><th>Celular</th><th>Precio</th><th>Ori.</th><th>Atendi√≥</th><th>Orden</th><th>Fact 2</th><th>C√©dula</th><th>Email</th><th>X</th></tr></thead>
                        <tbody id="tekaReporteBody" class="font-black italic"></tbody>
                    </table>
                </div>
            </div>

            <!-- CAJA -->
            <div id="contabilidadView" class="hidden lg:col-span-3 bg-white p-10 rounded-[4rem] shadow-premium font-sans font-black italic">
                <div class="grid grid-cols-3 gap-6 mb-10 text-center uppercase font-black italic tracking-tighter">
                    <div class="p-6 bg-green-50 rounded-3xl shadow-inner italic"><span class="text-xs text-green-900 uppercase font-black tracking-widest font-mono font-black italic">Ingresos</span><div id="totalIngresosDisplay" class="text-6xl text-green-950 font-black font-mono tracking-tighter">$0.00</div></div>
                    <div class="p-6 bg-red-50 rounded-3xl shadow-inner italic"><span class="text-xs text-red-900 uppercase font-black tracking-widest font-mono font-black italic">Egresos</span><div id="totalEgresosDisplay" class="text-6xl text-red-950 font-black font-mono tracking-tighter">$0.00</div></div>
                    <div class="p-6 bg-slate-950 rounded-3xl shadow-2xl scale-105 text-white tracking-widest"><span>Balance</span><div id="balanceNetoDisplay" class="text-6xl font-black font-mono tracking-tighter">$0.00</div></div>
                </div>
                <div class="bg-slate-50 p-8 rounded-3xl mb-12 border-4 border-white shadow-inner flex flex-wrap gap-6 items-end font-black italic">
                    <div class="flex-grow"><span class="text-[10px] font-black text-slate-400 uppercase italic mb-2 block font-mono tracking-widest text-center text-xs text-center">Concepto Manual</span><input type="text" id="movConcepto" placeholder="..." class="w-full p-5 rounded-2xl font-black uppercase outline-none shadow-sm border-none uppercase"></div>
                    <div class="w-40"><span class="text-[10px] font-black text-slate-400 uppercase italic mb-2 block font-mono tracking-widest text-center text-xs font-mono font-black italic">Monto $</span><input type="number" id="movMonto" placeholder="0.00" class="w-full p-5 rounded-2xl text-right font-black border-none shadow-sm font-mono"></div>
                    <div class="w-48"><span class="text-[10px] font-black text-slate-400 uppercase italic mb-2 block font-mono tracking-widest text-center text-xs">Tipo</span><select id="movType" class="w-full p-5 rounded-2xl font-black border-none shadow-sm bg-white font-mono font-black font-black italic"><option value="INGRESO">‚ûï INGRESO</option><option value="EGRESO">‚ûñ EGRESO</option></select></div>
                    <button onclick="saveManualMovement()" class="bg-fix-blue text-white px-10 py-5 rounded-2xl font-black italic uppercase text-xs shadow-lg active:scale-95 transition-all tracking-widest uppercase font-mono font-black italic">Registrar</button>
                </div>
                <table class="w-full text-left admin-table font-mono font-black italic"><thead><tr><th class="p-4">Fecha</th><th class="p-4">Tipo</th><th class="p-4">Detalle</th><th class="p-4 text-right tracking-widest font-black italic">Monto</th><th class="p-4 text-center">X</th></tr></thead><tbody id="contabilidadTableBody" class="font-black italic uppercase font-black italic"></tbody></table>
                <div class="mt-12 text-center no-print"><button onclick="exportDatabaseBackup()" class="bg-slate-800 text-white px-6 py-3 rounded-xl font-black text-[9px] uppercase italic shadow-lg tracking-[0.2em] font-mono">üì• Descargar Copia Seguridad JSON</button></div>
            </div>

        </div>
    </div>

    <!-- BOT√ìN ACTUALIZAR FLOTANTE -->
    <button onclick="refreshData()" class="btn-refresh-float no-print" title="Actualizar Datos">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
    </button>

    <div id="messageBox" class="opacity-0 fixed transition-opacity duration-500 pointer-events-none z-[10000]"></div>

</body>
</html>
