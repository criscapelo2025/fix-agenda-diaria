<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FIX - GESTI√ìN PRO</title>
    
    <!-- CONFIGURACI√ìN DE APLICACI√ìN (PWA) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FIX GESTI√ìN">
    <meta name="theme-color" content="#1e3a8a">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fix-blue': '#1e3a8a',
                        'fix-light': '#3b82f6',
                        'fix-accent': '#f59e0b',
                        'fix-report': '#059669',
                        'fix-error': '#dc2626'
                    }
                }
            }
        }
    </script>

    <style>
        .currency-input { text-align: right; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
        @media print { .no-print { display: none !important; } }
        
        /* Modos de visualizaci√≥n */
        body.technician-mode .admin-only { display: none !important; }
        body.technician-mode header { margin-bottom: 0.5rem !important; padding-top: 0.5rem !important; }
        
        .admin-table thead th { position: sticky; top: 0; background: #1e293b; color: white; z-index: 10; padding: 0.75rem; text-transform: uppercase; font-size: 0.55rem; border: 1px solid #334155; }
        .rutero-table td { font-size: 10px; padding: 8px; text-transform: uppercase; font-weight: 700; }
        .detail-row { background-color: #f8fafc; border-left: 15px solid #1e3a8a; }

        .btn-refresh-float {
            position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 1000;
            width: 3.5rem; height: 3.5rem; border-radius: 50%;
            background: #1e3a8a; color: white; display: flex;
            align-items: center; justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        .btn-refresh-float:active { transform: scale(0.9) rotate(180deg); }
        .version-badge { background: #fbbf24; color: #1e3a8a; padding: 2px 10px; border-radius: 8px; font-weight: 900; font-size: 10px; margin-top: 4px; display: inline-block; }
        .modal-overlay { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(4px); }
        .report-cell { font-size: 9px; padding: 4px !important; border: 1px solid #e2e8f0; white-space: nowrap; font-weight: 700; }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .time-badge { background: #1e3a8a; color: white; padding: 2px 6px; border-radius: 4px; font-weight: 900; font-size: 10px; }
        
        .move-btn {
            display: flex; align-items: center; justify-content: center;
            width: 24px; height: 24px; background: #f1f5f9; border-radius: 6px;
            transition: all 0.2s; cursor: pointer; border: 1px solid #e2e8f0;
        }
        .move-btn:hover { background: #1e3a8a; color: white; }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCiESorKZljYeFHr19c_XPth2qWluz1Dro",
          authDomain: "fix-agenda-app.firebaseapp.com",
          projectId: "fix-agenda-app",
          storageBucket: "fix-agenda-app.firebasestorage.app",
          messagingSenderId: "98719439808",
          appId: "1:98719439808:web:66576c19c8b5233a718625",
        };
        
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const LISTA_TECNICOS = ["", "Andres Cardenas", "Cristian Capelo", "Juan Carlos Pando", "Allan Skykaz", "Juana Cardenas"];
        const LUGARES_COMPRA = ["", "COMERCIAL KYWI", "COMERCIAL SOLIS", "COMO HOGAR", "SUKASA", "LUNA PAZMI√ëO", "MACAOFERTAS", "HOME VEGA", "MERCARD", "TEKA DIRECTO", "OTRO"];
        const TIPOS_SERVICIO = ["Instalaci√≥n", "Garant√≠a", "Fuera de Garant√≠a", "Mantenimiento", "Reparaci√≥n", "Visita T√©cnica"];
        
        const TIPOS_EQUIPO = ["Horno El√©ctrico", "Horno a Gas", "Cocina Inducci√≥n", "Cocina a Gas", "Microondas", "Campana Tradicional", "Campana Decorativa", "Campana Isla", "Refrigerador", "Triturador", "Grifer√≠a", "Fregadero", "Lavavajillas", "Cafetera"];
        
        const COSTOS_EQUIPO = {
            "Horno El√©ctrico": 25.00, "Horno a Gas": 29.00, "Cocina Inducci√≥n": 25.00, "Cocina a Gas": 29.00, "Microondas": 25.00, "Campana Tradicional": 15.00, "Campana Decorativa": 36.00, "Campana Isla": 45.00, "Refrigerador": 30.00, "Triturador": 15.00, "Grifer√≠a": 13.00, "Fregadero": 13.00, "Lavavajillas": 25.00, "Cafetera": 25.00
        };

        const ACCESORIOS_DEFAULT = { 
            'Enchufe 110V': 5.00, 'Enchufe 220V 20V': 7.00, 'Enchufe 220V 50V': 10.00, 'Manguera c/bridas': 4.00, 'Ducto 4 pulgadas metro': 5.00, 'Enchufe chinito': 5.00, 'Acople': 5.00, 'Segunda visita': 12.00, 'Visita fuera de garant√≠a': 20.00 
        };

        let visitsArray = [];      
        let movementsArray = [];     
        let inventoryEntries = [];
        let currentView = 'reporte_admin';
        let currentTechUser = null; 

        function showMessage(msg, colorClass) {
            const box = document.getElementById('messageBox');
            if(!box) return;
            box.textContent = msg; 
            box.style.opacity = '1';
            box.className = `fixed bottom-10 left-1/2 -translate-x-1/2 p-4 rounded-full shadow-2xl text-white font-black uppercase text-[10px] z-[99999] transition-opacity duration-500 bg-${colorClass}`;
            setTimeout(() => { if(box) box.style.opacity = '0'; }, 3000);
        }

        function calculateFinancials() {
            let mo = 0; 
            const count = parseInt(document.getElementById('numEquipos').value) || 1;
            document.querySelectorAll('input[name^="costoEquipo_"]').forEach(i => mo += parseFloat(i.value) || 0);
            
            let acc = 0; 
            document.querySelectorAll('.form-acc-qty').forEach(i => acc += (parseInt(i.value) || 0) * (parseFloat(i.dataset.price) || 0));
            
            // Sumar accesorio manual extra
            const manualVal = parseFloat(document.getElementById('manualAccPrice').value) || 0;
            acc += manualVal;

            const cI = document.getElementById('displayCostoInstalacion');
            const cA = document.getElementById('displayTotalAccesorios');
            const cT = document.getElementById('displayTotalFinal');
            
            const moParaCaja = count >= 2 ? 0 : mo;

            if(cI) cI.textContent = `$${mo.toFixed(2)}`; 
            if(cA) cA.textContent = `$${acc.toFixed(2)}`; 
            if(cT) cT.textContent = `$${(moParaCaja + acc).toFixed(2)}`;
        }

        function updateEquipmentPrice(selectEl, index) {
            const selectedVal = selectEl.value;
            const count = parseInt(document.getElementById('numEquipos').value) || 1;
            const priceInput = document.getElementsByName(`costoEquipo_${index}`)[0];
            if(!priceInput) return;
            if (count === 1) priceInput.value = (COSTOS_EQUIPO[selectedVal] || 0.00).toFixed(2);
            else if (count === 2) priceInput.value = "20.00";
            else if (count >= 3) priceInput.value = "15.00";
            calculateFinancials();
        }

        function expandEquipmentUI() {
            const count = parseInt(document.getElementById('numEquipos').value) || 1;
            const container = document.getElementById('productInputsContainer'); 
            if(!container) return; 
            let unitPrice = 0;
            if (count === 2) unitPrice = 20.00;
            else if (count >= 3) unitPrice = 15.00;
            container.innerHTML = '';
            for(let i=1; i<=count; i++) {
                container.innerHTML += `
                <div class="p-3 bg-slate-50 rounded-xl border border-slate-200 mb-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                    <select name="descProducto_${i}" onchange="updateEquipmentPrice(this, ${i})" class="p-2 bg-white rounded font-bold text-xs shadow-sm outline-none uppercase" required>
                        <option value="">ELEGIR EQUIPO...</option>
                        ${TIPOS_EQUIPO.map(t => `<option value="${t}">${t}</option>`).join('')}
                    </select>
                    <input type="number" name="costoEquipo_${i}" step="0.01" value="${unitPrice.toFixed(2)}" oninput="calculateFinancials()" class="p-2 bg-yellow-50 rounded font-black text-right text-fix-blue outline-none font-mono">
                </div>`;
            }
            calculateFinancials();
        }

        function renderInsumosAdmin() {
            const container = document.getElementById('accesoriosContainerAdmin'); 
            if(!container) return;
            let html = Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => `
                <div class="flex items-center justify-between p-2 bg-white rounded-lg border border-slate-200">
                    <span class="text-[9px] font-black text-slate-500 uppercase">${n} ($${p.toFixed(2)})</span>
                    <input type="number" min="0" value="0" data-price="${p}" data-name="${n}" oninput="calculateFinancials()" class="form-acc-qty w-10 text-center bg-slate-50 rounded p-1 text-xs font-black outline-none shadow-inner" placeholder="0">
                </div>`).join('');
            
            // Fila Extra Manual
            html += `
                <div class="col-span-1 md:col-span-2 p-2 bg-slate-100 rounded-xl border border-slate-300 mt-2">
                    <p class="text-[9px] font-black text-fix-blue mb-1 italic">‚ûï OTRO ACCESORIO / EXTRA (GRABACI√ìN MANUAL)</p>
                    <div class="flex gap-2">
                        <input type="text" id="manualAccDesc" placeholder="DESCRIPCI√ìN DEL ACCESORIO..." class="flex-grow p-2 text-[10px] rounded border-none outline-none font-black uppercase shadow-inner">
                        <input type="number" id="manualAccPrice" placeholder="$0.00" oninput="calculateFinancials()" class="w-24 p-2 text-right text-[10px] rounded border-none outline-none font-mono font-black text-fix-report shadow-inner">
                    </div>
                </div>
            `;
            container.innerHTML = html;
        }

        function refreshData() {
            showMessage("üîÑ Sincronizando...", "fix-blue");
            database.ref('visits').once('value', () => {
                renderUIAgenda(); 
                renderRutero(); 
                processFinancialBalance();
                renderInventoryView();
                if(currentView === 'reporte_teka') renderReporteTeka();
                if(currentView === 'mantenimiento') renderReporteMantenimiento();
                showMessage("‚úÖ Actualizado", "fix-report");
            });
        }

        function syncDates(sourceId) {
            const val = document.getElementById(sourceId).value;
            const targets = ['filterDateInput', 'filterDateInputRutero', 'cajaDateStart', 'cajaDateEnd'];
            targets.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = val;
            });
            renderUIAgenda(); renderRutero(); processFinancialBalance();
        }

        function changeMasterView(view) {
            currentView = view;
            const sections = ['formContainer', 'contabilidadView', 'reporteTekaView', 'agendaContainer', 'ruteroView', 'mantenimientoView', 'inventoryView'];
            sections.forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
            
            if(view === 'reporte_admin') { 
                document.getElementById('formContainer')?.classList.remove('hidden'); 
                document.getElementById('agendaContainer')?.classList.remove('hidden'); 
            }
            else if(view === 'reporte_teka') { 
                document.getElementById('reporteTekaView')?.classList.remove('hidden'); 
                renderReporteTeka(); 
            }
            else if(view === 'mantenimiento') { 
                document.getElementById('mantenimientoView')?.classList.remove('hidden'); 
                renderReporteMantenimiento(); 
            }
            else { 
                const el = document.getElementById(view + 'View'); 
                if(el) el.classList.remove('hidden'); 
            }
            
            if(view === 'rutero') renderRutero();
            if(view === 'contabilidad') processFinancialBalance();
            if(view === 'inventory') renderInventoryView();
            
            document.querySelectorAll('.view-btn').forEach(btn => { 
                btn.classList.remove('bg-fix-blue', 'text-white'); 
                btn.classList.add('bg-gray-100', 'text-gray-500'); 
            });
            const act = document.querySelector(`[onclick*="'${view}'"]`);
            if(act) { 
                act.classList.add('bg-fix-blue', 'text-white'); 
                act.classList.remove('bg-gray-100', 'text-gray-500'); 
            }
        }

        function toggleDetail(id) { document.getElementById(`detail-${id}`)?.classList.toggle('hidden'); }

        // --- CIERRE T√âCNICO v1.9.9 (CON SOPORTE EXTRA MANUAL) ---
        function closeVisitByTech(id) {
            const s = document.getElementById(`status_${id}`).value;
            const t = document.getElementById(`type_${id}`).value;
            const pay = document.getElementById(`payment_${id}`).value;
            const r = document.getElementById(`reason_${id}`).value;
            
            let totalAccs = 0; const accs = [];
            
            // 1. Recoger accesorios est√°ndar
            document.querySelectorAll(`.acc-${id}`).forEach(i => {
                const q = parseInt(i.value) || 0;
                if(q > 0) { 
                    const p = parseFloat(i.dataset.price); 
                    accs.push({ nombre: i.dataset.name, cantidad: q, precio: p }); 
                    totalAccs += q * p; 
                }
            });

            // 2. Recoger accesorio manual extra del t√©cnico
            const manualDesc = document.getElementById(`manual_acc_desc_${id}`).value;
            const manualPrice = parseFloat(document.getElementById(`manual_acc_price_${id}`).value) || 0;
            if(manualDesc && manualPrice > 0) {
                accs.push({ nombre: manualDesc.toUpperCase(), cantidad: 1, precio: manualPrice });
                totalAccs += manualPrice;
            }

            if(s === 'PENDIENTE') return showMessage("‚ö†Ô∏è Seleccione estado", "fix-accent");
            
            const v = visitsArray.find(item => item.id === id);
            const eqCount = v.esMantenimiento ? 1 : (v.equipos || []).length;
            
            let moParaCaja = 0;
            if (v.esMantenimiento) {
                moParaCaja = v.financiera?.totalCliente || 0;
            } else if (eqCount === 1 && v.tipoAtencion !== 'Garant√≠a' && t !== 'Garant√≠a') {
                moParaCaja = (v.equipos || []).reduce((acc, eq) => acc + (eq.costoBase || 0), 0);
            }
            
            const totalFinal = moParaCaja + totalAccs;

            database.ref('visits/' + id).update({ 
                estado: s === 'SI' ? 'Atendido' : 'No Atendido', 
                tipoAtencion: t, 
                razonNoAtencion: r, 
                accesoriosVendidos: accs, 
                numeroVisita: document.getElementById(`visit_num_${id}`)?.value || v.numeroVisita || "Visita 1", 
                attendedDate: new Date().toISOString(), 
                'financiera/totalCliente': totalFinal, 
                'financiera/formaPago': pay 
            }).then(() => { 
                showMessage("‚úÖ Guardado", "fix-report"); 
                renderRutero(); 
            });
        }

        function deleteVisit(id) {
            if(confirm("¬øELIMINAR ESTE REGISTRO PERMANENTEMENTE?")) { 
                database.ref('visits/' + id).remove().then(() => showMessage("üóëÔ∏è Registro Eliminado", "fix-error")); 
            }
        }

        function renderUIAgenda() {
            const list = document.getElementById('visitsList'); if(!list) return;
            const df = document.getElementById('filterDateInput').value;
            const searchQuery = document.getElementById('searchClientInput')?.value.toLowerCase() || "";
            let filtered = visitsArray.filter(v => v.fechaInstalacion === df);
            if(searchQuery) filtered = filtered.filter(v => v.nombreCliente.toLowerCase().includes(searchQuery));
            list.innerHTML = filtered.map(v => `
                <div class="bg-white p-4 rounded-2xl shadow-md border-l-[10px] ${v.estado === 'Atendido' ? 'border-fix-report' : 'border-fix-accent'} mb-4 uppercase">
                    <div class="flex justify-between items-start mb-1">
                        <p class="font-black text-fix-blue text-sm italic">${v.nombreCliente}</p>
                        <button onclick="deleteVisit('${v.id}')" class="text-fix-error text-[10px]">üóëÔ∏è</button>
                    </div>
                    <div class="text-slate-400 text-[9px] font-black uppercase">
                        ${v.esMantenimiento ? 'MANTENIMIENTO' : (v.equipos || []).map(e => `‚Ä¢ ${e.descProducto}`).join('<br>')}
                    </div>
                </div>`).join('');
        }

        function movePriority(id, step) {
            const date = document.getElementById('filterDateInputRutero').value;
            let tech = currentTechUser || document.getElementById('ruteroTechFilter')?.value || "";
            let filtered = visitsArray.filter(v => v.fechaInstalacion === date && (tech === "" || v.tecnico === tech));
            let sorted = [...filtered].sort((a,b) => (parseInt(a.priority) || 999) - (parseInt(b.priority) || 999));
            const idx = sorted.findIndex(v => v.id === id);
            const targetIdx = idx + step;
            if (targetIdx >= 0 && targetIdx < sorted.length) {
                const currentVisit = sorted[idx]; const targetVisit = sorted[targetIdx];
                const p1 = parseInt(targetVisit.priority) || (targetIdx + 1);
                const p2 = parseInt(currentVisit.priority) || (idx + 1);
                database.ref('visits/' + currentVisit.id).update({ priority: p1 === p2 ? p1 + step : p1 });
                database.ref('visits/' + targetVisit.id).update({ priority: p2 });
                showMessage("üîÑ Reordenando...", "fix-blue");
            }
        }

        // --- RENDERIZADO DE RUTERO (LOG√çSTICA) v1.9.9 (CON EXTRA T√âCNICO) ---
        function renderRutero() {
            const list = document.getElementById('ruteroListBody'); if(!list) return;
            const date = document.getElementById('filterDateInputRutero').value;
            let tech = currentTechUser || document.getElementById('ruteroTechFilter')?.value || "";
            
            let filtered = visitsArray.filter(v => v.fechaInstalacion === date);
            if(tech) filtered = filtered.filter(v => v.tecnico === tech);
            
            if(filtered.length === 0) { 
                list.innerHTML = `<tr><td colspan="9" class="p-10 text-center text-slate-300 italic font-black uppercase text-sm">Sin servicios hoy</td></tr>`; 
                return; 
            }
            
            let sorted = [...filtered].sort((a,b) => (parseInt(a.priority) || 999) - (parseInt(b.priority) || 999));
            let currentMinutes = 9 * 60;
            
            list.innerHTML = sorted.map((v, index) => {
                const h = Math.floor(currentMinutes / 60); const m = currentMinutes % 60;
                const timeStr = `${h > 12 ? h - 12 : (h === 0 ? 12 : h)}:${m.toString().padStart(2, '0')} ${h >= 12 ? 'PM' : 'AM'}`;
                const eqCount = v.esMantenimiento ? 1 : (v.equipos || []).length;
                currentMinutes += (60 + (Math.max(0, eqCount - 1) * 20)) + 15;
                const maps = v.direccion && v.direccion.includes('http') ? v.direccion : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(v.direccion || '')}`;
                const waPhone = v.telefono ? v.telefono.replace(/\D/g, '') : '';
                
                const initials = v.tecnico ? v.tecnico.split(' ').map(n => n[0]).join('').toUpperCase() : '---';
                
                let statusBadge = `<span class="px-2 py-0.5 rounded-full text-[7px] bg-slate-200 text-slate-600 font-black">PENDIENTE</span>`;
                if(v.estado === 'Atendido') statusBadge = `<span class="px-2 py-0.5 rounded-full text-[7px] bg-green-100 text-green-700 font-black">ATENDIDO</span>`;
                else if(v.estado === 'No Atendido') statusBadge = `<span class="px-2 py-0.5 rounded-full text-[7px] bg-red-100 text-red-700 font-black">NO ATENDIDO</span>`;

                const tipoServ = v.esMantenimiento ? '‚öôÔ∏è MANT.' : (v.tipoAtencion === 'Garant√≠a' ? 'üõ°Ô∏è GARANT√çA' : 'üõ†Ô∏è INSTALACI√ìN');
                const colorTipo = v.esMantenimiento ? 'text-fix-accent' : (v.tipoAtencion === 'Garant√≠a' ? 'text-fix-blue' : 'text-fix-report');

                return `
                <tr class="border-b row-hover uppercase font-black">
                    <td class="border-r text-center px-1">
                        <div class="flex flex-col items-center gap-0.5 admin-only">
                            <div onclick="movePriority('${v.id}', -1)" class="move-btn ${index === 0 ? 'opacity-20 pointer-events-none' : ''}">‚Üë</div>
                            <span class="time-badge font-mono">${timeStr}</span>
                            <div onclick="movePriority('${v.id}', 1)" class="move-btn ${index === sorted.length - 1 ? 'opacity-20 pointer-events-none' : ''}">‚Üì</div>
                        </div>
                        <div class="technician-mode-only text-center block md:hidden">
                            <span class="time-badge font-mono">${timeStr}</span>
                        </div>
                    </td>
                    <td class="border-r px-2 text-[9px] font-black text-fix-blue cursor-pointer truncate max-w-[120px]" onclick="toggleDetail('${v.id}')">
                        ${v.nombreCliente}
                    </td>
                    <td class="border-r px-2 text-[8px] text-slate-500 font-normal italic lowercase truncate max-w-[120px]">
                        ${v.callePrincipal || '---'}
                    </td>
                    <td class="border-r px-2 text-center">
                        <div class="text-[6px] ${colorTipo} font-black uppercase tracking-tighter">${tipoServ}</div>
                    </td>
                    <td class="border-r text-center font-mono text-slate-400 text-[9px] italic">${initials}</td>
                    <td class="border-r text-center">${statusBadge}</td>
                    <td class="border-r text-center">
                        <a href="${maps}" target="_blank" class="bg-fix-light text-white px-3 py-2 rounded-lg text-[8px] font-black shadow-md italic inline-block w-full">üìç MAPA</a>
                    </td>
                    <td class="text-center">
                        <div class="flex justify-center gap-2 items-center p-1">
                            <a href="tel:${v.telefono}" class="text-2xl shadow-sm bg-white rounded-full p-1 border border-slate-100">üìû</a>
                            <a href="https://wa.me/593${waPhone.startsWith('0') ? waPhone.substring(1) : waPhone}" target="_blank" class="text-2xl shadow-sm bg-white rounded-full p-1 border border-slate-100">üí¨</a>
                        </div>
                    </td>
                    ${!currentTechUser ? `<td class="text-center admin-only"><button onclick="openEditModal('${v.id}')" class="bg-fix-blue text-white px-2 py-1 rounded text-[7px] font-black uppercase">EDIT</button></td>` : ''}
                </tr>
                <tr id="detail-${v.id}" class="hidden detail-row uppercase font-black">
                    <td colspan="9" class="p-4 bg-slate-50 border-y border-slate-200">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-[10px] font-black text-fix-blue uppercase mb-2 italic">üìÑ Informaci√≥n</p>
                                <p class="text-xs"><b>CALLE:</b> ${v.callePrincipal || '---'}</p>
                                <p class="text-xs uppercase"><b>EQUIPOS:</b> ${v.esMantenimiento ? v.mantenimientoEquipo : (v.equipos || []).map(e => e.descProducto).join(', ')}</p>
                                <div class="mt-2 p-2 bg-slate-50 rounded-lg"><p class="text-[8px] text-slate-400 font-black italic">Notas Previas:</p><p class="text-xs text-fix-error uppercase">${v.razonNoAtencion || 'Ninguna'}</p></div>
                            </div>
                            <div class="bg-white p-4 rounded-xl shadow-sm">
                                <p class="text-[10px] font-black text-fix-report uppercase mb-2 italic">üõ†Ô∏è Cierre T√©cnico</p>
                                <div class="grid grid-cols-2 gap-2 mb-2 italic">
                                    <select id="status_${v.id}" class="p-2 bg-slate-100 rounded text-[10px] font-black uppercase"><option value="PENDIENTE">¬øATENDI√ì?</option><option value="SI" ${v.estado === 'Atendido' ? 'selected' : ''}>S√ç, ATENDIDO</option><option value="NO" ${v.estado === 'No Atendido' ? 'selected' : ''}>NO ATENDIDO</option></select>
                                    <select id="type_${v.id}" class="p-2 bg-slate-100 rounded text-[10px] font-black uppercase">${TIPOS_SERVICIO.map(t => `<option value="${t}" ${v.tipoAtencion === t ? 'selected' : ''}>${t}</option>`).join('')}</select>
                                </div>
                                <select id="payment_${v.id}" class="w-full p-2 bg-slate-100 rounded mb-2 text-[10px] font-black uppercase"><option value="EFECTIVO" ${v.financiera?.formaPago === 'EFECTIVO' ? 'selected' : ''}>EFECTIVO</option><option value="TRANSFERENCIA" ${v.financiera?.formaPago === 'TRANSFERENCIA' ? 'selected' : ''}>TRANSFERENCIA</option></select>
                                <textarea id="reason_${v.id}" placeholder="Novedades del Servicio..." class="w-full p-2 text-xs bg-slate-50 rounded mb-2 border-none outline-none font-bold uppercase italic">${v.razonNoAtencion || ''}</textarea>
                                
                                <div class="max-h-24 overflow-y-auto mb-2 border rounded p-1 bg-slate-50">
                                    ${Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => {
                                        const existing = (v.accesoriosVendidos || []).find(a => a.nombre === n);
                                        return `<div class="flex justify-between items-center mb-1 bg-white p-1 rounded font-black border border-slate-100"><span class="text-[8px] uppercase">${n} ($${p.toFixed(2)})</span><input type="number" min="0" value="${existing ? existing.cantidad : 0}" data-name="${n}" data-price="${p}" class="acc-${v.id} w-10 text-center text-[10px] border-none font-black text-fix-blue bg-slate-50 rounded shadow-inner"></div>`;
                                    }).join('')}
                                </div>

                                <!-- ACCESORIO EXTRA T√âCNICO -->
                                <div class="p-2 bg-slate-100 rounded-lg border border-slate-200 mb-2">
                                    <p class="text-[7px] font-black text-slate-500 mb-1">ACCESORIO NO EN LISTA / CARGO EXTRA:</p>
                                    <div class="flex gap-1">
                                        <input type="text" id="manual_acc_desc_${v.id}" placeholder="DESCRIPCI√ìN..." class="flex-grow p-1.5 text-[9px] rounded border-none font-black uppercase">
                                        <input type="number" id="manual_acc_price_${v.id}" placeholder="$0.00" class="w-16 p-1.5 text-right text-[9px] rounded border-none font-mono font-black">
                                    </div>
                                </div>

                                <button onclick="closeVisitByTech('${v.id}')" class="w-full bg-fix-report text-white py-2 rounded-xl text-[10px] font-black uppercase shadow-md active:scale-95 transition-all">üíæ GUARDAR CIERRE FINAL</button>
                            </div>
                        </div>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderReporteTeka() {
            const body = document.getElementById('tekaReporteBody'); if(!body) return;
            const start = document.getElementById('maestroDateStart').value; const end = document.getElementById('maestroDateEnd').value;
            let filtered = visitsArray.filter(v => !v.esMantenimiento && v.estado === 'Atendido');
            if(start && end) filtered = filtered.filter(v => v.fechaInstalacion >= start && v.fechaInstalacion <= end);
            let rowCount = 1;
            body.innerHTML = filtered.flatMap(v => (v.equipos || []).map(eq => `
                <tr class="border-b row-hover font-black uppercase">
                    <td class="report-cell text-center font-mono bg-slate-50">${rowCount++}</td><td class="report-cell font-mono">${v.fechaEmision || ''}</td><td class="report-cell">${v.lugarCompra || 'OTRO'}</td><td class="report-cell font-mono">${v.numFactura || '-'}</td><td class="report-cell font-mono">${eq.codProducto || '-'}</td><td class="report-cell italic text-slate-400"></td><td class="report-cell font-mono tracking-widest">${eq.serieEquipo || '-'}</td><td class="report-cell font-black">SAP</td><td class="report-cell">CAPELO</td><td class="report-cell">CUENCA</td><td class="report-cell font-mono">${v.fechaInstalacion}</td><td class="report-cell font-black italic">${v.nombreCliente}</td><td class="report-cell max-w-[150px] truncate">${v.callePrincipal || '-'}</td><td class="report-cell font-mono">${v.telefono || '-'}</td><td class="report-cell font-black text-right font-mono">$${(eq.costoBase || 0).toFixed(2)}</td><td class="report-cell">CLIENTE FINAL</td><td class="report-cell">CAPELO</td><td class="report-cell italic text-slate-400"></td><td class="report-cell font-mono">${v.numFactura || '-'}</td><td class="report-cell font-mono">${v.cedula || '-'}</td><td class="report-cell lowercase">${v.email || '-'}</td><td class="report-cell text-center"><button onclick="deleteVisit('${v.id}')" class="text-fix-error">üóëÔ∏è</button></td>
                </tr>`)).join('');
        }

        function downloadCSV() {
            const start = document.getElementById('maestroDateStart').value || "HISTORICO"; const end = document.getElementById('maestroDateEnd').value || "HISTORICO";
            let csv = "NRO,FECHA DE EMISION,LUGAR DE COMPRA,FACTURA,CODIGO,DESCRIPCION,SERIE,SAP,TECNICO,CIUDAD,FECHA ATENCION,CLIENTE,CALLE,TELEFONO,PRECIO,LLEGADA INFO,TECNICO QUE ATENDIO,VIATICO,FACTURA REP,CEDULA,CORREO\n";
            document.querySelectorAll('#tekaReporteBody tr').forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length >= 21) {
                    let rowData = [];
                    for(let i=0; i<21; i++) { let text = cols[i].innerText.replace(/"/g, '""').replace(/\n/g, ' '); rowData.push(`"${text}"`); }
                    csv += rowData.join(",") + "\n";
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `REPORTE_MAESTRO_FIX_SAP_${start}_AL_${end}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        function downloadMantenimientoCSV() {
            const start = document.getElementById('maestroDateStart').value || "HISTORICO";
            const end = document.getElementById('maestroDateEnd').value || "HISTORICO";
            let csv = "FECHA,CLIENTE,TEL√âFONO,CALLE,EQUIPO,VALOR,ESTADO\n";
            document.querySelectorAll('#mantenimientoReporteBody tr').forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length >= 7) {
                    let rowData = [];
                    for(let i=0; i<7; i++) { 
                        let text = cols[i].innerText.replace(/"/g, '""').replace(/\n/g, ' ').replace('$',''); 
                        rowData.push(`"${text}"`); 
                    }
                    csv += rowData.join(",") + "\n";
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `REPORTE_MANTENIMIENTOS_FIX_${start}_AL_${end}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- L√ìGICA DE INVENTARIO ---
        function renderInventoryView() {
            const container = document.getElementById('inventoryTableBody'); if(!container) return;
            const selectAcc = document.getElementById('invAccSelect');
            if(selectAcc && selectAcc.options.length === 0) {
                Object.keys(ACCESORIOS_DEFAULT).forEach(n => selectAcc.add(new Option(n, n)));
            }

            container.innerHTML = Object.entries(ACCESORIOS_DEFAULT).map(([name, price]) => {
                const totalIn = inventoryEntries.filter(e => e.accesorio === name).reduce((sum, e) => sum + e.cantidad, 0);
                let totalOut = 0;
                visitsArray.filter(v => v.estado === 'Atendido' && v.accesoriosVendidos).forEach(v => {
                    const sold = v.accesoriosVendidos.find(a => a.nombre === name);
                    if(sold) totalOut += sold.cantidad;
                });
                const stock = totalIn - totalOut;

                return `
                <tr class="border-b row-hover font-black uppercase">
                    <td class="p-4 text-xs font-black text-fix-blue tracking-tighter">${name}</td>
                    <td class="p-4 text-center text-[10px] font-mono font-bold text-slate-400">${totalIn}</td>
                    <td class="p-4 text-center text-[10px] font-mono font-bold text-fix-error">${totalOut}</td>
                    <td class="p-4 text-center">
                        <span class="px-3 py-1 rounded-full text-xs font-mono font-black ${stock <= 5 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">${stock}</span>
                    </td>
                    <td class="p-4 text-right text-[10px] font-mono text-slate-400 italic">$${price.toFixed(2)}</td>
                </tr>`;
            }).join('');
        }

        window.saveInventoryEntry = function() {
            const acc = document.getElementById('invAccSelect').value;
            const qty = parseInt(document.getElementById('invQty').value);
            if(!acc || !qty || qty <= 0) return showMessage("‚ö†Ô∏è Datos Inv√°lidos", "fix-accent");
            
            const ref = database.ref('inventory_entries').push();
            ref.set({
                id: ref.key,
                accesorio: acc,
                cantidad: qty,
                fecha: Date.now(),
                admin: "ADMIN"
            }).then(() => {
                document.getElementById('invQty').value = "";
                showMessage("‚úÖ Stock A√±adido", "fix-report");
            });
        }

        function downloadInventoryCSV() {
            let csv = "ACCESORIO,ENTRADAS,UTILIZADO,STOCK ACTUAL,PRECIO UNIT\n";
            document.querySelectorAll('#inventoryTableBody tr').forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length >= 5) {
                    csv += `"${cols[0].innerText}",${cols[1].innerText},${cols[2].innerText},${cols[3].innerText},${cols[4].innerText.replace('$','')}\n`;
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `INVENTARIO_FIX_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // --- L√ìGICA DE CONTABILIDAD v2.0 (CASH ONLY BALANCE) ---
        function processFinancialBalance() {
            const start = document.getElementById('cajaDateStart').value; 
            const end = document.getElementById('cajaDateEnd').value;
            const techFilter = document.getElementById('cajaTechFilter').value;
            let todos = [];
            
            // 1. Procesar Visitas
            visitsArray.filter(v => v.estado === 'Atendido' && v.financiera).forEach(v => {
                let monto = 0;
                const eqCount = v.esMantenimiento ? 1 : (v.equipos || []).length;
                
                if (v.esMantenimiento) {
                    monto = v.financiera.totalCliente || 0;
                } else if (eqCount === 1 && v.tipoAtencion !== 'Garant√≠a') {
                    monto = v.financiera.totalCliente || 0;
                } else {
                    monto = (v.accesoriosVendidos || []).reduce((sum, a) => sum + (a.cantidad * a.precio), 0);
                }

                todos.push({ 
                    id: v.id, monto, type: 'INGRESO', concepto: `${v.esMantenimiento ? 'MANT:' : 'VISITA:'} ${v.nombreCliente}`, 
                    fecha: v.attendedDate ? new Date(v.attendedDate).getTime() : v.createdAt, 
                    dateStr: v.fechaInstalacion, source: 'VISITA',
                    tecnico: v.tecnico || '---',
                    formaPago: v.financiera.formaPago || 'EFECTIVO'
                });
            });

            // 2. Procesar Movimientos Manuales
            movementsArray.forEach(m => {
                todos.push({ 
                    id: m.id, monto: m.monto, type: m.type, concepto: `MANUAL: ${m.concepto}`, 
                    fecha: m.fecha, dateStr: new Date(m.fecha).toISOString().split('T')[0], 
                    source: 'MANUAL', tecnico: m.tecnico || '---', formaPago: m.formaPago || 'EFECTIVO'
                });
            });

            // 3. Aplicar Filtros (Fecha y T√©cnico)
            if(start && end) todos = todos.filter(m => m.dateStr >= start && m.dateStr <= end);
            if(techFilter) todos = todos.filter(m => m.tecnico === techFilter);

            todos.sort((a,b) => b.fecha - a.fecha);

            const tb = document.getElementById('contabilidadTableBody');
            if(tb) tb.innerHTML = todos.map(m => `
                <tr class="border-b row-hover uppercase font-black">
                    <td class="p-4 text-[9px] font-mono font-black italic">
                        ${new Date(m.fecha).toLocaleDateString()}<br>
                        <span class="text-[7px] text-slate-400 font-bold">${m.tecnico}</span>
                    </td>
                    <td class="p-4 text-[9px] font-bold tracking-tight">
                        <span class="${m.type === 'INGRESO' ? 'text-green-600' : 'text-red-600'}">${m.type}</span><br>
                        <span class="text-[7px] ${m.formaPago === 'TRANSFERENCIA' ? 'text-blue-500' : 'text-slate-400'}">${m.formaPago}</span>
                    </td>
                    <td class="p-4 text-xs font-black uppercase tracking-tighter">${m.concepto}</td>
                    <td class="p-4 text-right text-[10px] font-mono font-black">$${m.monto.toFixed(2)}</td>
                    <td class="text-center p-4">
                        <div class="flex gap-2 justify-center">
                            <button onclick="openEditFinanceModal('${m.id}', '${m.source}', ${m.monto}, '${m.concepto}')" class="text-fix-blue text-xs font-black">‚úèÔ∏è</button>
                            ${m.source === 'MANUAL' ? `<button onclick="database.ref('movements').child('${m.id}').remove()" class="text-fix-error text-xs">üóëÔ∏è</button>` : ''}
                        </div>
                    </td>
                </tr>`).join('');
            
            // 4. C√°lculos Dashboard (NUEVA L√ìGICA: S√ìLO EFECTIVO PARA EL NETO)
            let tIn = 0, tOut = 0, tCashIn = 0, tTransIn = 0;
            
            todos.forEach(m => {
                if(m.type === 'INGRESO') {
                    tIn += m.monto;
                    if(m.formaPago === 'EFECTIVO') tCashIn += m.monto;
                    else if(m.formaPago === 'TRANSFERENCIA') tTransIn += m.monto;
                } else {
                    // Se asume que los EGRESOS/GASTOS salen siempre del EFECTIVO
                    tOut += m.monto;
                }
            });

            // EL NETO (LO QUE DEBE HABER EN CAJA F√çSICA) ES S√ìLO EFECTIVO - EGRESOS
            const netoCajaFisica = tCashIn - tOut;
            
            document.getElementById('totalIngresosDisplay').textContent = `$${tIn.toFixed(2)}`;
            document.getElementById('totalEgresosDisplay').textContent = `$${tOut.toFixed(2)}`;
            document.getElementById('balanceNetoDisplay').textContent = `$${netoCajaFisica.toFixed(2)}`;
            document.getElementById('totalEfectivoDisplay').textContent = `$${tCashIn.toFixed(2)}`;
            document.getElementById('totalTransferDisplay').textContent = `$${tTransIn.toFixed(2)}`;
            
            // Actualizar cuadro de resumen final (Negro)
            document.getElementById('finalReportIngresos').textContent = `+$${tCashIn.toFixed(2)} (Cash)`;
            document.getElementById('finalReportEgresos').textContent = `-$${tOut.toFixed(2)}`;
            document.getElementById('finalReportNeto').textContent = `$${netoCajaFisica.toFixed(2)}`;
            document.getElementById('finalReportNeto').classList.remove('text-green-600', 'text-red-600');
            document.getElementById('finalReportNeto').classList.add(netoCajaFisica >= 0 ? 'text-green-400' : 'text-red-400');
            
            // Informaci√≥n bancaria aparte en el resumen final si se desea, 
            // pero para total caja mandatorio el efectivo.
        }

        function downloadCajaCSV() {
            const start = document.getElementById('cajaDateStart').value || "HISTORICO"; const end = document.getElementById('cajaDateEnd').value || "HISTORICO";
            let csv = "FECHA,T√âCNICO,TIPO,PAGO,DETALLE,MONTO\n";
            document.querySelectorAll('#contabilidadTableBody tr').forEach(row => {
                const cols = row.querySelectorAll('td');
                if(cols.length >= 4) {
                    const fechaT = cols[0].innerText.replace('\n', ' ');
                    const tipoP = cols[1].innerText.replace('\n', ' ');
                    const detalle = cols[2].innerText;
                    const monto = cols[3].innerText.replace('$','');
                    csv += `"${fechaT}","${tipoP}","${detalle}",${monto}\n`;
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
            link.setAttribute("download", `FIX_CAJA_${start}_AL_${end}.csv`);
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        window.openEditFinanceModal = function(id, source, currentMonto, concepto) {
            document.getElementById('finance_id').value = id; document.getElementById('finance_source').value = source; document.getElementById('finance_monto').value = currentMonto; document.getElementById('finance_concepto').value = concepto; document.getElementById('editFinanceModal').classList.remove('hidden');
        };

        window.closeEditFinanceModal = function() { document.getElementById('editFinanceModal').classList.add('hidden'); };

        window.saveFinanceAdjustment = function() {
            const id = document.getElementById('finance_id').value; const source = document.getElementById('finance_source').value; const nuevoMonto = parseFloat(document.getElementById('finance_monto').value) || 0; const nuevoConcepto = document.getElementById('finance_concepto').value.toUpperCase();
            if (source === 'MANUAL') database.ref('movements/' + id).update({ monto: nuevoMonto, concepto: nuevoConcepto.replace('MANUAL: ', '') }).then(() => closeEditFinanceModal());
            else database.ref('visits/' + id).update({ 'financiera/totalCliente': nuevoMonto }).then(() => closeEditFinanceModal());
        };

        window.openEditModal = function(id) {
            const v = visitsArray.find(item => item.id === id); if(!v) return;
            document.getElementById('edit_id').value = v.id;
            document.getElementById('edit_nombre').value = v.nombreCliente || "";
            document.getElementById('edit_telefono').value = v.telefono || "";
            document.getElementById('edit_email').value = v.email || "";
            document.getElementById('edit_cedula').value = v.cedula || "";
            document.getElementById('edit_fecha').value = v.fechaInstalacion || "";
            document.getElementById('edit_direccion').value = v.direccion || "";
            document.getElementById('edit_priority').value = v.priority || "";
            document.getElementById('edit_tecnico').value = v.tecnico || "";
            document.getElementById('edit_numFactura').value = v.numFactura || "";
            document.getElementById('edit_lugarCompra').value = v.lugarCompra || "";
            document.getElementById('edit_numEquipos').value = v.equipos ? v.equipos.length : 1;
            rebuildEditEquipmentInputs(v.equipos || []);
            rebuildEditAccessoriesInputs(v.accesoriosVendidos || []);
            document.getElementById('editModal').classList.remove('hidden');
        };

        function rebuildEditEquipmentInputs(equipos) {
            const count = parseInt(document.getElementById('edit_numEquipos').value) || 1;
            const container = document.getElementById('editEquiposContainer');
            let unitPrice = 0;
            if (count === 2) unitPrice = 20.00; else if (count >= 3) unitPrice = 15.00;
            container.innerHTML = '';
            for(let i=0; i<count; i++) {
                const eq = equipos[i] || { descProducto: "", costoBase: unitPrice };
                container.innerHTML += `
                    <div class="p-2 border rounded-lg bg-slate-50 mb-2">
                        <p class="text-[8px] font-black mb-1">EQUIPO ${i+1}</p>
                        <select class="edit-eq-select w-full p-2 text-[10px] font-black uppercase rounded border mb-1" onchange="updateEditPrice(this, ${i})">
                            <option value="">-- ELEGIR --</option>
                            ${TIPOS_EQUIPO.map(t => `<option value="${t}" ${eq.descProducto === t ? 'selected' : ''}>${t}</option>`).join('')}
                        </select>
                        <input type="number" step="0.01" value="${(count === 1 && !eq.descProducto ? unitPrice : eq.costoBase).toFixed(2)}" class="edit-eq-cost w-full p-2 text-[10px] font-mono font-black rounded border" placeholder="COSTO">
                    </div>`;
            }
        }

        function updateEditPrice(selectEl, index) {
            const count = parseInt(document.getElementById('edit_numEquipos').value) || 1;
            const costInputs = document.querySelectorAll('.edit-eq-cost');
            if (count === 1) costInputs[index].value = (COSTOS_EQUIPO[selectEl.value] || 0.00).toFixed(2);
            else if (count === 2) costInputs.forEach(i => i.value = "20.00");
            else if (count >= 3) costInputs.forEach(i => i.value = "15.00");
        }

        function rebuildEditAccessoriesInputs(vendidos) {
            const container = document.getElementById('editAccesoriosContainer');
            container.innerHTML = Object.entries(ACCESORIOS_DEFAULT).map(([n, p]) => {
                const v = vendidos.find(a => a.nombre === n) || { cantidad: 0 };
                return `<div class="flex justify-between items-center p-2 border-b"><span class="text-[8px] font-black">${n} ($${p.toFixed(2)})</span><input type="number" min="0" value="${v.cantidad}" data-name="${n}" data-price="${p}" class="edit-acc-qty w-10 text-center font-black text-xs border rounded"></div>`;
            }).join('');
        }

        window.saveEditChanges = function() {
            const id = document.getElementById('edit_id').value;
            const count = parseInt(document.getElementById('edit_numEquipos').value) || 1;
            const selects = document.querySelectorAll('.edit-eq-select');
            const costs = document.querySelectorAll('.edit-eq-cost');
            let updatedEquipos = []; let totalMO = 0;
            for(let i=0; i<selects.length; i++) {
                const c = parseFloat(costs[i].value) || 0; totalMO += c;
                updatedEquipos.push({ descProducto: selects[i].value.toUpperCase(), costoBase: c, codProducto: "", serieEquipo: "" });
            }
            let updatedAccs = []; let totalAccs = 0;
            document.querySelectorAll('.edit-acc-qty').forEach(i => {
                const q = parseInt(i.value) || 0;
                if(q > 0) { const p = parseFloat(i.dataset.price); updatedAccs.push({ nombre: i.dataset.name, cantidad: q, precio: p }); totalAccs += q * p; }
            });
            const moParaCaja = count >= 2 ? 0 : totalMO;
            const totalFinal = moParaCaja + totalAccs;
            database.ref('visits/' + id).update({
                nombreCliente: document.getElementById('edit_nombre').value.toUpperCase(), telefono: document.getElementById('edit_telefono').value, email: document.getElementById('edit_email').value.toLowerCase(), cedula: document.getElementById('edit_cedula').value, fechaInstalacion: document.getElementById('edit_fecha').value, direccion: document.getElementById('edit_direccion').value, tecnico: document.getElementById('edit_tecnico').value, numFactura: document.getElementById('edit_numFactura').value.toUpperCase(), lugarCompra: document.getElementById('edit_lugarCompra').value, priority: parseInt(document.getElementById('edit_priority').value) || 0, equipos: updatedEquipos, accesoriosVendidos: updatedAccs, 'financiera/totalCliente': totalFinal
            }).then(() => { showMessage("‚úÖ Registro Actualizado", "fix-report"); closeEditModal(); });
        };

        window.saveVisit = function() {
            const form = document.getElementById('visitForm'); const data = Object.fromEntries(new FormData(form));
            const eqs = []; for(let i=1; i<=parseInt(data.numEquipos); i++) eqs.push({ descProducto: data[`descProducto_${i}`].toUpperCase(), costoBase: parseFloat(data[`costoEquipo_${i}`]) || 0, codProducto: "", serieEquipo: "" });
            
            // Recolectar accesorios vendidos (est√°ndar + manual)
            let accs = [];
            document.querySelectorAll('.form-acc-qty').forEach(i => {
                const q = parseInt(i.value) || 0;
                if(q > 0) { accs.push({ nombre: i.dataset.name, cantidad: q, precio: parseFloat(i.dataset.price) }); }
            });
            const manualDesc = document.getElementById('manualAccDesc').value;
            const manualPrice = parseFloat(document.getElementById('manualAccPrice').value) || 0;
            if(manualDesc && manualPrice > 0) {
                accs.push({ nombre: manualDesc.toUpperCase(), cantidad: 1, precio: manualPrice });
            }

            const ref = database.ref('visits').push();
            ref.set({ 
                id: ref.key, nombreCliente: data.nombreCliente.toUpperCase(), cedula: data.cedula || '', telefono: data.telefono || '', email: data.email || '', direccion: data.direccion, callePrincipal: data.callePrincipal.toUpperCase(), numFactura: data.numFactura || '', fechaInstalacion: document.getElementById('filterDateInput').value, fechaEmision: data.fechaEmision, lugarCompra: data.lugarCompra || "OTRO", tecnico: data.tecnico || '', tipoAtencion: data.tipoServicioGlobal, descFalla: data.descFalla?.toUpperCase() || "", numeroVisita: "Visita 1", estado: 'PENDIENTE', createdAt: Date.now(), equipos: eqs, accesoriosVendidos: accs, financiera: { totalCliente: parseFloat(document.getElementById('displayTotalFinal').textContent.replace('$','')), formaPago: 'PENDIENTE' }, esMantenimiento: false, priority: 0 
            }).then(() => { 
                showMessage("‚úÖ Agendado", "fix-report"); 
                form.reset(); 
                document.getElementById('manualAccDesc').value = "";
                document.getElementById('manualAccPrice').value = "";
                expandEquipmentUI(); 
            });
        };

        window.saveMantenimiento = function() {
            const form = document.getElementById('maintForm'); const data = Object.fromEntries(new FormData(form));
            const ref = database.ref('visits').push();
            ref.set({ id: ref.key, nombreCliente: data.mNombre.toUpperCase(), telefono: data.mTelefono || '', direccion: data.mDireccion, callePrincipal: data.mCalle.toUpperCase(), mantenimientoEquipo: data.mEquipo.toUpperCase(), tecnico: data.mTecnico || '', numEquipos: 1, tipoAtencion: "Mantenimiento", estado: 'PENDIENTE', createdAt: Date.now(), fechaInstalacion: document.getElementById('filterDateInput').value, esMantenimiento: true, financiera: { totalCliente: parseFloat(data.mPrecio) || 0, formaPago: data.mPago }, priority: 0 
            }).then(() => { showMessage("‚úÖ Guardado", "fix-report"); form.reset(); });
        };

        function renderReporteMantenimiento() {
            const body = document.getElementById('mantenimientoReporteBody'); if(!body) return;
            body.innerHTML = visitsArray.filter(v => v.esMantenimiento).map(v => `
                <tr class="border-b row-hover font-black uppercase">
                    <td class="report-cell font-mono font-black">${v.fechaInstalacion}</td><td class="report-cell font-black text-fix-blue">${v.nombreCliente}</td><td class="report-cell font-mono">${v.telefono || '-'}</td><td class="report-cell uppercase text-[7px] max-w-[100px] truncate">${v.callePrincipal || '-'}</td><td class="report-cell uppercase text-[7px] font-bold text-fix-accent">${v.mantenimientoEquipo || 'General'}</td><td class="report-cell font-black text-right text-fix-report">$${(v.financiera?.totalCliente || 0).toFixed(2)}</td><td class="report-cell text-center font-black">${v.estado === 'Atendido' ? '‚úÖ' : '‚è≥'}</td><td class="report-cell text-center font-black"><button onclick="deleteVisit('${v.id}')" class="text-fix-error">üóëÔ∏è</button></td>
                </tr>`).join('');
        }

        window.saveManualMovement = function() {
            const c = document.getElementById('movConcepto').value; 
            const m = parseFloat(document.getElementById('movMonto').value); 
            const t = document.getElementById('movType').value;
            const p = document.getElementById('movPago').value;
            const tech = document.getElementById('movTecnico').value;

            if(!c || !m) return showMessage("‚ö†Ô∏è Incompleto", "fix-accent");
            const ref = database.ref('movements').push();
            ref.set({ 
                id: ref.key, concepto: c.toUpperCase(), monto: m, fecha: Date.now(), 
                type: t, formaPago: p, tecnico: tech || 'ADMIN'
            }).then(() => { 
                document.getElementById('movConcepto').value=''; 
                document.getElementById('movMonto').value=''; 
                showMessage("‚úÖ Registro Manual Guardado", "fix-report");
            });
        };

        function startSync() {
            database.ref('visits').on('value', snap => {
                visitsArray = snap.val() ? Object.entries(snap.val()).map(([id, val]) => ({...val, id})) : [];
                renderUIAgenda(); renderRutero(); renderInventoryView();
                if(currentView === 'reporte_teka') renderReporteTeka(); if(currentView === 'mantenimiento') renderReporteMantenimiento(); if(currentView === 'contabilidad') processFinancialBalance();
            });
            database.ref('movements').on('value', snap => { movementsArray = snap.val() ? Object.entries(snap.val()).map(([id, val]) => ({...val, id})) : []; if(currentView === 'contabilidad') processFinancialBalance(); });
            database.ref('inventory_entries').on('value', snap => { inventoryEntries = snap.val() ? Object.values(snap.val()) : []; renderInventoryView(); });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hoy = new Date().toISOString().split('T')[0];
            const dateInputs = ['filterDateInput', 'filterDateInputRutero', 'inputEmision', 'maestroDateStart', 'maestroDateEnd', 'cajaDateStart', 'cajaDateEnd'];
            dateInputs.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = hoy;
            });

            const p = new URLSearchParams(window.location.search); const t = p.get('tech');
            if(t && LISTA_TECNICOS.includes(t)) { 
                currentTechUser = t; 
                document.body.classList.add('technician-mode'); 
                document.getElementById('userDisplayLabel').textContent = "RUTA: " + t.toUpperCase(); 
                changeMasterView('rutero'); 
            } 
            startSync();
            LISTA_TECNICOS.forEach(item => { 
                ['selectTecnico', 'ruteroTechFilter', 'selectTecnicoMaint', 'edit_tecnico', 'movTecnico', 'cajaTechFilter'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.add(new Option(item || (id === 'cajaTechFilter' ? "TODOS LOS T√âCNICOS" : "--- T√âCNICO ---"), item));
                });
            });
            const editLugar = document.getElementById('edit_lugarCompra');
            LUGARES_COMPRA.forEach(i => { 
                const sl = document.getElementById('selectLugar'); if(sl) sl.add(new Option(i || "--- LUGAR COMPRA ---", i)); 
                if(editLugar) editLugar.add(new Option(i || "--- LUGAR COMPRA ---", i)); 
            });
            renderInsumosAdmin(); expandEquipmentUI();
        });
    </script>
</head>

<body class="bg-slate-100 min-h-screen p-2 md:p-8 font-sans selection:bg-fix-blue text-slate-800 font-black uppercase">

    <div class="max-w-[2800px] mx-auto pb-24">
        
        <header class="mb-4 sm:mb-10 flex flex-col xl:flex-row justify-between items-center gap-2 no-print">
            <div class="flex items-center">
                <div class="bg-fix-blue p-3 sm:p-6 rounded-2xl shadow-lg mr-3"><span class="text-2xl sm:text-5xl font-black text-white italic tracking-tighter uppercase">FIX</span></div>
                <div>
                    <h1 class="text-xl sm:text-4xl font-black uppercase italic text-slate-800 tracking-tighter leading-none">Gesti√≥n</h1>
                    <div class="flex flex-col"><span id="userDisplayLabel" class="text-[10px] sm:text-xs font-black text-slate-400 uppercase tracking-widest italic font-mono">Admin</span><span class="version-badge">V. 2.0.0</span></div>
                </div>
            </div>
            <nav id="adminNav" class="flex flex-wrap justify-center bg-white p-1 sm:p-2 rounded-full shadow-md border-2 border-slate-50 gap-1 admin-only">
                <button onclick="changeMasterView('reporte_admin')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-fix-blue text-white italic">Registro</button>
                <button onclick="changeMasterView('mantenimiento')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Mantenimiento</button>
                <button onclick="changeMasterView('inventory')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Inventario</button>
                <button onclick="changeMasterView('rutero')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Log√≠stica</button>
                <button onclick="changeMasterView('reporte_teka')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Maestro</button>
                <button onclick="changeMasterView('contabilidad')" class="view-btn py-1 px-4 rounded-full font-black text-[9px] uppercase bg-gray-100 text-gray-500 italic">Caja</button>
            </nav>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-8">
            
            <!-- FORMULARIO PRINCIPAL -->
            <div id="formContainer" class="lg:col-span-2 space-y-4 admin-only no-print">
                <div class="bg-white p-4 rounded-3xl shadow-lg"><input type="date" id="filterDateInput" onchange="syncDates('filterDateInput')" class="bg-slate-50 p-3 rounded-xl text-xl font-black italic text-fix-blue outline-none border-none shadow-inner w-full text-center font-mono"></div>
                <div class="bg-white p-6 rounded-[2rem] shadow-xl border-[8px] border-slate-50">
                    <form id="visitForm" onsubmit="event.preventDefault(); saveVisit();">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <input type="text" name="nombreCliente" placeholder="CLIENTE*" required class="p-3 bg-slate-50 rounded-xl font-bold uppercase shadow-inner text-xs font-black"><input type="text" name="callePrincipal" placeholder="CALLE*" required class="p-3 bg-yellow-50 rounded-xl font-bold uppercase shadow-inner text-xs font-black"><input type="text" name="cedula" placeholder="C√âDULA*" class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner text-center font-mono"><input type="tel" name="telefono" placeholder="TEL√âFONO*" required class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner text-center font-mono font-black"><input type="email" name="email" placeholder="CORREO" class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner"><input type="text" name="numFactura" placeholder="N¬∞ FACTURA*" class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner text-center uppercase font-black"><input type="text" name="direccion" placeholder="LINK GPS*" required class="p-3 bg-slate-50 rounded-xl font-bold text-xs shadow-inner md:col-span-2"><select name="tecnico" id="selectTecnico" class="p-3 bg-slate-50 rounded-xl font-bold text-[10px] uppercase italic font-black"></select><select id="selectLugar" name="lugarCompra" class="p-3 bg-slate-50 rounded-xl font-bold text-[10px] uppercase italic font-black"></select><div class="flex flex-col"><span class="text-[8px] font-black text-slate-400 ml-2 italic">EMISI√ìN FACTURA</span><input type="date" name="fechaEmision" id="inputEmision" class="p-3 bg-slate-50 rounded-xl font-bold text-xs outline-none shadow-inner text-center font-mono"></div><select name="tipoServicioGlobal" class="p-3 bg-white border-2 border-fix-blue/10 rounded-xl font-black text-[10px] uppercase text-fix-blue italic"><option value="Instalaci√≥n">Instalaci√≥n Est√°ndar</option><option value="Garant√≠a">Garant√≠a de F√°brica</option><option value="Fuera de Garant√≠a">Fuera de Garant√≠a</option></select><div class="bg-slate-50 p-3 rounded-xl flex items-center justify-between shadow-inner"><span class="text-[10px] font-black italic">EQUIPOS:</span><input type="number" id="numEquipos" name="numEquipos" value="1" min="1" oninput="expandEquipmentUI()" class="w-10 text-center text-xl text-fix-blue bg-transparent outline-none font-black font-mono"></div>
                        </div>
                        <div id="productInputsContainer" class="space-y-2"></div>
                        <div id="accesoriosContainerAdmin" class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-4 italic font-black"></div>
                        <div class="mt-8 grid grid-cols-3 gap-2 text-center">
                            <div class="bg-slate-50 p-2 rounded-xl italic text-[8px]">M.O. (MAESTRO)<br><span id="displayCostoInstalacion" class="text-sm font-black">$0.00</span></div>
                            <div class="bg-slate-50 p-2 rounded-xl italic text-[8px]">INSUMOS<br><span id="displayTotalAccesorios" class="text-sm font-black">$0.00</span></div>
                            <div class="bg-fix-accent p-2 rounded-xl font-black text-white shadow-lg uppercase">TOTAL CAJA<br><span id="displayTotalFinal" class="text-lg font-mono">$0.00</span></div>
                        </div>
                        <p class="text-[7px] text-center text-slate-400 mt-2 italic">* SI HAY 2+ EQUIPOS, EL TOTAL DE CAJA SOLO INCLUIR√Å INSUMOS.</p>
                        <button type="submit" class="w-full bg-fix-blue text-white py-4 rounded-2xl mt-4 text-lg font-black uppercase italic shadow-lg active:scale-95 transition-all">üöÄ AGENDAR VISITA</button>
                    </form>
                </div>
            </div>

            <!-- AGENDA LOCAL -->
            <div id="agendaContainer" class="lg:col-span-1 admin-only uppercase font-black"><h2 class="text-xl font-black uppercase italic mb-4 border-b-4 border-fix-blue text-slate-800 text-center font-sans italic">Agenda Local</h2><div class="mb-4 relative font-black"><input type="text" id="searchClientInput" oninput="renderUIAgenda()" placeholder="üîç BUSCAR CLIENTE..." class="w-full p-4 bg-white rounded-2xl shadow-md border-2 border-slate-100 font-black text-xs uppercase italic outline-none focus:border-fix-blue transition-all"></div><div id="visitsList" class="space-y-3 max-h-[700px] overflow-y-auto pr-2"></div></div>

            <!-- VISTA MANTENIMIENTOS -->
            <div id="mantenimientoView" class="hidden lg:col-span-3 space-y-6">
                <div class="bg-white p-6 rounded-[2rem] shadow-xl border-[8px] border-slate-50 font-black italic">
                    <h2 class="text-xl font-black uppercase mb-6 border-b-4 border-fix-blue pb-2 font-sans italic">MANTENIMIENTOS FIX - REGISTRO</h2>
                    <form id="maintForm" onsubmit="event.preventDefault(); saveMantenimiento();">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 uppercase font-black">
                            <input type="text" name="mNombre" placeholder="CLIENTE*" required class="p-4 bg-slate-50 rounded-xl font-black shadow-inner uppercase text-sm">
                            <input type="tel" name="mTelefono" placeholder="TEL√âFONO*" required class="p-4 bg-slate-50 rounded-xl font-black shadow-inner font-mono text-sm">
                            <input type="text" name="mCalle" placeholder="CALLE*" required class="p-4 bg-yellow-50 rounded-xl font-bold uppercase shadow-inner text-sm">
                            <input type="text" name="mDireccion" placeholder="LINK GPS*" required class="p-4 bg-slate-50 rounded-xl font-black shadow-inner text-sm">
                            <input type="text" name="mEquipo" placeholder="EQUIPO*" required class="p-4 bg-slate-50 rounded-xl font-black shadow-inner text-sm">
                            <select name="mTecnico" id="selectTecnicoMaint" class="p-4 bg-slate-50 rounded-xl font-black shadow-inner uppercase italic text-sm"></select>
                            <input type="number" name="mPrecio" placeholder="VALOR $" step="0.01" class="p-4 bg-blue-50 border border-fix-blue/20 rounded-xl font-black text-fix-blue font-mono text-sm">
                            <select name="mPago" class="p-4 bg-slate-50 rounded-xl font-black shadow-inner italic text-sm">
                                <option value="EFECTIVO">EFECTIVO</option>
                                <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                            </select>
                        </div>
                        <button type="submit" class="w-full bg-fix-blue text-white py-4 rounded-2xl mt-6 text-lg font-black uppercase italic shadow-lg">üíæ REGISTRAR MANTENIMIENTO</button>
                    </form>
                </div>
                <div class="bg-white p-6 rounded-[2rem] shadow-xl font-black">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg uppercase underline font-sans italic">REPORTE EXCLUSIVO MANTENIMIENTOS</h2>
                        <button onclick="downloadMantenimientoCSV()" class="bg-fix-report text-white px-4 py-2 rounded-full font-black text-[9px] uppercase shadow-md italic">üìä EXCEL MANTENIMIENTOS</button>
                    </div>
                    <div class="overflow-x-auto border-2 border-slate-50 rounded-xl">
                        <table class="w-full border-collapse admin-table font-black">
                            <thead>
                                <tr class="bg-slate-900 text-white text-[8px] uppercase"><th>Fecha</th><th>Cliente</th><th>Tel√©fono</th><th>Calle</th><th>Equipo</th><th>Valor</th><th>Est.</th><th>X</th></tr>
                            </thead>
                            <tbody id="mantenimientoReporteBody" class="uppercase italic"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VISTA INVENTARIO -->
            <div id="inventoryView" class="hidden lg:col-span-3 space-y-6">
                <div class="bg-white p-6 rounded-[2rem] shadow-xl border-[8px] border-slate-50 font-black italic uppercase">
                    <h2 class="text-xl font-black uppercase mb-6 border-b-4 border-fix-report pb-2 font-sans italic text-fix-report">CONTROL DE INVENTARIO Y STOCK</h2>
                    
                    <div class="bg-slate-50 p-6 rounded-2xl mb-8 flex flex-wrap gap-4 items-end border border-slate-200">
                        <div class="flex-grow">
                            <label class="text-[8px] ml-2">ACCESORIO / INSUMO</label>
                            <select id="invAccSelect" class="w-full p-3 bg-white rounded-xl border font-black text-xs uppercase"></select>
                        </div>
                        <div class="w-32">
                            <label class="text-[8px] ml-2">CANTIDAD ENTRADA</label>
                            <input type="number" id="invQty" placeholder="0" class="w-full p-3 bg-white rounded-xl border text-center font-black font-mono">
                        </div>
                        <button onclick="saveInventoryEntry()" class="bg-fix-report text-white px-8 py-3 rounded-xl font-black text-xs shadow-lg active:scale-95 transition-all italic">üíæ REGISTRAR INGRESO</button>
                    </div>

                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-sans underline italic">BALANCE GENERAL DE INSUMOS</h3>
                        <button onclick="downloadInventoryCSV()" class="bg-slate-800 text-white px-4 py-2 rounded-full font-black text-[9px] uppercase shadow-md italic">üìä EXPORTAR STOCK</button>
                    </div>

                    <div class="overflow-x-auto border-2 border-slate-50 rounded-xl">
                        <table class="w-full border-collapse admin-table">
                            <thead>
                                <tr class="bg-slate-900 text-white text-[8px] uppercase">
                                    <th class="text-left">Nombre del Insumo</th>
                                    <th>Total Entradas</th>
                                    <th>Utilizado</th>
                                    <th>Stock Disponible</th>
                                    <th class="text-right">PVP Estimado</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody" class="font-bold"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- LOG√çSTICA (OPTIMIZADO v1.9.8) -->
            <div id="ruteroView" class="hidden lg:col-span-3 bg-white p-4 rounded-[2rem] shadow-xl">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 px-2 gap-2">
                    <h2 class="text-sm font-black uppercase italic font-sans">Log√≠stica Diaria</h2>
                    <div class="flex gap-2 w-full md:w-auto">
                        <select id="ruteroTechFilter" onchange="renderRutero()" class="admin-only flex-grow p-1.5 bg-slate-100 rounded-lg text-[9px] font-black outline-none border-none italic uppercase"></select>
                        <input type="date" id="filterDateInputRutero" onchange="syncDates('filterDateInputRutero')" class="p-1.5 rounded-lg text-xs font-black italic text-fix-blue outline-none shadow-sm border font-mono">
                    </div>
                </div>
                <div class="overflow-x-auto w-full border-2 border-slate-50 rounded-2xl shadow-inner font-black uppercase">
                    <table class="w-full border-collapse rutero-table">
                        <thead>
                            <tr class="bg-slate-900 text-white text-[7px] uppercase">
                                <th class="w-12">Hora</th>
                                <th class="text-left w-32">Cliente</th>
                                <th class="text-left w-40">Calle Principal</th>
                                <th class="w-20">Servicio</th>
                                <th class="w-10">T√©c</th>
                                <th class="w-16">Estado</th>
                                <th class="w-24">Mapa</th>
                                <th class="w-32">Contacto</th>
                                <th class="w-10 admin-only">Adm</th>
                            </tr>
                        </thead>
                        <tbody id="ruteroListBody" class="uppercase italic font-black"></tbody>
                    </table>
                </div>
            </div>

            <!-- MAESTRO -->
            <div id="reporteTekaView" class="hidden lg:col-span-3 bg-white p-6 rounded-[2rem] shadow-xl font-black uppercase">
                <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-6">
                    <div>
                        <h2 class="text-lg font-black uppercase italic font-sans italic underline text-fix-blue">Maestro SAP (21 Columnas)</h2>
                        <div class="flex gap-2 mt-2 font-black">
                            <input type="date" id="maestroDateStart" class="bg-slate-50 p-1 rounded text-[10px] outline-none border font-black">
                            <input type="date" id="maestroDateEnd" class="bg-slate-50 p-1 rounded text-[10px] outline-none border font-black">
                            <button onclick="renderReporteTeka()" class="bg-fix-blue text-white px-2 rounded text-[10px]">VER</button>
                        </div>
                    </div>
                    <button onclick="downloadCSV()" class="bg-fix-report text-white px-4 py-2 rounded-full font-black text-[9px] uppercase shadow-md italic">üìä DESCARGAR SAP FINAL</button>
                </div>
                <div class="overflow-x-auto border-2 border-slate-50 rounded-xl">
                    <table class="w-full border-collapse admin-table">
                        <thead>
                            <tr class="bg-slate-900 text-white text-[7px] uppercase">
                                <th class="bg-slate-800">NRO</th><th>FECHA DE EMISI√ìN</th><th>LUGAR DE COMPRA</th><th>FACTURA</th><th>C√ìDIGO</th><th>DESCRIPCI√ìN</th><th>SERIE</th><th>SAP</th><th>T√âCNICO</th><th>CIUDAD</th><th>FECHA ATENCI√ìN</th><th>CLIENTE</th><th>CALLE</th><th>TEL√âFONO</th><th>PRECIO</th><th>LLEGADA INFO</th><th>T√âCNICO ATENDI√ì</th><th>VI√ÅTICO</th><th>FACTURA REP</th><th>C√âDULA</th><th>CORREO</th><th>X</th>
                            </tr>
                        </thead>
                        <tbody id="tekaReporteBody" class="uppercase font-bold"></tbody>
                    </table>
                </div>
            </div>

            <!-- CAJA v2.0 (CASH ONLY) -->
            <div id="contabilidadView" class="hidden lg:col-span-3 space-y-6">
                <div class="bg-white p-6 rounded-[2rem] shadow-xl font-black uppercase">
                    <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-6">
                        <div>
                            <h2 class="text-lg font-black uppercase underline font-sans italic">CONTABILIDAD Y CAJA (EFECTIVO)</h2>
                            <div class="flex flex-wrap gap-2 mt-2 font-black">
                                <input type="date" id="cajaDateStart" class="bg-slate-50 p-1 rounded text-[10px] outline-none border font-black">
                                <input type="date" id="cajaDateEnd" class="bg-slate-50 p-1 rounded text-[10px] outline-none border font-black">
                                <select id="cajaTechFilter" onchange="processFinancialBalance()" class="bg-slate-50 p-1 rounded text-[10px] outline-none border font-black"></select>
                                <button onclick="processFinancialBalance()" class="bg-fix-blue text-white px-2 rounded text-[10px]">VER PERIODO</button>
                            </div>
                        </div>
                        <button onclick="downloadCajaCSV()" class="bg-fix-report text-white px-4 py-2 rounded-full font-black text-[9px] uppercase shadow-md italic">üìä EXCEL CAJA</button>
                    </div>

                    <!-- DASHBOARD DE CAJA (L√ìGICA DE DINERO F√çSICO) -->
                    <div class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-6 text-center italic font-black">
                        <div class="p-3 bg-green-50 rounded-xl border border-green-100 flex flex-col justify-center">
                            <span class="text-[8px] uppercase text-slate-500">INGRESOS (EFECTIVO)</span>
                            <div id="totalEfectivoDisplay" class="text-lg font-black text-green-700">$0.00</div>
                        </div>
                        <div class="p-3 bg-red-50 rounded-xl border border-red-100 flex flex-col justify-center">
                            <span class="text-[8px] uppercase text-slate-500">EGRESOS / GASTOS</span>
                            <div id="totalEgresosDisplay" class="text-lg font-black text-red-700">$0.00</div>
                        </div>
                        <div class="p-3 bg-slate-900 rounded-xl text-white shadow-xl col-span-2 md:col-span-1 flex flex-col justify-center">
                            <span class="text-[8px] uppercase text-fix-accent">SALDO NETO (CASH)</span>
                            <div id="balanceNetoDisplay" class="text-xl font-black text-fix-accent">$0.00</div>
                        </div>
                        <div class="p-3 bg-blue-50 rounded-xl border border-blue-100 flex flex-col justify-center opacity-60">
                            <span class="text-[8px] uppercase text-slate-500">BANCO (TRANSFER.)</span>
                            <div id="totalTransferDisplay" class="text-lg font-black text-blue-700">$0.00</div>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl border border-slate-200 flex flex-col justify-center opacity-40">
                            <span class="text-[8px] uppercase text-slate-500">VENTA TOTAL PERIODO</span>
                            <div id="totalIngresosDisplay" class="text-lg font-black text-slate-600">$0.00</div>
                        </div>
                    </div>

                    <div class="bg-slate-50 p-4 rounded-xl mb-6 grid grid-cols-1 md:grid-cols-5 gap-2 items-end italic font-black border border-slate-200">
                        <div class="md:col-span-1"><label class="text-[7px] ml-2">CONCEPTO</label><input type="text" id="movConcepto" placeholder="CONCEPTO..." class="w-full p-2 rounded-lg font-bold outline-none border text-xs"></div>
                        <div><label class="text-[7px] ml-2">MONTO $</label><input type="number" id="movMonto" placeholder="$0" class="w-full p-2 rounded-lg text-right font-black border text-xs font-mono"></div>
                        <div><label class="text-[7px] ml-2">TIPO</label><select id="movType" class="w-full p-2 rounded-lg font-black bg-white border text-[10px]"><option value="EGRESO">‚ûñ EGRESO</option><option value="INGRESO">‚ûï INGRESO</option></select></div>
                        <div><label class="text-[7px] ml-2">PAGO/T√âCNICO</label>
                            <div class="flex gap-1">
                                <select id="movPago" class="w-1/2 p-2 rounded-lg font-black bg-white border text-[8px]"><option value="EFECTIVO">EFECT.</option><option value="TRANSFERENCIA">TRANS.</option></select>
                                <select id="movTecnico" class="w-1/2 p-2 rounded-lg font-black bg-white border text-[8px]"></select>
                            </div>
                        </div>
                        <button onclick="saveManualMovement()" class="bg-fix-blue text-white py-2 rounded-lg font-black text-xs shadow-md hover:scale-95 transition-all">REGISTRAR</button>
                    </div>
                    
                    <div class="overflow-x-auto rounded-xl border border-slate-100">
                        <table class="w-full text-left admin-table font-mono"><thead><tr class="text-[9px] uppercase"><th>FECHA/T√âCNICO</th><th>TIPO/PAGO</th><th>DETALLE</th><th class="text-right">MONTO</th><th class="text-center">X</th></tr></thead><tbody id="contabilidadTableBody"></tbody></table>
                    </div>
                </div>

                <!-- CUADRO DE RESUMEN FINAL DE REPORTE -->
                <div class="bg-slate-900 p-8 rounded-[3rem] shadow-2xl text-white font-black italic border-[10px] border-white">
                    <div class="flex justify-between items-center border-b border-white/20 pb-4 mb-6">
                        <h2 class="text-xl uppercase tracking-tighter">Resumen de Caja Diaria</h2>
                        <span class="text-[10px] px-3 py-1 bg-white text-slate-900 rounded-full italic">CASH ONLY</span>
                    </div>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center text-lg">
                            <span class="text-slate-400">INGRESOS EN EFECTIVO:</span>
                            <span id="finalReportIngresos" class="text-green-400 font-mono">+$0.00</span>
                        </div>
                        <div class="flex justify-between items-center text-lg">
                            <span class="text-slate-400">TOTAL EGRESOS / GASTOS:</span>
                            <span id="finalReportEgresos" class="text-red-400 font-mono">-$0.00</span>
                        </div>
                        <div class="pt-4 border-t-2 border-dashed border-white/30 flex justify-between items-end">
                            <div class="flex flex-col">
                                <span class="text-[9px] text-fix-accent uppercase font-bold tracking-widest italic">A entregar por el t√©cnico</span>
                                <span class="text-4xl uppercase tracking-tighter">TOTAL CAJA</span>
                            </div>
                            <span id="finalReportNeto" class="text-5xl font-mono tracking-tighter">$0.00</span>
                        </div>
                        <p class="text-[8px] text-slate-500 mt-4 italic">* Las transferencias no se incluyen en este balance por ir directamente a banco.</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- MODAL DE AJUSTE FINANCIERO -->
    <div id="editFinanceModal" class="hidden fixed inset-0 z-[20000] modal-overlay flex items-center justify-center p-4"><div class="bg-white w-full max-sm rounded-[2rem] shadow-2xl p-8 font-black border-[6px] border-slate-50 uppercase italic"><h2 class="text-xl font-black uppercase text-fix-blue mb-4 border-b-2 pb-2">VALOR REAL</h2><input type="hidden" id="finance_id"><input type="hidden" id="finance_source"><div class="space-y-4"><input type="text" id="finance_concepto" class="w-full p-3 bg-slate-50 rounded-xl border font-black text-xs"><input type="number" step="0.01" id="finance_monto" class="w-full p-3 bg-yellow-50 rounded-xl border font-mono font-black text-xl text-right"></div><div class="grid grid-cols-2 gap-3 mt-6"><button onclick="saveFinanceAdjustment()" class="bg-fix-report text-white py-3 rounded-xl font-black shadow-lg">üíæ AJUSTAR</button><button onclick="closeEditFinanceModal()" class="bg-slate-200 text-slate-600 py-3 rounded-xl font-black">SALIR</button></div></div></div>

    <!-- MODAL DE EDICI√ìN ADMINISTRATIVA AVANZADA -->
    <div id="editModal" class="hidden fixed inset-0 z-[20000] modal-overlay flex items-center justify-center p-4 font-black">
        <div class="bg-white w-full max-w-3xl rounded-[2rem] shadow-2xl p-8 font-black italic border-[6px] border-slate-50 uppercase overflow-y-auto max-h-[95vh]">
            <h2 class="text-xl font-black uppercase text-fix-blue mb-6 border-b-2 pb-2 italic uppercase">CORRECCI√ìN ADMINISTRATIVA</h2>
            <input type="hidden" id="edit_id">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                <div><label class="text-[7px] text-slate-400 ml-2">NOMBRE CLIENTE</label><input type="text" id="edit_nombre" class="w-full p-2 bg-slate-50 rounded-lg border font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">TEL√âFONO</label><input type="text" id="edit_telefono" class="w-full p-2 bg-slate-50 rounded-lg border font-mono font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">CORREO</label><input type="email" id="edit_email" class="w-full p-2 bg-slate-50 rounded-lg border font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">C√âDULA</label><input type="text" id="edit_cedula" class="w-full p-2 bg-slate-50 rounded-lg border font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">N¬∞ FACTURA</label><input type="text" id="edit_numFactura" class="w-full p-2 bg-slate-50 rounded-lg border font-black text-xs"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">LUGAR COMPRA</label><select id="edit_lugarCompra" class="w-full p-2 bg-slate-50 rounded-lg border font-black text-[10px]"></select></div>
                <div><label class="text-[7px] text-slate-400 ml-2">FECHA</label><input type="date" id="edit_fecha" class="w-full p-2 bg-slate-50 rounded-lg border font-black text-xs font-mono"></div>
                <div><label class="text-[7px] text-slate-400 ml-2">T√âCNICO</label><select id="edit_tecnico" class="w-full p-2 bg-slate-50 rounded-lg border font-black text-[10px]"></select></div>
                <div><label class="text-[7px] text-slate-400 ml-2">PRIORIDAD</label><input type="number" id="edit_priority" class="w-full p-2 bg-yellow-50 rounded-lg border font-black text-xs font-mono"></div>
                <div class="md:col-span-3"><label class="text-[7px] text-slate-400 ml-2">LINK GPS / DIRECCI√ìN</label><input type="text" id="edit_direccion" class="w-full p-2 bg-slate-50 rounded-lg border font-black text-xs"></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
                <div class="p-4 bg-slate-100 rounded-2xl">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-[10px] font-black text-fix-blue">EQUIPOS REGISTRADOS</h3>
                        <div class="flex items-center gap-2">
                            <label class="text-[8px]">CANT:</label>
                            <input type="number" id="edit_numEquipos" min="1" oninput="rebuildEditEquipmentInputs([])" class="w-10 text-center bg-white rounded border font-black text-xs">
                        </div>
                    </div>
                    <div id="editEquiposContainer" class="space-y-2 max-h-48 overflow-y-auto pr-1"></div>
                </div>
                <div class="p-4 bg-slate-100 rounded-2xl">
                    <h3 class="text-[10px] font-black text-fix-report mb-3">INSUMOS Y ACCESORIOS</h3>
                    <div id="editAccesoriosContainer" class="space-y-1 max-h-48 overflow-y-auto pr-1"></div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 italic font-black uppercase">
                <button onclick="saveEditChanges()" class="bg-fix-report text-white py-4 rounded-xl font-black shadow-lg active:scale-95 transition-all">üíæ APLICAR CORRECCIONES</button>
                <button onclick="closeEditModal()" class="bg-slate-200 text-slate-600 py-4 rounded-xl font-black">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- BOT√ìN ACTUALIZAR -->
    <button onclick="refreshData()" class="btn-refresh-float no-print" title="Actualizar"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg></button>

    <div id="messageBox" class="opacity-0 fixed transition-opacity duration-500 pointer-events-none z-[99999] font-black uppercase"></div>

</body>
</html>
