¬°Absolutamente! Es la forma m√°s segura de evitar errores de copiado/pegado.

Aqu√≠ tienes el c√≥digo completo y actualizado de tu archivo index.html. Incluye:

M√∫ltiples Equipos Din√°micos en el formulario.

Filtro "Mi Rutero" y la Vista Admin.

El Modal de Reporte del T√©cnico (Cobro/Accesorios).

La nueva vista "Contabilidad (Ingresos/Egresos)" con registro de egresos manual y consolidaci√≥n de ingresos autom√°tica.

Instrucci√≥n: Borra todo el contenido de tu archivo index.html y pega el c√≥digo siguiente.

HTML

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIX - Gesti√≥n de Visitas Diarias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'fix-blue': '#1e3a8a',
                        'fix-light': '#3b82f6',
                        'fix-accent': '#f59e0b',
                        'fix-report': '#059669',
                        'fix-error': '#dc2626',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos CSS simplificados */
        .currency-input { text-align: right; font-family: monospace; }
        .modal { transition: opacity 0.3s ease-out, visibility 0.3s ease-out; }
        
        /* Estilos de Impresi√≥n */
        @media print { 
            .no-print { display: none !important; } 
            .grid { display: block; }
        }
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

    <script>
        // üö® TU OBJETO DE CONFIGURACI√ìN FIREBASE üö®
        const firebaseConfig = {
          apiKey: "AIzaSyCiESorKZljYeFHr19c_XPth2qWluz1Dro",
          authDomain: "fix-agenda-app.firebaseapp.com",
          projectId: "fix-agenda-app",
          storageBucket: "fix-agenda-app.firebasestorage.app",
          messagingSenderId: "98719439808",
          appId: "1:98719439808:web:66576c19c8b5233a718625",
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // VARIABLES GLOBALES
        let filterDate = new Date().toISOString().split('T')[0];
        let currentView = 'reporte_admin';
        let globalVisitsData = {}; // Objeto para almacenar datos de Firebase
        let visitsArray = []; // Array de datos
        let filterTecnico = "";
        const TECNICO_ACTUAL_DEMO = "Cristian Capelo"; // Usado como DEMO para "Mi Rutero"

        // LISTAS Y DATOS (ESTABLES)
        const LISTA_TECNICOS = [ "", "Juan Carlos Pando", "Cristian Capelo", "Allan Skykaz", "Andres Cardenas", "Juani Cardenas" ];
        const LUGARES_COMPRA = [ "", "Comercial Solis", "Comercial Kywi", "Como Hogar", "Sukasa", "Comercial Luna Pazmi√±o", "Macaofertas", "Mercard", "Home Vega" ];
        const ACCESORIOS_DEFAULT = { 'Enchufe 110V': 5, 'Enchufe 220V 20V': 7, 'Enchufe 220V 50V': 10, 'Manguera c/bridas': 4, 'Ducto 4 pulgadas metro': 5, 'Enchufe chinito': 5 };
        const CATALOGO_PRODUCTOS = {"112580027": "GBC 75030 KBB CRISTAL COCINA GAS", "915061": "ASP. AXIAL BLIND 100 110V-60HZ"};
        const COSTOS_INSTALACION = {'cocina induccion': 25, 'default': 0};
        
        // TIPOS DE SERVICIO (Restaurados)
        const TIPOS_SERVICIO = [
            "Inst. Cocina Inducci√≥n", "Inst. Cocina a Gas", "Inst. Horno a Gas", 
            "Inst. Horno El√©ctrico", "Inst. Microondas", "Inst. Refrigerador",
            "Inst. Lavavajillas", "Inst. Triturador", "Inst. Fregadero", 
            "Inst. Grifer√≠a", "Inst. Campana Tradicional", "Inst. Campana Decorativa",
            "Inst. Campana Isla", "Garant√≠a", "Mantenimiento"
        ];
        
        // --- FUNCIONES CORE Y UTILITARIAS ---

        function showMessage(message, color) {
            const messageBox = document.getElementById('messageBox');
            if (!messageBox) return;
            messageBox.textContent = message;
            messageBox.className = `p-3 rounded-lg text-white bg-${color} mb-4 transition-opacity duration-300`;
            messageBox.style.opacity = 1;
            setTimeout(() => { messageBox.style.opacity = 0; }, 8000);
        }

        function calcularCostoAccesorios() {
            let totalAccesorios = 0;
            const container = document.getElementById('accesoriosContainer');
            if (!container) return 0;
            const accessoryItems = container.querySelectorAll('.accessory-item');
            accessoryItems.forEach(item => {
                const quantityInput = item.querySelector('input[name^="acc_qty_"]');
                const priceInput = item.querySelector('input[name^="acc_price_"]');
                const cantidad = parseInt(quantityInput.value) || 0;
                const precio = parseFloat(priceInput.value) || 0;
                totalAccesorios += cantidad * precio;
            });
            return totalAccesorios;
        }

        function updateInstallationCost() {
            const tipoServicio = document.querySelector('select[name="tipoServicio"]').value; 
            const costoInstalacion = COSTOS_INSTALACION['cocina induccion']; 
            
            if(document.getElementById('costoInstalacionHidden')) document.getElementById('costoInstalacionHidden').value = costoInstalacion.toFixed(2);
            window.updateTotalCobro();
            
            const numEquiposLabel = document.getElementById('numEquiposLabel');
            if (numEquiposLabel) {
                 if (tipoServicio.includes('garantia') || tipoServicio.includes('mantenimiento')) {
                    numEquiposLabel.textContent = 'Cantidad de Equipos a Revisar*';
                } else {
                    numEquiposLabel.textContent = 'Cantidad de Equipos a Instalar*';
                }
            }
            handleEquipmentCountChange(); 
        }

        function updateTotalCobro() {
            const costoInstalacion = parseFloat(document.getElementById('costoInstalacionHidden').value) || 0;
            const totalAccesorios = calcularCostoAccesorios(); 
            if(document.getElementById('cobroAccesoriosHidden')) document.getElementById('cobroAccesoriosHidden').value = totalAccesorios.toFixed(2);
            const totalCliente = costoInstalacion + totalAccesorios; 
            if(document.getElementById('totalClienteDisplay')) document.getElementById('totalClienteDisplay').textContent = `$${totalCliente.toFixed(2)}`;
            if(document.getElementById('totalAccesoriosDisplay')) document.getElementById('totalAccesoriosDisplay').textContent = `$${totalAccesorios.toFixed(2)}`;
        }
        
        function createAccessoryInputRow(name, price, isCustom = false) {
            const id = name.replace(/\s/g, '_').toLowerCase() + '_' + Date.now();
            const div = document.createElement('div');
            div.className = 'accessory-item grid grid-cols-5 gap-2 items-center p-2 bg-white rounded-md shadow-sm border border-gray-200 mb-2';
            div.innerHTML = `
                <div class="col-span-2 text-sm text-gray-700 font-medium truncate" title="${name}">${name}</div>
                <input type="number" step="1" min="0" value="0" name="acc_qty_${id}" oninput="updateTotalCobro()" class="w-full text-center rounded-md border-gray-300 focus:ring-fix-light p-1 text-sm font-bold">
                <input type="number" step="0.01" value="${price.toFixed(2)}" name="acc_price_${id}" oninput="updateTotalCobro()" class="w-full currency-input rounded-md border-gray-300 focus:ring-fix-light p-1 text-sm ${isCustom ? 'bg-yellow-50' : 'bg-gray-100'}">
                <div class="text-right">${isCustom ? `<button type="button" onclick="removeAccessory(this, '${name}')" class="text-red-500 hover:text-red-700 transition duration-150">X</button>` : ''}</div>
            `;
            return div;
        }

        function renderAccessoryInputs() {
            const container = document.getElementById('accesoriosContainer');
            if (container) {
                container.innerHTML = '';
                Object.entries(ACCESORIOS_DEFAULT).forEach(([name, price]) => {
                    container.appendChild(createAccessoryInputRow(name, price));
                });
                window.updateTotalCobro();
            }

            // üõ†Ô∏è Llenar Men√∫s Desplegables
            const tecnicoSelect = document.querySelector('select[name="tecnico"]');
            if (tecnicoSelect) { tecnicoSelect.innerHTML = ''; LISTA_TECNICOS.forEach(name => { const option = document.createElement('option'); option.value = name; option.textContent = name || "--- Seleccionar T√©cnico ---"; tecnicoSelect.appendChild(option); }); }
            
            const lugarCompraSelect = document.querySelector('select[name="lugarCompra"]');
            if (lugarCompraSelect) { lugarCompraSelect.innerHTML = ''; LUGARES_COMPRA.forEach(place => { const option = document.createElement('option'); option.value = place; option.textContent = place || "--- Seleccionar Lugar ---"; lugarCompraSelect.appendChild(option); }); }
            
            const filterTecnicoSelect = document.getElementById('filterTecnicoInput');
            if (filterTecnicoSelect) { 
                filterTecnicoSelect.innerHTML = ''; 
                const allOption = document.createElement('option');
                allOption.value = ""; allOption.textContent = "TODOS LOS T√âCNICOS"; filterTecnicoSelect.appendChild(allOption);
                LISTA_TECNICOS.slice(1).forEach(name => { const option = document.createElement('option'); option.value = name; option.textContent = name; filterTecnicoSelect.appendChild(option); });
            }
            
            // üõ†Ô∏è Llenar Tipo de Servicio Principal
            const tipoServicioSelect = document.querySelector('select[name="tipoServicio"]');
            if (tipoServicioSelect) {
                tipoServicioSelect.innerHTML = '';
                TIPOS_SERVICIO.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo.toLowerCase().replace(/ /g, '_');
                    option.textContent = tipo;
                    tipoServicioSelect.appendChild(option);
                });
            }

            window.updateInstallationCost();
        }

        function handleEquipmentCountChange() {
            const numEquiposInput = document.getElementById('numEquipos');
            const numEquipos = parseInt(numEquiposInput.value) || 1;
            const productInputsContainer = document.getElementById('productInputsContainer');
            
            if (!productInputsContainer) return;

            productInputsContainer.innerHTML = ''; 
            
            for (let i = 1; i <= numEquipos; i++) {
                const isMain = i === 1;
                const fieldTitle = isMain ? 'Principal' : `Adicional #${i}`;
                
                const productBlock = document.createElement('div');
                productBlock.className = 'grid grid-cols-1 md:grid-cols-4 gap-2 border-t pt-2 mt-2 border-gray-300';
                
                const serviceOptions = TIPOS_SERVICIO.map(tipo => `<option value="${tipo}">${tipo}</option>`).join('');

                productBlock.innerHTML = `
                    <p class="col-span-4 font-semibold text-sm text-gray-700 mt-2">Equipo ${fieldTitle}</p>
                    
                    <label class="block">
                        <span class="text-xs text-gray-700">C√≥digo Producto:</span>
                        <input type="text" name="codProducto_${i}" placeholder="C√≥digo" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm" ${isMain ? 'oninput="autofillProduct()"' : ''}>
                    </label>
                    
                    <label class="block">
                        <span class="text-xs text-gray-700">Serie del Equipo:</span>
                        <input type="text" name="serieEquipo_${i}" placeholder="Serie" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm">
                    </label>
                    
                    <label class="block">
                        <span class="text-xs text-gray-700">Descripci√≥n/Tipo:</span>
                        <select name="descProducto_${i}" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm">
                            <option value="" disabled selected>--- Seleccionar Tipo de Equipo ---</option>
                            ${serviceOptions}
                        </select>
                    </label>
                    
                    <label class="block">
                          <span class="text-xs text-gray-700">Costo Base:</span>
                          <input type="number" name="costoEquipo_${i}" placeholder="Costo ($)" value="0.00" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm">
                    </label>
                `;
                productInputsContainer.appendChild(productBlock);
            }
        }
        
        // --- L√ìGICA DE FIREBASE Y VISTAS ---

        function cargarDatos() {
            database.ref('visits').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    visitsArray = Object.keys(data).map(key => ({ ...data[key], id: key }));
                    globalVisitsData = data;
                } else {
                    globalVisitsData = {};
                    visitsArray = [];
                }
                setupVisitListener();
            });
        }
        
        function setupVisitListener() {
            let visits = [...visitsArray];
            
            // üö® L√ìGICA DE FILTRADO POR VISTA 
            if (currentView === 'my_agenda') {
                 visits = visits.filter(v => 
                     (v.tecnico === TECNICO_ACTUAL_DEMO || !v.tecnico) && 
                     v.fechaInstalacion === filterDate
                 );
                 const formContainer = document.getElementById('formContainer');
                 if(formContainer) formContainer.classList.add('hidden');
                 
            } else if (currentView === 'reporte_admin') {
                const formContainer = document.getElementById('formContainer');
                if(formContainer) formContainer.classList.remove('hidden');
                
                if (filterDate) {
                    visits = visits.filter(v => v.fechaInstalacion === filterDate);
                }
                if (filterTecnico) {
                    visits = visits.filter(v => v.tecnico === filterTecnico);
                }
            } else if (currentView === 'mantenimiento') { 
                 visits = visits.filter(v => v.tipoAtencion && v.tipoAtencion.includes('mantenimiento'));
            } else if (currentView === 'contabilidad') {
                // No renderiza visitas, la lista se usa para ingresos
            }
            
            // Ordenar por estado (PENDIENTE primero)
            visits.sort((a, b) => {
                const statusOrder = { 'PENDIENTE': 1, 'Novedad': 2, 'No Atendido': 3, 'Atendido': 4 };
                const aStatus = statusOrder[a.estado] || 5;
                const bStatus = statusOrder[b.estado] || 5;

                if (aStatus !== bStatus) return aStatus - bStatus;
                return (a.createdAt > b.createdAt) ? 1 : -1;
            });

            if (currentView !== 'contabilidad') {
                renderVisits(visits);
            }
        }

        window.saveVisit = async () => {
            const form = document.getElementById('visitForm');
            const data = new FormData(form);
            const visitData = {};
            for (let [key, value] of data.entries()) { visitData[key] = value.trim(); }

            if (!visitData.nombreCliente || !visitData.fechaInstalacion) {
                showMessage("Complete datos esenciales.", 'fix-accent');
                return;
            }

            const equipos = [];
            const numEquipos = parseInt(visitData.numEquipos) || 1;
            let totalInstalacionCost = 0;

            for(let i=1; i<=numEquipos; i++) {
                const costoEquipo = parseFloat(visitData[`costoEquipo_${i}`]) || 0;
                totalInstalacionCost += costoEquipo;

                equipos.push({
                    codProducto: visitData[`codProducto_${i}`] || '',
                    serieEquipo: visitData[`serieEquipo_${i}`] || '',
                    descProducto: visitData[`descProducto_${i}`] || '',
                    costoBase: costoEquipo,
                    isPrincipal: i === 1
                });
            }

            const newVisitRef = database.ref('visits').push(); 
            const newVisitId = newVisitRef.key;

            newVisitRef.set({
                id: newVisitId,
                nombreCliente: visitData.nombreCliente,
                fechaInstalacion: visitData.fechaInstalacion,
                estado: 'PENDIENTE',
                createdAt: Date.now(),
                tecnico: visitData.tecnico || 'N/A',
                fechaCompra: visitData.fechaCompra,
                lugarCompra: visitData.lugarCompra,
                numFactura: visitData.numFactura,
                direccion: visitData.direccion,
                telefono: visitData.telefono,
                cedula: visitData.cedula,
                correo: visitData.correo,
                tipoAtencion: visitData.tipoAtencion,
                numEquipos: numEquipos,
                equipos: equipos,
                financiera: {
                    totalCliente: totalInstalacionCost, 
                    costoInstalacion: totalInstalacionCost,
                    cobroAccesorios: 0.00
                }
            })
            .then(() => {
                showMessage(`‚úÖ Visita guardada.`, 'fix-report');
                form.reset();
                renderAccessoryInputs();
                setupVisitListener(); 
            })
            .catch(() => {
                showMessage(`‚ùå Error al guardar en DB.`, 'fix-error');
            });
        };

        // --- FUNCIONES DE MODAL DEL T√âCNICO ---

        window.openEditModal = (visitId) => {
            const visit = visitsArray.find(v => v.id === visitId);
            if (!visit) {
                showMessage('Error: Visita no encontrada.', 'fix-error');
                return;
            }

            const modal = document.getElementById('editModal');
            modal.classList.remove('invisible', 'opacity-0');
            
            document.getElementById('modalVisitId').value = visit.id;
            document.getElementById('modalClientName').textContent = visit.nombreCliente || 'N/A';
            document.getElementById('modalCurrentStatus').value = visit.estado || 'PENDIENTE';
            document.getElementById('modalObservaciones').value = visit.observacionesTecnico || '';
            
            const costoInstalacion = (visit.financiera && visit.financiera.costoInstalacion) || 0;
            const totalCliente = (visit.financiera && visit.financiera.totalCliente) || costoInstalacion;
            
            document.getElementById('modalCostoInstalacion').value = costoInstalacion.toFixed(2);
            document.getElementById('modalCostoInstalacionHidden').value = costoInstalacion.toFixed(2);
            document.getElementById('modalTotalCobro').value = totalCliente.toFixed(2);
            
            renderModalAccessoryInputs(visit.accesoriosVendidos);
        };

        window.closeEditModal = () => {
            const modal = document.getElementById('editModal');
            modal.classList.add('invisible', 'opacity-0');
            document.getElementById('editVisitForm').reset();
        };

        function renderModalAccessoryInputs(accesoriosPrevios = []) {
            const container = document.getElementById('modalAccesoriosContainer');
            if (!container) return;

            container.innerHTML = '';
            
            const prevMap = {};
            if (accesoriosPrevios && accesoriosPrevios.length > 0) {
                accesoriosPrevios.forEach(acc => { prevMap[acc.nombre] = acc; });
            }

            Object.entries(ACCESORIOS_DEFAULT).forEach(([name, price]) => {
                const id = name.replace(/\s/g, '_').toLowerCase();
                const valorPrevio = prevMap[name];
                const cantidad = valorPrevio ? valorPrevio.cantidad : 0;
                
                const div = document.createElement('div');
                div.className = 'accessory-item grid grid-cols-5 gap-2 items-center p-2 bg-white rounded-md shadow-sm border border-gray-200 mb-2';
                div.innerHTML = `
                    <div class="col-span-2 text-sm text-gray-700 font-medium truncate" title="${name}">${name}</div>
                    <input type="number" step="1" min="0" value="${cantidad}" name="acc_qty_${id}" oninput="updateModalTotalCobro()" class="w-full text-center rounded-md border-gray-300 focus:ring-fix-light p-1 text-sm font-bold">
                    <input type="number" step="0.01" value="${price.toFixed(2)}" name="acc_price_${id}" oninput="updateModalTotalCobro()" class="w-full currency-input rounded-md border-gray-300 focus:ring-fix-light p-1 text-sm bg-gray-100">
                    <div class="text-right"></div>
                `; 
                container.appendChild(div);
            });
            updateModalTotalCobro();
        }

        function updateModalTotalCobro() {
            let totalAccesorios = 0;
            const container = document.getElementById('modalAccesoriosContainer');
            if (!container) return;

            const accessoryItems = container.querySelectorAll('.accessory-item');
            accessoryItems.forEach(item => {
                const quantityInput = item.querySelector('input[name^="acc_qty_"]');
                const priceInput = item.querySelector('input[name^="acc_price_"]');
                const cantidad = parseInt(quantityInput.value) || 0;
                const precio = parseFloat(priceInput.value) || 0;
                totalAccesorios += cantidad * precio;
            });

            const costoInstalacion = parseFloat(document.getElementById('modalCostoInstalacionHidden').value) || 0;
            const totalClienteEstimado = costoInstalacion + totalAccesorios;

            document.getElementById('modalTotalAccesoriosDisplay').textContent = `$${totalAccesorios.toFixed(2)}`;
            document.getElementById('modalCobroAccesoriosHidden').value = totalAccesorios.toFixed(2);
            
            const totalCobroInput = document.getElementById('modalTotalCobro');
            // Suggest the new total, don't force it if the user manually entered a higher amount
            if (parseFloat(totalCobroInput.value) < totalClienteEstimado) {
                 totalCobroInput.value = totalClienteEstimado.toFixed(2);
            } else if (totalCobroInput.value === "" || totalCobroInput.value === "0.00") {
                totalCobroInput.value = totalClienteEstimado.toFixed(2);
            }
        }

        window.saveTechnicianReport = () => {
            const form = document.getElementById('editVisitForm');
            const data = new FormData(form);
            const reportData = {};
            for (let [key, value] of data.entries()) { reportData[key] = value.trim(); }

            const visitId = reportData.visitId;
            const totalCobro = parseFloat(reportData.totalCobro) || 0.00;
            const accesoriosCobro = parseFloat(reportData.cobroAccesoriosHidden) || 0.00;
            const observaciones = reportData.observaciones;

            if (!observaciones) {
                alert('Debe ingresar las Observaciones Finales para el reporte.');
                return;
            }

            const accesoriosVendidos = [];
            const accessoryItems = document.getElementById('modalAccesoriosContainer').querySelectorAll('.accessory-item');
            accessoryItems.forEach(item => {
                const nameElement = item.querySelector('div.col-span-2');
                const qtyInput = item.querySelector('input[name^="acc_qty_"]');
                const priceInput = item.querySelector('input[name^="acc_price_"]');
                
                const cantidad = parseInt(qtyInput.value) || 0;
                
                if (cantidad > 0) {
                    accesoriosVendidos.push({
                        nombre: nameElement.textContent,
                        cantidad: cantidad,
                        precio: parseFloat(priceInput.value) || 0,
                    });
                }
            });

            database.ref('visits/' + visitId).update({
                estado: 'Atendido',
                observacionesTecnico: observaciones,
                attendedDate: new Date().toISOString(),
                financiera: {
                    ...globalVisitsData[visitId].financiera,
                    totalCliente: totalCobro,
                    cobroAccesorios: accesoriosCobro
                },
                accesoriosVendidos: accesoriosVendidos
            })
            .then(() => {
                showMessage(`‚úÖ Reporte de servicio de ${document.getElementById('modalClientName').textContent} guardado.`, 'fix-report');
                closeEditModal();
                setupVisitListener(); 
                // No es necesario llamar a loadContabilidadData() aqu√≠, ya que se refresca con setupVisitListener
            })
            .catch((error) => {
                console.error("Error al guardar el reporte del t√©cnico: ", error);
                showMessage(`‚ùå Error al guardar el reporte.`, 'fix-error');
            });
        };

        window.changeVisitQuickStatus = (selectElement, visitId) => {
            const newStatus = selectElement.value;
            const currentVisit = visitsArray.find(v => v.id === visitId);

            if (newStatus === 'Atendido') {
                openEditModal(visitId);
                selectElement.value = currentVisit.estado || 'PENDIENTE';
                return;
            }
            
            const observaciones = prompt(`Ingrese el motivo para cambiar el estado a "${newStatus}":`);
            if (!observaciones) {
                selectElement.value = currentVisit.estado || 'PENDIENTE';
                return;
            }

            database.ref('visits/' + visitId).update({
                estado: newStatus,
                observacionesTecnico: observaciones,
                attendedDate: new Date().toISOString(),
            })
            .then(() => {
                showMessage(`‚úÖ Visita de ${currentVisit.nombreCliente} actualizada a: ${newStatus}`, 'fix-report');
                setupVisitListener();
            })
            .catch(() => {
                showMessage(`‚ùå Error al actualizar estado.`, 'fix-error');
            });
        }
        
        // --- FUNCIONES DE CONTABILIDAD (NUEVO) ---

        let egresosArray = [];
        let contabilidadStartDate = null;
        let contabilidadEndDate = null;

        function loadContabilidadData() {
            database.ref('egresos').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    egresosArray = Object.keys(data).map(key => ({ ...data[key], id: key }));
                } else {
                    egresosArray = [];
                }
                filterContabilidad(); // Filtrar y renderizar al cargar
            });
        }

        window.saveEgreso = () => {
            const form = document.getElementById('egresoForm');
            const data = new FormData(form);
            const egresoData = {};
            for (let [key, value] of data.entries()) { egresoData[key] = value.trim(); }

            const newEgresoRef = database.ref('egresos').push(); 
            newEgresoRef.set({
                id: newEgresoRef.key,
                type: 'EGRESO',
                monto: parseFloat(egresoData.montoEgreso),
                concepto: egresoData.conceptoEgreso,
                date: new Date().toISOString(),
                timestamp: Date.now()
            })
            .then(() => {
                showMessage(`‚úÖ Egreso de $${egresoData.montoEgreso} registrado.`, 'fix-report');
                form.reset();
            })
            .catch(() => {
                showMessage(`‚ùå Error al registrar egreso.`, 'fix-error');
            });
        };

        window.filterContabilidad = () => {
            contabilidadStartDate = document.getElementById('contabilidadStartDate').value;
            contabilidadEndDate = document.getElementById('contabilidadEndDate').value;
            
            let startTimestamp = contabilidadStartDate ? new Date(contabilidadStartDate).getTime() : 0;
            let endTimestamp = contabilidadEndDate ? new Date(contabilidadEndDate).getTime() + (24 * 60 * 60 * 1000) : Infinity;

            // 1. Recolectar Ingresos (Visitas ATENDIDAS)
            let filteredIngresos = visitsArray
                .filter(v => v.estado === 'Atendido' && v.financiera && v.financiera.totalCliente > 0)
                .filter(v => {
                    const date = v.attendedDate ? new Date(v.attendedDate).getTime() : v.createdAt;
                    return date >= startTimestamp && date <= endTimestamp;
                })
                .map(v => ({
                    id: v.id,
                    type: 'INGRESO',
                    monto: v.financiera.totalCliente,
                    concepto: `Servicio a ${v.nombreCliente} (T√©cnico: ${v.tecnico})`,
                    date: v.attendedDate ? v.attendedDate.split('T')[0] : 'N/A',
                    timestamp: v.attendedDate ? new Date(v.attendedDate).getTime() : v.createdAt
                }));

            // 2. Recolectar Egresos
            let filteredEgresos = egresosArray
                .filter(e => e.timestamp >= startTimestamp && e.timestamp <= endTimestamp)
                .map(e => ({
                    id: e.id,
                    type: 'EGRESO',
                    monto: e.monto,
                    concepto: e.concepto,
                    date: e.date.split('T')[0],
                    timestamp: e.timestamp
                }));

            // 3. Consolidar, calcular totales y renderizar
            const allMovimientos = [...filteredIngresos, ...filteredEgresos];
            allMovimientos.sort((a, b) => b.timestamp - a.timestamp); 

            let totalIngresos = filteredIngresos.reduce((sum, mov) => sum + mov.monto, 0);
            let totalEgresos = filteredEgresos.reduce((sum, mov) => sum + mov.monto, 0);
            let balance = totalIngresos - totalEgresos;

            document.getElementById('totalIngresosDisplay').textContent = `$${totalIngresos.toFixed(2)}`;
            document.getElementById('totalEgresosDisplay').textContent = `$${totalEgresos.toFixed(2)}`;
            document.getElementById('balanceDisplay').textContent = `$${balance.toFixed(2)}`;
            document.getElementById('balanceDisplay').className = `text-xl font-bold ${balance >= 0 ? 'text-fix-report' : 'text-fix-error'}`;

            renderContabilidadTable(allMovimientos);
        };

        function renderContabilidadTable(movimientos) {
            const tbody = document.getElementById('contabilidadTableBody');
            if (!tbody) return;

            if (movimientos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay movimientos en el rango de fechas seleccionado.</td></tr>';
                return;
            }

            tbody.innerHTML = movimientos.map(mov => {
                const date = new Date(mov.timestamp).toLocaleDateString();
                const color = mov.type === 'INGRESO' ? 'text-fix-report' : 'text-fix-accent';
                const sign = mov.type === 'INGRESO' ? '+' : '-';

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-900">${date}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium ${color}">${mov.type}</td>
                        <td class="px-3 py-3 text-sm text-gray-500">${mov.concepto}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-right text-sm font-bold ${color}">${sign} $${mov.monto.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // --- RENDERING DE LA LISTA DE VISITAS ---
        function renderVisits(visits) {
            const listContainer = document.getElementById('visitsList');
            if (!listContainer) return; 

            if (visits.length === 0) {
                listContainer.innerHTML = `<p class="text-gray-500 p-4 italic">No hay visitas agendadas para la fecha seleccionada.</p>`;
                return;
            }

            listContainer.innerHTML = visits.map(visit => {
                const total = (visit.financiera && visit.financiera.totalCliente) ? visit.financiera.totalCliente.toFixed(2) : '0.00';
                let estadoColor = 'bg-blue-100 text-blue-800';
                if (visit.estado === 'PENDIENTE') estadoColor = 'bg-fix-accent/70 text-white';
                if (visit.estado === 'Atendido') estadoColor = 'bg-fix-report text-white';
                if (visit.estado === 'No Atendido') estadoColor = 'bg-fix-error text-white';
                if (visit.estado === 'Novedad') estadoColor = 'bg-yellow-500 text-white';


                let controls = '';
                if (currentView === 'my_agenda' || currentView === 'reporte_admin') {
                    controls = `
                        <div class="mt-4 pt-4 border-t border-fix-light/30">
                            <h4 class="text-base font-semibold text-fix-blue mb-2">GESTI√ìN EN CAMPO:</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <select 
                                    class="block w-full rounded-md border-gray-300 focus:ring-fix-light focus:border-fix-light p-2 text-sm"
                                    onchange="changeVisitQuickStatus(this, '${visit.id}')"
                                >
                                    <option value="" disabled selected>Estado: ${visit.estado}</option>
                                    <option value="Atendido">‚úÖ Atendido</option>
                                    <option value="No Atendido">‚ùå No Atendido</option>
                                    <option value="Novedad">‚ö†Ô∏è Novedad / Pendiente</option>
                                </select>
                                <button onclick="openEditModal('${visit.id}')" class="bg-fix-report hover:bg-fix-blue text-white text-sm font-semibold py-2 px-4 rounded-md transition duration-200" ${visit.estado === 'Atendido' ? '' : ''}>
                                    Registrar Cobro/Accesorios
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Cobro Actual: $${total}</p>
                        </div>
                    `;
                }

                return `
                    <div class="bg-white p-4 rounded-xl shadow-md transition-all mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-bold text-fix-blue">${visit.nombreCliente || 'Sin Nombre'}</h3>
                            <span class="text-sm font-semibold px-3 py-1 rounded-full ${estadoColor}">${visit.estado}</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1"><strong>T√©cnico:</strong> ${visit.tecnico || 'N/A'}</p>
                        <p class="text-sm text-gray-700 mb-1"><strong>Tipo:</strong> ${visit.tipoAtencion || 'N/A'} (${visit.numEquipos || 1} equipos)</p>
                        <p class="text-sm text-gray-700 mb-1"><strong>Direcci√≥n:</strong> ${visit.direccion || 'N/A'}</p>
                        <p class="text-sm text-gray-700 font-bold mt-2">
                            <strong class="text-fix-accent">Cobro Estimado:</strong> $${total}
                        </p>
                        ${controls}
                    </div>
                `;
            }).join('');
        }

        // --- FUNCIONES DE FILTROS DE VISTA ---
        window.filterVisitsByDate = () => {
            filterDate = document.getElementById('filterDateInput').value;
            setupVisitListener();
        };
        
        window.filterVisitsByTecnico = () => {
            filterTecnico = document.getElementById('filterTecnicoInput').value;
            setupVisitListener();
        };
        
        window.changeView = (newView) => {
            currentView = newView;
            
            // Ocultar todos los contenedores de vista
            const formContainer = document.getElementById('formContainer');
            const filterContainer = document.getElementById('filterContainer');
            const contabilidadView = document.getElementById('contabilidadView');
            const listContainerParent = document.getElementById('listContainerParent');

            if(formContainer) formContainer.classList.add('hidden');
            if(filterContainer) filterContainer.classList.add('hidden');
            if(contabilidadView) contabilidadView.classList.add('hidden');
            if(listContainerParent) listContainerParent.classList.add('hidden'); // Oculta la lista de visitas

            // Desactivar todos los botones
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('bg-fix-blue', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });

            const btnElement = document.getElementById(`btn-${newView}`);
            if (btnElement) {
                btnElement.classList.remove('bg-gray-200', 'text-gray-700');
                btnElement.classList.add('bg-fix-blue', 'text-white');
            }

            // L√≥gica para mostrar la vista correcta
            if (newView === 'reporte_admin') {
                 if(formContainer) formContainer.classList.remove('hidden'); 
                 if(filterContainer) filterContainer.classList.remove('hidden');
                 if(listContainerParent) listContainerParent.classList.remove('hidden');
                 document.getElementById('reportViewTitle').textContent = 'Agenda y Registro';
                 setupVisitListener();
                 
            } else if (newView === 'my_agenda' || newView === 'mantenimiento') {
                 if(filterContainer) filterContainer.classList.remove('hidden');
                 if(listContainerParent) listContainerParent.classList.remove('hidden');
                 document.getElementById('reportViewTitle').textContent = newView === 'my_agenda' ? `Mi Rutero (T√©cnico: ${TECNICO_ACTUAL_DEMO})` : 'Agenda Mantenimiento';
                 setupVisitListener();
                 
            } else if (newView === 'contabilidad') {
                 if(contabilidadView) contabilidadView.classList.remove('hidden');
                 loadContabilidadData();
                 
            } 
        };

        // --- FUNCIONES DE L√ìGICA M√çNIMA (Faltantes) ---
        window.deleteVisitLocal = () => { showMessage("Funcionalidad de borrado pendiente.", 'fix-accent'); };
        window.exportToCsv = () => { showMessage("Funcionalidad de exportaci√≥n pendiente.", 'fix-accent'); };
        window.autofillProduct = () => { /* l√≥gica de autocompletado */ };
        window.addCustomAccessory = () => { showMessage("Funcionalidad de agregar accesorios personalizada pendiente.", 'fix-accent'); };
        window.removeAccessory = () => { /* l√≥gica de accesorios */ };
        window.printRoute = () => { window.print(); };
        
        // üö® FUNCI√ìN PRINCIPAL DE INICIO
        document.addEventListener('DOMContentLoaded', () => {
             renderAccessoryInputs(); 
             handleEquipmentCountChange();
             cargarDatos();
             loadContabilidadData();
        });
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans" onload="handleEquipmentCountChange()">

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <header class="mb-8 pb-4 flex flex-col md:flex-row items-start md:items-center justify-between">
            <div class="flex items-center mb-4 md:mb-0">
                <img src="https://placehold.co/100x40/1e3a8a/ffffff?text=FIX" alt="Logo de FIX" class="h-10 w-auto mr-4 rounded-lg shadow-md">
                <div>
                    <h1 class="text-3xl font-extrabold text-fix-blue">FIX - Sistema de Gesti√≥n</h1>
                    <p class="text-gray-600">Registro de Atenciones a Domicilio (Teka)</p>
                </div>
            </div>
        </header>

        <div class="mb-6 p-3 bg-white rounded-xl shadow-md flex flex-wrap gap-2 justify-center no-print">
             <button id="btn-reporte_admin" onclick="changeView('reporte_admin')" class="view-btn bg-fix-blue text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                 Agenda y Registro
             </button>
             <button id="btn-my_agenda" onclick="changeView('my_agenda')" class="view-btn bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                 Mi Rutero
             </button>
             <button id="btn-contabilidad" onclick="changeView('contabilidad')" class="view-btn bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                 üí∞ Contabilidad
             </button>
             <button id="btn-mantenimiento" onclick="changeView('mantenimiento')" class="view-btn bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                 Mantenimiento
             </button>
             <button onclick="exportToCsv()" class="bg-fix-report hover:bg-fix-blue text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01] mt-2 w-full md:w-auto">
                 EXPORTAR REPORTE CSV
             </button>
        </div>
        
        <div id="filterContainer" class="mb-6 p-3 bg-white rounded-xl shadow-md border border-fix-report/30 no-print">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Control de Agenda (Reporte)</h3>
            <div class="flex flex-col sm:flex-row gap-3 items-center">
                 <label class="flex-grow w-full sm:w-auto">
                    <span class="text-sm text-gray-700">Filtrar por Fecha de Visita:</span>
                    <input type="date" id="filterDateInput" onchange="filterVisitsByDate()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fix-light focus:ring-fix-light p-2">
                 </label>
                 
                 <label class="flex-grow w-full sm:w-auto">
                    <span class="text-sm text-gray-700">Filtrar por T√©cnico:</span>
                    <select id="filterTecnicoInput" onchange="filterVisitsByTecnico()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-fix-light focus:ring-fix-light p-2">
                         </select>
                 </label>

                 <button onclick="filterDate=null; filterTecnico=''; document.getElementById('filterDateInput').value=''; document.getElementById('filterTecnicoInput').value=''; setupVisitListener();" class="mt-4 sm:mt-0 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">
                    Mostrar Todas
                 </button>
            </div>
        </div>
        
        <div id="contabilidadView" class="hidden">
            <div class="mb-6 p-4 bg-white rounded-xl shadow-md border border-fix-blue/30">
                <h3 class="text-2xl font-bold text-fix-blue mb-4">M√≥dulo de Contabilidad</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 bg-fix-blue text-white p-4 rounded-lg shadow-lg">
                        <h4 class="text-lg font-semibold border-b border-fix-light pb-2 mb-3">RESUMEN DEL PERIODO</h4>
                        <div class="space-y-2">
                            <p class="flex justify-between font-medium"><span>Ingresos Totales (Atenciones):</span> <span id="totalIngresosDisplay" class="font-bold text-lg text-fix-report">$0.00</span></p>
                            <p class="flex justify-between font-medium"><span>Egresos Registrados:</span> <span id="totalEgresosDisplay" class="font-bold text-lg text-fix-accent">$0.00</span></p>
                            <div class="h-px bg-fix-light my-3"></div>
                            <p class="flex justify-between text-xl font-bold"><span>BALANCE:</span> <span id="balanceDisplay" class="text-fix-light">$0.00</span></p>
                        </div>
                    </div>

                    <div class="md:col-span-1 bg-gray-100 p-4 rounded-lg shadow-md border border-gray-300">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Filtrar Movimientos</h4>
                        <label class="block mb-2">
                            <span class="text-sm text-gray-700">Fecha de Inicio:</span>
                            <input type="date" id="contabilidadStartDate" onchange="filterContabilidad()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </label>
                        <label class="block">
                            <span class="text-sm text-gray-700">Fecha de Fin:</span>
                            <input type="date" id="contabilidadEndDate" onchange="filterContabilidad()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </label>
                    </div>

                    <div class="md:col-span-1 bg-gray-100 p-4 rounded-lg shadow-md border border-gray-300">
                        <h4 class="text-lg font-semibold text-gray-800 mb-3">Registrar Nuevo Egreso</h4>
                        <form id="egresoForm" onsubmit="event.preventDefault(); saveEgreso();">
                            <label class="block mb-2">
                                <span class="text-sm text-gray-700">Monto ($)*:</span>
                                <input type="number" step="0.01" min="0.01" name="montoEgreso" required class="mt-1 block w-full rounded-md shadow-sm p-2 text-base currency-input">
                            </label>
                            <label class="block mb-4">
                                <span class="text-sm text-gray-700">Concepto/Descripci√≥n*:</span>
                                <textarea name="conceptoEgreso" required rows="2" class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm"></textarea>
                            </label>
                            <button type="submit" class="w-full bg-fix-accent hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                                REGISTRAR EGRESO
                            </button>
                        </form>
                    </div>
                </div>

            </div>

            <div class="mb-6 p-4 bg-white rounded-xl shadow-md border border-gray-200">
                <h4 class="text-xl font-semibold text-gray-800 mb-3">Detalle de Movimientos</h4>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                                <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Monto ($)</th>
                            </tr>
                        </thead>
                        <tbody id="contabilidadTableBody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="text-center py-4 text-gray-500">Cargando movimientos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div id="messageBox" class="p-3 rounded-lg text-white mb-4 opacity-0 transition-opacity duration-300 no-print"></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div id="formContainer" class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl border border-gray-200 h-fit no-print">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Registrar Nueva Visita</h2>
                
                <form id="visitForm" onsubmit="event.preventDefault(); saveVisit();">
                    
                    <div class="mb-6 p-4 border border-fix-blue/30 rounded-lg bg-fix-blue/5">
                        <h3 class="text-xl font-medium mb-4 text-fix-blue">1. Cliente y Agenda</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <label class="block"><span class="text-gray-700 font-medium">Nombre Completo del Cliente*</span><input type="text" name="nombreCliente" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></label>
                            <label class="block"><span class="text-gray-700 font-medium">C√©dula o RUC</span><input type="text" name="cedula" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></label>
                            <label class="block md:col-span-2"><span class="text-gray-700 font-medium">Direcci√≥n de Instalaci√≥n/Servicio*</span><input type="text" name="direccion" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></label>
                            <label class="block"><span class="text-gray-700 font-medium">Tel√©fono / Celular</span><input type="tel" name="telefono" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></label>
                            <label class="block"><span class="text-gray-700 font-medium">Correo Electr√≥nico</span><input type="email" name="correo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></label>
                            
                            <label class="block">
                                <span class="text-gray-700 font-medium">Tipo de Atenci√≥n*</span>
                                <select name="tipoAtencion" onchange="handleEquipmentCountChange()" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                    <option value="" disabled selected>--- Seleccionar Tipo ---</option>
                                    <option value="Garantia">Garant√≠a</option>
                                    <option value="Instalacion">Instalaci√≥n</option>
                                    <option value="Visita Tecnica">Visita T√©cnica</option>
                                    <option value="Recepcion Equipo">Recepci√≥n de Equipo</option>
                                </select>
                            </label>

                            <label class="block"><span class="text-gray-700 font-medium">Fecha de Instalaci√≥n/Intervenci√≥n*</span><input type="date" name="fechaInstalacion" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></label>
                            <label class="block"><span class="text-gray-700 font-medium">T√©cnico Asignado (Opcional)</span><select name="tecnico" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select></label>
                        </div>
                    </div>

                    <div class="mb-6 p-4 border border-gray-400/30 rounded-lg bg-gray-50">
                        <h3 class="text-xl font-medium mb-4 text-gray-800">2. Producto y Servicio</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            
                            <label class="block"><span class="text-gray-700">Fecha de Compra</span><input type="date" name="fechaCompra" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></label>
                            <label class="block"><span class="text-gray-700">Lugar de Compra</span><select name="lugarCompra" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></select></label>
                            <label class="block"><span class="text-gray-700">N√∫mero de Factura de Compra</span><input type="text" name="numFactura" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2"></label>

                            <label class="block">
                                <span id="numEquiposLabel" class="text-gray-700 font-medium">Cantidad de Equipos a Instalar*</span>
                                <input type="number" id="numEquipos" name="numEquipos" min="1" value="1" oninput="updateInstallationCost(); handleEquipmentCountChange();" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </label>
                            <label class="block md:col-span-2">
                                <span class="text-gray-700">Tipo de Servicio Principal (Solo para costeo)*</span>
                                <select name="tipoServicio" onchange="updateInstallationCost()" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                </select>
                            </label>
                        </div>

                        <div id="productInputsContainer">
                            </div>

                    </div>

                    <div class="mb-6 p-4 border border-fix-accent/30 rounded-lg bg-fix-accent/5">
                        <h3 class="text-xl font-medium mb-4 text-fix-accent">3. Aspectos Financieros y Accesorios</h3>
                        
                        <div class="grid grid-cols-5 gap-2 text-xs font-bold text-gray-600 mb-2 border-b pb-1">
                            <span class="col-span-2">Accesorio</span>
                            <span class="text-center">Cant.</span>
                            <span class="text-right">Precio ($)</span>
                            <span class="text-right"></span>
                        </div>

                        <div id="accesoriosContainer" class="p-2 border border-gray-300 rounded-b-md mb-4 bg-gray-50">
                            </div>
                        
                        <div class="flex justify-between mt-3 pt-2 border-t text-sm font-bold">
                            <span>Subtotal Accesorios:</span>
                            <span id="totalAccesoriosDisplay" class="text-fix-accent">$0.00</span>
                        </div>

                        <div class="p-3 bg-fix-accent/20 rounded-lg shadow text-center mt-4">
                            <span class="text-sm font-normal text-fix-blue">TOTAL COBRO ESTIMADO</span>
                            <div id="totalClienteDisplay" class="text-fix-accent text-2xl">$25.00</div>
                            <input type="hidden" id="costoInstalacionHidden" name="costoInstalacionHidden" value="25.00">
                            <input type="hidden" id="cobroAccesoriosHidden" name="cobroAccesoriosHidden" value="0.00">
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <button type="submit" class="w-full bg-fix-blue hover:bg-fix-light text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-[1.01]">
                            Guardar Visita en Agenda
                        </button>
                    </div>
                </form>
            </div>
            
            <div id="listContainerParent" class="lg:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h2 id="reportViewTitle" class="text-2xl font-semibold mb-6 text-gray-800 border-b pb-2">Agenda de Rutas Diarias</h2>
                    
                    <div id="visitsList" class="max-h-[80vh] overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            Cargando agenda...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 invisible opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-y-auto max-h-[90vh]">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-xl font-bold text-fix-blue">‚úÖ Registro de Servicio Completado</h3>
                <button type="button" onclick="closeEditModal()" class="text-gray-500 hover:text-gray-900 font-bold text-2xl">&times;</button>
            </div>
            
            <form id="editVisitForm" class="p-6" onsubmit="event.preventDefault(); saveTechnicianReport()">
                <input type="hidden" id="modalVisitId" name="visitId">
                <input type="hidden" id="modalCurrentStatus" name="currentStatus">

                <div class="mb-4">
                    <p class="text-sm font-semibold text-gray-700">Cliente:</p>
                    <h4 id="modalClientName" class="text-lg font-bold text-fix-accent mb-2"></h4>
                </div>

                <div class="mb-6 p-3 border border-fix-accent/30 rounded-lg bg-fix-accent/5">
                    <h4 class="text-base font-medium mb-3 text-fix-accent">Accesorios y Repuestos</h4>
                    
                    <div class="grid grid-cols-5 gap-2 text-xs font-bold text-gray-600 mb-2 border-b pb-1">
                        <span class="col-span-2">Accesorio</span>
                        <span class="text-center">Cant.</span>
                        <span class="text-right">Precio ($)</span>
                        <span class="text-right"></span>
                    </div>
                    
                    <div id="modalAccesoriosContainer">
                        </div>
                    
                    <div class="flex justify-between mt-3 pt-2 border-t text-sm font-bold">
                        <span>Subtotal Accesorios:</span>
                        <span id="modalTotalAccesoriosDisplay" class="text-fix-accent">$0.00</span>
                        <input type="hidden" id="modalCobroAccesoriosHidden" name="cobroAccesoriosHidden">
                    </div>
                </div>

                <div class="mb-6 p-3 border border-fix-blue/30 rounded-lg bg-fix-blue/5">
                    <h4 class="text-base font-medium mb-3 text-fix-blue">Cobro y Observaciones del Servicio</h4>
                    
                    <label class="block mb-3">
                        <span class="text-sm text-gray-700 font-medium">Costo Base de Instalaci√≥n/Servicio:</span>
                        <input type="number" step="0.01" id="modalCostoInstalacion" name="costoInstalacion" readonly class="mt-1 block w-full rounded-md shadow-sm p-2 text-sm bg-gray-100 font-bold currency-input">
                        <input type="hidden" id="modalCostoInstalacionHidden" name="costoInstalacionHidden">
                    </label>

                    <label class="block mb-3">
                        <span class="text-sm text-gray-700 font-medium">MONTO TOTAL COBRADO AL CLIENTE (Incluye Accesorios):</span>
                        <input type="number" step="0.01" id="modalTotalCobro" name="totalCobro" required class="mt-1 block w-full rounded-md shadow-sm p-2 text-lg border-fix-accent ring-fix-accent font-bold text-fix-blue currency-input">
                    </label>

                    <label class="block">
                        <span class="text-sm text-gray-700 font-medium">Observaciones Finales (Requerido):</span>
                        <textarea id="modalObservaciones" name="observaciones" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 text-sm"></textarea>
                    </label>
                </div>

                <button type="submit" class="w-full bg-fix-report hover:bg-fix-blue text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-300">
                    FINALIZAR SERVICIO Y GUARDAR REPORTE
                </button>
            </form>
        </div>
    </div>
    </body>
</html>
